<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portál pro procvičování na maturitu z matematiky</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
            line-height: 1.4;
        }

        /* Progress Bar Styling */
        #progressBar {
            position: fixed;
            top: 0;
            left: 0;
            height: 5px; /* Výška progress baru */
            background-color: #1565c0; /* Tmavší odstín modré */
            width: 0%; /* Počáteční šířka */
            z-index: 10000; /* Zajistí, že bude nad všemi ostatními prvky */
            transition: width 0.1s ease-out, opacity 0.3s ease-in-out; /* Plynulá animace šířky a průhlednosti */
            opacity: 0; /* Skryto na začátku */
        }

        header {
            background-color: #1e88e5;
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            flex-wrap: wrap;
            gap: 1rem;
            /* Přidáme padding-top, aby header nebyl pod progress barem */
            padding-top: calc(1rem + 5px); /* 1rem + výška progress baru */
            position: relative; /* Needed for projection button to be positioned relative to it */
        }

        .logo-link { /* New style for logo link */
            display: flex;
            align-items: center;
            flex-shrink: 0;
            text-decoration: none;
        }

        .logo {
            max-width: 60px;
            height: auto;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            flex-grow: 1;
            font-size: 1.5rem;
            min-width: 200px;
        }

        .search-link {
            color: white;
            text-decoration: none;
            background-color: #1565c0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            white-space: nowrap;
            font-size: 0.9rem;
            text-align: center;
            min-width: 160px;
            min-height: 48px; /* Ensure consistent height */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-link:hover {
            background-color: #0d47a1;
        }

        /* New projection button style - fixed position */
        .projection-button {
            position: fixed; /* Fixed position */
            left: 20px; /* Changed from right to left */
            z-index: 10001; /* Above everything else except fullscreen arrows/counter */
            background-color: #607d8b; /* Opaque grey */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem; /* Match search-link padding */
            font-size: 0.9rem; /* Match search-link font size */
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px; /* Ensure good touch target */
            min-height: 48px; /* Match search-link height */
        }

        .projection-button:hover {
            background-color: #455a64;
        }

        /* New fullscreen exit button style */
        #exitFullscreenButton {
            position: fixed;
            top: 1rem; /* Fixed to top-right */
            right: 1rem; /* Fixed to top-right */
            left: auto; /* Reset left */
            z-index: 10003; /* Above projection button and other fullscreen UI */
            background-color: #ef5350; /* Softer red (Material Design Red 400) */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 0.75rem; /* Smaller padding */
            font-size: 0.8rem; /* Smaller font size */
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            min-width: 32px; /* Smaller min-width */
            min-height: 32px; /* Smaller min-height */
            opacity: 0.6; /* Partially transparent */
        }

        #exitFullscreenButton:hover {
            background-color: #e53935; /* Darker red on hover */
            opacity: 1; /* Fully opaque on hover */
        }


        .container {
            max-width: 900px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .filters-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .select-group {
            margin-bottom: 1.5rem;
        }

        .select-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        select {
            width: 100%;
            font-size: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            outline: none;
            background-color: white;
            transition: border-color 0.2s ease;
        }

        select:focus {
            border-color: #1e88e5;
        }

        #problemCount {
            font-weight: 600;
            color: #1e88e5;
            font-size: 1.1rem;
            margin: 1rem 0;
            text-align: center;
            padding: 0.5rem;
            background-color: #e3f2fd;
            border-radius: 8px;
        }

        .toggle-advanced-filters,
        .go-to-problems-button { /* Combined styles for similar buttons */
            display: block;
            width: 100%;
            padding: 0.75rem 1.5rem;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            margin-bottom: 1rem;
            min-height: 48px;
        }

        .toggle-advanced-filters {
            background-color: #607d8b; /* Barva pro "Více" tlačítko */
        }

        .toggle-advanced-filters:hover {
            background-color: #455a64;
        }

        .go-to-problems-button {
            background-color: #4CAF50; /* Zelená barva pro "Přejít na výpis příkladů" */
        }

        .go-to-problems-button:hover {
            background-color: #45a049;
        }

        #advancedFilters {
            display: none; /* Skryto ve výchozím stavu */
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .range-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .range-input {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
        }

        .range-input label {
            font-weight: 500;
            white-space: nowrap;
        }

        .range-input input {
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            outline: none;
            width: 80px;
            text-align: center;
            font-size: 1rem;
        }

        .range-input input:focus {
            border-color: #1e88e5;
        }

        .range-input button,
        .clear-filter {
            padding: 0.75rem 1.5rem;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            min-height: 48px;
        }

        .range-input button:hover,
        .clear-filter:hover {
            background-color: #1565c0;
        }

        .clear-filter {
            background-color: #e53935;
            width: 100%;
            margin-top: 1rem;
        }

        .clear-filter:hover {
            background-color: #c62828;
        }

        .problem {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            padding: 1.5rem;
            text-align: center;
            position: relative; /* Needed for fullscreen positioning */
            display: block; /* Ensure it's a block element */
        }

        /* Ensure images fit within their container */
        .problem img {
            max-width: 100%;
            height: auto;
            display: block; /* Prevents extra space below image */
            margin: 0 auto; /* Center image */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Styles for fullscreen problem */
        .problem.fullscreen-active {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: auto; /* Allow scrolling within the problem */
            z-index: 9999; /* Ensure it's on top */
            background: white;
            padding: 1rem;
            border-radius: 0; /* No rounded corners in fullscreen */
            box-shadow: none; /* No shadow in fullscreen */
            margin-bottom: 0;
            display: grid; /* Change to grid */
            grid-template-columns: 1fr; /* Single column for content */
            grid-template-rows: auto 1fr; /* Header content then image */
            align-items: start; /* Align items to the top */
            gap: 1rem; /* Space between rows */
        }

        .problem.fullscreen-active img {
            grid-column: 1; /* Place in the first column */
            grid-row: 2; /* Place in the second row */
            width: auto; /* Render at natural width */
            height: auto; /* Render at natural height */
            margin: 0 auto; /* Center image horizontally */
            touch-action: pan-x pan-y pinch-zoom; /* Enable pinch-zoom and panning */
            cursor: grab; /* Indicate draggable/zoomable */
        }

        .problem-header-content { /* Wrapper for button and info */
            display: flex;
            flex-direction: column; /* Stack items vertically */
            align-items: flex-start; /* Align to start */
            width: 100%; /* Take full width */
            margin-bottom: 0; /* No margin below in fullscreen */
            gap: 0.5rem; /* Smaller gap */
            grid-column: 1; /* Place in the first column */
            grid-row: 1; /* Place in the first row */
            padding-top: 1rem; /* Initial padding, adjusted by exit button */
        }

        .problem-info-text { /* Wrapper for problem number/ID */
            text-align: left; /* Default alignment */
            flex-grow: 0; /* Don't grow, let it wrap */
            width: 100%; /* Take full width of its parent flex item */
            order: 1; /* Place at the top */
        }

        .problem.fullscreen-active .problem-number,
        .problem.fullscreen-active .problem-id {
            text-align: left; /* Align text to the left in fullscreen header */
            margin: 0; /* Remove default margins */
        }

        .problem.fullscreen-active .show-solution {
            order: 2; /* Place below problem-info-text */
            position: static; /* Reset position from absolute */
            margin-top: 0; /* Remove default margin-top */
            width: auto; /* Allow button to size naturally */
            max-width: none; /* Remove max-width constraint */
            align-self: flex-start; /* Align to the start of the cross axis */
            flex-shrink: 0; /* Prevent shrinking */
            padding: 0.75rem 1rem; /* Adjust padding for smaller button in fullscreen header */
            font-size: 0.9rem; /* Adjust font size */
            min-height: 40px; /* Smaller min-height */
        }

        /* Class to hide problems when one is in fullscreen */
        .problem.hidden-for-fullscreen {
            display: none !important;
        }

        .problem-number {
            font-weight: bold;
            font-size: 1.3rem;
            color: #1e88e5;
            text-align: left;
            margin-bottom: 0.5rem;
        }

        .problem-id {
            font-size: 0.9rem;
            color: #666;
            text-align: left;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .show-solution {
            display: inline-block;
            margin-top: 0; /* Remove default margin for normal mode, handled by flexbox */
            padding: 1rem 2rem;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            min-height: 48px;
            width: 100%;
            max-width: 300px;
        }

        .show-solution:hover {
            background-color: #1565c0;
        }

        /* Styles for locked solution button */
        .problem.fullscreen-active .show-solution.locked {
            background-color: #9e9e9e; /* Greyed out */
            cursor: not-allowed;
            opacity: 0.7;
            position: relative; /* For lock icon positioning */
            padding-left: 2.5rem; /* Make space for the lock icon */
        }
        .problem.fullscreen-active .show-solution.locked::before {
            content: '\1F512'; /* Unicode lock icon */
            position: absolute;
            left: 0.75rem; /* Adjust position */
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }
        .problem.fullscreen-active .show-solution.locked:hover {
            background-color: #9e9e9e; /* No change on hover when locked */
        }


        .overlay {
            display: none;
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%); /* Adjust for its own size */
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 10004; /* Higher than fullscreen UI */
            padding: 1rem;
            max-width: 90vw; /* Limit width */
            max-height: 90vh; /* Limit height */
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: default; /* Default cursor for the whole overlay */
            transition: all 0.2s ease; /* Add transition for smooth movement when not dragging */
        }

        .overlay-content {
            background: white;
            border-radius: 10px;
            padding: 0;
            max-width: 100%; /* Fill overlay container */
            max-height: 100%; /* Fill overlay container */
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            cursor: grab; /* Cursor for draggable header */
        }

        .overlay-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.1rem;
            flex-grow: 1;
            text-align: center;
            white-space: nowrap; /* Ensure text stays on one line */
            overflow: hidden; /* Hide overflowing content */
            text-overflow: ellipsis; /* Show ellipsis for truncated text */
            padding: 0 10px; /* Add horizontal padding to prevent overlap with close button */
            font-weight: normal; /* Make the default text in h3 not bold */
        }

        .overlay-header h3 .problem-index-bold { /* New style for the bold part */
            font-weight: bold;
        }

        .close-btn {
            cursor: pointer;
            color: #666;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #e0e0e0;
            font-size: 1.5rem;
            transition: all 0.2s ease;
            border: none;
            flex-shrink: 0;
        }

        .close-btn:hover {
            color: #e53935;
            background-color: #ffebee;
            transform: scale(1.1);
        }

        .overlay-image-container {
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            overflow: auto;
        }

        .overlay-content img {
            max-width: 100%;
            max-height: calc(90vh - 120px); /* Adjusted for header and padding */
            object-fit: contain;
            border-radius: 8px;
        }

        /* New styles for overlay navigation arrows */
        .overlay-nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001; /* Above overlay content */
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .overlay-nav-arrow:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.7);
            transform: translateY(-50%) scale(1.1);
        }

        .overlay-nav-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .overlay-nav-arrow.left {
            left: 10px;
        }

        .overlay-nav-arrow.right {
            right: 10px;
        }


        /* Checkbox group styling */
        .checkbox-group {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            flex-shrink: 0;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }

        /* ID Search Group Styling */
        .id-search-group {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
        }

        .id-search-group label {
            flex-basis: 100%; /* Label takes full width */
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .id-search-group .input-wrapper { /* New wrapper for input and clear button */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }

        .id-search-group input[type="text"] {
            flex-grow: 0; /* Prevent input from growing */
            max-width: 180px; /* Limit width to approximately one-third of 900px container / 2 (for mobile) */
            width: 100%; /* Ensure it takes full width up to max-width */
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.2s ease, color 0.2s ease;
        }

        .id-search-group input[type="text"]:focus {
            border-color: #1e88e5;
        }

        /* New styles for ID input validation feedback */
        .id-search-group input[type="text"].valid-id {
            border-color: #4CAF50;
            font-weight: bold;
            color: #4CAF50;
        }
        .id-search-group input[type="text"].invalid-id {
            border-color: #e53935;
            font-weight: bold;
            color: #e53935;
        }

        /* New style for the clear ID input button */
        .clear-id-input-button {
            background-color: #e53935; /* Explicitly red */
            color: white;
            border: none;
            border-radius: 8px; /* Match other buttons */
            width: 48px; /* Square button */
            height: 48px; /* Square button */
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .clear-id-input-button:hover {
            background-color: #c62828;
        }

        /* New style for ID help text */
        .id-help-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
            flex-basis: 100%;
        }
        .id-help-text.error {
            color: #e53935;
            font-weight: bold;
        }

        .id-search-group button { /* This targets the "Zobrazit" button */
            padding: 0.75rem 1.5rem;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
            min-height: 48px;
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        .id-search-group button:hover {
            background-color: #1565c0;
        }

        /* New style for the fullscreen navigation arrows */
        .fullscreen-nav-arrow {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem; /* Large arrow */
            color: #9e9e9e; /* Gray color */
            cursor: pointer;
            z-index: 10002; /* Above progress bar and overlay */
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease; /* Smooth fade */
            padding: 10px 20px; /* Make it easier to click */
            background-color: rgba(255, 255, 255, 0.1); /* Slightly visible background */
            border-radius: 10px;
            opacity: 1; /* Start visible, then fade */
        }

        .fullscreen-nav-arrow:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.7);
            transform: translateX(-50%) scale(1.1);
        }

        .fullscreen-nav-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #prevProblemArrow {
            top: 20px; /* Distance from top */
        }

        #nextProblemArrow {
            bottom: 20px; /* Distance from bottom */
        }

        /* New style for the fullscreen problem counter */
        #fullscreenProblemCounter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 1.8rem; /* Larger font */
            color: #9e9e9e; /* Grey color */
            background-color: rgba(255, 255, 255, 0.1); /* Slightly visible background */
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 10002; /* Above progress bar and overlay */
            display: none; /* Hidden by default */
            pointer-events: none; /* Ensure it doesn't block clicks */
            user-select: none; /* Prevent text selection */
            transition: opacity 0.3s ease;
        }

        /* Fullscreen Timer */
        #fullscreenTimer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10002; /* Same as arrows */
            font-size: 1.8rem;
            color: #9e9e9e;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            display: none; /* Hidden by default */
            user-select: none;
            transition: opacity 0.3s ease;
            opacity: 1; /* Start visible */
        }
        #fullscreenTimer.hidden {
            opacity: 0;
        }

        /* Timer Controls */
        #fullscreenTimerControls {
            position: fixed;
            bottom: 20px;
            left: 150px; /* Adjusted based on timer width + gap */
            z-index: 10002;
            display: none; /* Hidden by default */
            opacity: 1;
            transition: opacity 0.3s ease;
            display: flex; /* Use flex to align buttons */
            gap: 10px; /* Space between buttons */
        }
        #fullscreenTimerControls.hidden {
            opacity: 0;
        }
        .timer-control-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #9e9e9e;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            min-width: 48px; /* Ensure good touch target */
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .timer-control-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(1.05);
        }


        /* Fullscreen Alert Overlay */
        #fullscreenAlertOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            color: #e0e0e0; /* Grayish white */
            font-size: 3rem;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10005; /* Above everything else */
            pointer-events: none; /* Allow clicks to pass through by default */
        }
        #fullscreenAlertOverlay.active {
            pointer-events: auto; /* Block clicks when active */
        }

        /* NEW: Developer Mode Styles */
        .category-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            justify-content: center; /* Center checkboxes horizontally */
        }

        .category-checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background-color: #e3f2fd;
            padding: 0.5rem 0.75rem;
            border-radius: 5px;
            font-size: 0.85rem;
            white-space: normal; /* CHANGED: Allow text to wrap */
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .category-checkbox-label:hover {
            background-color: #bbdefb;
        }

        .category-checkbox-input {
            width: 16px;
            height: 16px;
            margin: 0;
            flex-shrink: 0;
            cursor: pointer;
        }

        .category-summary-output {
            background: #263238; /* Darker background for code-like output */
            color: #e0e0e0; /* Light text */
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-top: 2rem;
            padding: 1.5rem;
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace; /* Monospace font */
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve whitespace and wrap */
            word-break: break-word; /* Break long words */
            position: relative;
        }

        .category-summary-output h3 {
            color: #90a4ae; /* Lighter grey for heading */
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-align: center;
        }

        .category-summary-output pre {
            margin: 0;
            padding: 0;
            user-select: text; /* Allow text selection */
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .copy-feedback {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allow clicks to pass through */
        }


        /* Mobilní optimalizace */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                padding: 1rem 0.5rem;
                padding-top: calc(1rem + 5px); /* Adjust for progress bar */
            }

            .logo {
                max-width: 100px;
                order: -1;
            }

            h1 {
                font-size: 1.2rem;
                margin: 0.5rem 0;
                min-width: auto;
            }

            .search-link {
                width: 100%;
                max-width: 280px;
                margin-top: 0.5rem;
            }

            /* Adjust fixed projection button for mobile */
            .projection-button {
                left: 10px; /* Adjusted for mobile */
                padding: 0.75rem 1rem; /* Adjusted padding for mobile */
                font-size: 1.2rem; /* Adjusted font size for mobile */
                min-width: 48px;
                min-height: 48px;
            }
            #exitFullscreenButton {
                top: 10px;
                right: 10px; /* Adjusted for mobile */
                left: auto; /* Reset left */
                padding: 0.75rem 1rem;
                font-size: 1.2rem;
                min-width: 48px;
                min-height: 48px;
            }

            .container {
                margin: 0.5rem auto;
                padding: 0 0.5rem;
            }

            .filters-section {
                padding: 1rem;
            }

            .select-group {
                margin-bottom: 1rem;
            }

            select {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .range-input {
                justify-content: center;
                text-align: center;
            }

            .range-input input {
                width: 70px;
            }

            .problem {
                padding: 1rem;
            }

            .problem-number {
                font-size: 1.2rem;
                text-align: center;
            }

            .problem-id {
                text-align: center;
                font-size: 0.85rem;
            }

            .show-solution {
                width: 100%;
                max-width: none;
                margin-left: 0;
                margin-top: 1rem; /* Separate from problem ID */
            }

            .problem.fullscreen-active {
                grid-template-columns: 1fr; /* Single column for mobile */
                grid-template-rows: auto 1fr; /* Header then image */
            }

            .problem.fullscreen-active .problem-header-content {
                position: static; /* Reset to static within grid */
                grid-column: 1;
                grid-row: 1;
                width: 100%;
                justify-content: flex-start;
                gap: 0.5rem; /* Smaller gap for mobile */
                flex-direction: column; /* Stack vertically */
                align-items: flex-start;
                padding-top: 40px; /* Space for the fixed exit button */
            }

            .problem.fullscreen-active .show-solution {
                position: static; /* Reset to static within flex container */
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-height: 36px;
            }

            .problem.fullscreen-active img {
                grid-column: 1; /* Place in the first column */
                grid-row: 2; /* Place in the second row */
            }

            .overlay {
                padding: 0.5rem;
            }

            .overlay-content {
                max-width: calc(98% - 100px); /* Adjust for smaller arrows */
                max-height: 98%;
            }

            .overlay-header {
                padding: 0.75rem;
            }

            .overlay-header h3 {
                font-size: 1rem;
                padding: 0 8px; /* Adjusted padding for mobile */
            }

            .close-btn {
                width: 36px;
                height: 36px;
                font-size: 1.3rem;
            }

            .overlay-image-container {
                padding: 0.5rem;
            }

            .overlay-content img {
                max-height: calc(90vh - 100px);
            }

            .overlay-nav-arrow {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
                top: 50%; /* Keep centered vertically */
            }
            .overlay-nav-arrow.left {
                left: 5px;
            }
            .overlay-nav-arrow.right {
                right: 5px;
            }

            .id-search-group .input-wrapper { /* Ensure wrapper takes full width */
                width: 100%;
                justify-content: space-between; /* Distribute items */
                gap: 0.5rem; /* Keep gap */
            }
            .id-search-group input[type="text"] {
                flex-grow: 1; /* Allow input to take available space */
                max-width: none; /* Remove max-width constraint */
                min-width: 120px; /* Ensure a minimum width for input */
            }
            .clear-id-input-button {
                width: 40px; /* Fixed width */
                height: 40px; /* Fixed height to make it square */
                font-size: 1.1rem; /* Slightly smaller icon */
                flex-shrink: 0; /* Prevent shrinking */
                flex-basis: 40px; /* Explicitly define base size */
            }
            .id-search-group button {
                flex-basis: 100%; /* Button takes full width on small screens */
            }

            .fullscreen-nav-arrow {
                font-size: 2.5rem;
                padding: 8px 15px;
            }
            #prevProblemArrow {
                top: 15px;
            }
            #nextProblemArrow {
                bottom: 15px;
            }

            #fullscreenProblemCounter {
                font-size: 1.4rem;
                bottom: 15px;
                right: 15px;
                padding: 8px 12px;
            }
            #fullscreenTimer {
                font-size: 1.4rem;
                bottom: 15px;
                left: 15px;
                padding: 8px 12px;
            }
            #fullscreenTimerControls {
                bottom: 15px;
                left: 120px; /* Adjust for smaller screen */
                gap: 8px;
            }
            .timer-control-btn {
                font-size: 1.2rem;
                padding: 6px 10px;
                min-width: 40px;
                min-height: 40px;
            }

            /* NEW: Developer Mode Mobile Adjustments */
            .category-checkbox-group {
                flex-direction: column; /* Stack checkboxes vertically on small screens */
                align-items: flex-start; /* Align to left */
            }
            .category-checkbox-label {
                width: 100%; /* Full width for labels */
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.1rem;
            }

            .problem-number {
                font-size: 1.1rem;
            }

            .range-input {
                flex-direction: column;
                gap: 0.75rem;
            }

            .range-input input {
                width: 100px;
            }

            .overlay-header {
                padding: 0.5rem;
            }

            .overlay-header h3 {
                padding: 0 5px; /* Further adjusted padding for smaller screens */
            }

            .close-btn {
                width: 32px;
                height: 32px;
                font-size: 1.2rem;
            }

            .overlay-nav-arrow {
                width: 35px;
                height: 35px;
                font-size: 1.3rem;
            }
            .overlay-content {
                max-width: calc(98% - 90px);
            }

            #fullscreenProblemCounter {
                font-size: 1.2rem;
                bottom: 10px;
                right: 10px;
                padding: 6px 10px;
            }
            #fullscreenTimer {
                font-size: 1.2rem;
                bottom: 10px;
                left: 10px;
                padding: 6px 10px;
            }
            #fullscreenTimerControls {
                bottom: 10px;
                left: 100px; /* Further adjust for smaller screen */
                gap: 6px;
            }
            .timer-control-btn {
                font-size: 1rem;
                padding: 5px 8px;
                min-width: 36px;
                min-height: 36px;
            }
        }

        /* Landscape mode na mobilech */
        @media (max-height: 500px) and (orientation: landscape) {
            .overlay-content img {
                max-height: calc(85vh - 80px);
            }
        }

        /* Větší touch targets pro lepší UX */
        @media (hover: none) {
            button, .search-link, select {
                min-height: 48px;
            }
        }
    </style>
</head>
<body>
<div id="progressBar"></div> <!-- Nový progress bar element -->

<header>
    <a href="index.html" class="logo-link" title="Načíst stránku znovu">
        <img src="assets/logo.png" alt="Logo" class="logo">
    </a>
    <h1>Portál pro procvičování na maturitu z matematiky</h1>
    <a href="check.html" class="search-link" target="_blank">Vyhledávání podle ID</a>
</header>

<!-- Projection button moved outside header for fixed positioning -->
<button class="projection-button" title="Zobrazit první viditelný příklad na celou obrazovku" onclick="toggleFullscreenForFirstVisibleProblem(event)">
    &#128421; <!-- Presentation chart icon -->
</button>
<!-- Fullscreen exit button -->
<button id="exitFullscreenButton" title="Ukončit režim celé obrazovky" onclick="exitFullscreen()">
    &#x2716; <!-- Heavy multiplication x icon -->
</button>

<div class="container">
    <div class="filters-section">
        <!-- Změněné pořadí: Téma je nyní před Sérem -->
        <div class="select-group">
            <label for="topic">Vyberte téma:</label>
            <select id="topic" multiple size="6" onchange="loadProblems()">
                <option value="geometrie">Geometrie 2D</option>
                <option value="posloupnosti">Posloupnosti a řady</option>
                <option value="rovnice">Rovnice</option>
                <option value="vyrazy">Výrazy</option>
            </select>
        </div>

        <div class="select-group">
            <label for="series">Vyberte sérii:</label>
            <select id="series" multiple size="6" onchange="loadProblems()">
      <option value="25p">2025 - podzim</option>
      <option value="25j">2025 - jaro</option>
      <option value="24p">2024 - podzim</option> 
      <option value="24j">2024 - jaro</option>
      <option value="23p">2023 - podzim</option> 
      <option value="23j">2023 - jaro</option>
      <option value="22p">2022 - podzim</option> 
      <option value="22j">2022 - jaro</option>
      <option value="21p">2021 - podzim</option> 
      <option value="21jm">2021 - jaro mimořádné</option>
      <option value="21j">2021 - jaro</option>
      <option value="20p">2020 - podzim</option> 
      <option value="20j">2020 - jaro</option>
      <option value="19p">2019 - podzim</option> 
      <option value="19j">2019 - jaro</option>
      <option value="18p">2018 - podzim</option> 
      <option value="18j">2018 - jaro</option>
      <option value="17p">2017 - podzim</option> 
      <option value="17j">2017 - jaro</option>
      <option value="16p">2016 - podzim</option>      
      <option value="16j">2016 - jaro</option>
      <option value="ilustr">ilustrační test</option> 
      <option value="vzor">vzorové příklady</option>
           </select>
        </div>

        <button class="go-to-problems-button" onclick="loadProblemsAndScroll()">Přejít na výpis příkladů</button>

        <div id="problemCount">Počet příkladů: 0</div>

        <button class="toggle-advanced-filters" onclick="toggleAdvancedFilters()">Více možností filtrování</button>

        <div id="advancedFilters">
            <div class="checkbox-group">
                <input type="checkbox" id="randomOrderCheckbox" onchange="loadProblems()">
                <label for="randomOrderCheckbox">Náhodné pořadí</label>
            </div>
            <!-- NEW: Developer Mode Checkbox -->
            <div class="checkbox-group">
                <input type="checkbox" id="developerModeCheckbox" onchange="toggleDeveloperMode()">
                <label for="developerModeCheckbox">Vývojářský mód</label>
            </div>
            <div class="range-section">
                <div class="range-input">
                    <label for="rangeFrom">Vybrat rozsah od:</label>
                    <input type="number" id="rangeFrom" placeholder="1" />
                    <label for="rangeTo">do:</label>
                    <input type="number" id="rangeTo" placeholder="10" />
                    <button onclick="applyRange()">Potvrdit</button>
                </div>
            </div>
            <!-- Nová sekce pro vyhledávání podle ID -->
            <div class="id-search-group">
                <label for="problemIdInput">Zobrazení příkladu s konkrétním ID:</label>
                <div class="input-wrapper">
                    <input type="text" id="problemIdInput" placeholder="např. 2023-leto/1" />
                    <button id="clearIdInputBtn" class="clear-id-input-button" title="Vyčistit ID vstup">&times;</button>
                </div>
                <div id="problemIdHelpText" class="id-help-text">Nápověda: Zadejte ID ve formátu "16j/12"</div>
                <button id="showProblemByIdBtn" onclick="showProblemById(true)">Zobrazit</button>
            </div>
            <button class="clear-filter" onclick="clearFilters()">Vyčistit filtr</button>
        </div>
    </div>

    <div id="problems"></div>

    <!-- NEW: Developer Mode Summary Output -->
    <div id="developerModeSummary" class="category-summary-output" style="display: none;">
        <h3>Souhrn kategorií příkladů:</h3>
        <pre id="categorySummaryContent"></pre>
        <button id="clearCategorySummaryBtn" class="clear-filter" style="margin-top: 1rem;">Smazat výpis</button>
        <div class="copy-feedback" id="copyFeedback">Zkopírováno do schránky!</div>
    </div>
</div>

<div class="overlay" id="overlay">
    <button class="overlay-nav-arrow left" id="prevBtn" title="Předchozí příklad">&larr;</button>
    <div class="overlay-content">
        <div class="overlay-header">
            <h3 id="overlayTitle">Řešení příkladu</h3>
            <button class="close-btn" id="closeBtn">&times;</button>
        </div>
        <div class="overlay-image-container">
            <img id="solutionImage" src="" alt="Řešení">
        </div>
    </div>
    <button class="overlay-nav-arrow right" id="nextBtn" title="Další příklad">&rarr;</button>
</div>

<div id="prevProblemArrow" class="fullscreen-nav-arrow" title="Předchozí příklad">&uarr;</div>
<div id="nextProblemArrow" class="fullscreen-nav-arrow" title="Další příklad">&darr;</div>
<div id="fullscreenProblemCounter"></div> <!-- Nový element pro počítadlo příkladů -->
<div id="fullscreenTimer"></div> <!-- Nový element pro časovač -->
<div id="fullscreenTimerControls">
    <button id="playPauseTimerBtn" class="timer-control-btn" title="Spustit/Pozastavit odpočet">&#9658;</button> <!-- Play icon -->
    <button id="resetTimerBtn" class="timer-control-btn" title="Resetovat odpočet">&#8635;</button> <!-- Reset icon -->
</div>

<script>
    const problemsCount = {
        "vzor": 127,
        "ilustr": 25,
        "16j": 25,
        "16p": 25,
        "17j": 24,
        "17p": 26,
        "18j": 23,
        "18p": 25,
        "19j": 26,
        "19p": 24,
        "20j": 25,
        "20p": 25,
        "21j": 26,
        "21jm": 25,
        "21p": 26,
        "22j": 24,
        "22p": 24,
        "23j": 23,
        "23p": 24,
        "24j": 25,
        "24p": 25,
        "25j": 24,
        "25p": 24,
    };

    const topics = {
        "geometrie": {
            "16j": [1, 3],
            "25p": [2, 3],
            "ilustr": [1]
        },
        "posloupnosti": {
            "16j": [2],
            "23p": [1],
            "24p": [2]
        },
        "rovnice": {
            "16j": [1, 2],
            "21jm": [1],
            "vzor": [1]
        },
        "vyrazy": {
            "16j": [3],
            "vzor": [2],
            "ilustr": [2]
        }
    };

    let masterProblemList = []; // Obsahuje všechny možné problémy { series, num }
    let currentDisplayedProblems = []; // Obsahuje problémy aktuálně zobrazené v problemsDiv

    let activeProblemElement = null; // To keep track of which problem is in fullscreen
    let lastScrollPosition = 0; // To store scroll position before fullscreen

    // Global variables for touch events
    let touchStartX = 0;
    let touchStartY = 0;
    const swipeThreshold = 50; // Minimum pixels for a swipe to register

    // For overlay dragging
    let isDraggingOverlay = false;
    let overlayDragOffsetX, overlayDragOffsetY;
    const overlay = document.getElementById("overlay");
    const overlayContent = document.querySelector(".overlay-content");
    const overlayHeader = document.querySelector(".overlay-header"); // Get the header for dragging

    // For fullscreen arrow and timer auto-hide
    let fullscreenUIHideTimeout;
    const UI_HIDE_DELAY = 5000; // 5 seconds

    // For fullscreen timer
    let timerInterval;
    let timerSeconds = 8100; // 135 minutes
    let timerRunning = false; // Is the timer actively counting down?
    let twoMinuteAlertShown = false;
    let finalAlertShown = false;

    const fullscreenTimerElement = document.getElementById('fullscreenTimer');
    const fullscreenAlertOverlay = document.createElement('div');
    fullscreenAlertOverlay.id = 'fullscreenAlertOverlay';
    document.body.appendChild(fullscreenAlertOverlay);

    const playPauseTimerBtn = document.getElementById('playPauseTimerBtn');
    const resetTimerBtn = document.getElementById('resetTimerBtn');
    const fullscreenTimerControls = document.getElementById('fullscreenTimerControls');

    // NEW: Developer Mode Variables
    const PROBLEM_CATEGORIES = [
        "Číselné obory",
        "Algebraické výrazy",
        "Rovnice a nerovnice",
        "Funkce",
        "Posloupnosti a finanční matematika",
        "Planimetrie",
        "Stereometrie",
        "Analytická geometrie",
        "Kombinatorika, pravděpodobnost a statistika"
    ];
    let developerModeActive = false;
    // Stores data in format: { "series/num": ["category1", "category2"], ... }
    let problemCategoryData = {};
    const LOCAL_STORAGE_KEY = 'problemCategoryData';
    const developerModeCheckbox = document.getElementById('developerModeCheckbox');
    const developerModeSummary = document.getElementById('developerModeSummary');
    const categorySummaryContent = document.getElementById('categorySummaryContent');
    const copyFeedback = document.getElementById('copyFeedback');
    const clearCategorySummaryBtn = document.getElementById('clearCategorySummaryBtn');


    // Funkce pro zamíchání pole (Fisher-Yates shuffle)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // Funkce pro vygenerování masterProblemList a naplnění datalistu
    function generateMasterProblemList() {
        const allPossibleProblems = new Set();
        // Přidáme problémy z problemsCount
        for (const seriesKey in problemsCount) {
            for (let i = 1; i <= problemsCount[seriesKey]; i++) {
                allPossibleProblems.add(JSON.stringify({ series: seriesKey, num: i }));
            }
        }
        // Přidáme problémy z topics (zajistíme, aby nebyly duplikáty)
        for (const topicKey in topics) {
            const selectedTopic = topics[topicKey];
            for (const seriesKey in selectedTopic) {
                const problemIndices = selectedTopic[seriesKey];
                problemIndices.forEach(num => {
                    allPossibleProblems.add(JSON.stringify({ series: seriesKey, num }));
                });
            }
        }
        masterProblemList = Array.from(allPossibleProblems).map(item => JSON.parse(item));
    }

    function loadProblems() {
        const seriesSelect = document.getElementById("series");
        const topicSelect = document.getElementById("topic");
        const problemsDiv = document.getElementById("problems");
        const problemCountDiv = document.getElementById("problemCount");
        const randomOrderCheckbox = document.getElementById("randomOrderCheckbox");
        problemsDiv.innerHTML = ''; // Vyčistíme výpis příkladů

        const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
        const selectedTopics = Array.from(topicSelect.selectedOptions).map(option => option.value);

        let filteredProblems = [...masterProblemList]; // Začneme se všemi problémy

        // Aplikujeme filtr podle sérií
        if (selectedSeries.length > 0) {
            filteredProblems = filteredProblems.filter(p => selectedSeries.includes(p.series));
        }

        // Aplikujeme filtr podle témat
        if (selectedTopics.length > 0) {
            filteredProblems = filteredProblems.filter(p => {
                // Zkontrolujeme, zda tento problém (p.series, p.num) existuje v některém z vybraných témat
                return selectedTopics.some(topicKey => {
                    const topicMap = topics[topicKey];
                    return topicMap[p.series] && topicMap[p.series].includes(p.num);
                });
            });
        }

        // Pokud nejsou vybrány žádné filtry, nebo filtry vedou k žádným problémům, vyčistíme a vrátíme se
        if (selectedSeries.length === 0 && selectedTopics.length === 0) {
            currentDisplayedProblems = [];
            problemCountDiv.textContent = `Počet příkladů: 0`;
            updateCategorySummary(); // NEW: Update summary even if no problems
            return;
        }

        // Seřadíme problémy podle série a poté podle čísla pro konzistentní pořadí před zamícháním
        filteredProblems.sort((a, b) => {
            if (a.series < b.series) return -1;
            if (a.series > b.series) return 1;
            return a.num - b.num;
        });

        // Pokud je zaškrtnuto "Náhodné pořadí", zamícháme problémy
        if (randomOrderCheckbox.checked) {
            shuffleArray(filteredProblems);
        }

        // Nyní přidáme displayIndex ke každému problému
        currentDisplayedProblems = filteredProblems.map((problem, i) => ({
            ...problem,
            displayIndex: i + 1
        }));

        // Zobrazování příkladů
        currentDisplayedProblems.forEach(({ series, num, displayIndex }) => {
            const problemDiv = document.createElement("div");
            problemDiv.className = "problem";
            problemDiv.setAttribute('data-series', series);
            problemDiv.setAttribute('data-num', num);

            // NEW: Add category checkboxes if developer mode is active
            let categoryCheckboxesHtml = '';
            if (developerModeActive) {
                categoryCheckboxesHtml = `<div class="category-checkbox-group" id="categoryCheckboxesContainer_${series}_${num}">`;
                PROBLEM_CATEGORIES.forEach(category => {
                    const problemId = `${series}/${num}`;
                    const isChecked = problemCategoryData[problemId] && problemCategoryData[problemId].includes(category) ? 'checked' : '';
                    const uniqueId = `cat-${series}-${num}-${category.replace(/\s/g, '-')}`; // Unique ID for checkbox
                    categoryCheckboxesHtml += `
                        <label class="category-checkbox-label">
                            <input type="checkbox" class="category-checkbox-input"
                                data-series="${series}" data-num="${num}" data-category="${category}"
                                id="${uniqueId}" ${isChecked}>
                            ${category}
                        </label>
                    `;
                });
                categoryCheckboxesHtml += `</div>`;
            }

            problemDiv.innerHTML = `
                <div class="problem-header-content">
                    <div class="problem-info-text">
                        <div class="problem-number">Příklad ${displayIndex}</div>
                        <div class="problem-id">ID: ${series}/${num}</div>
                    </div>
                    <button class="show-solution" data-series="${series}" data-num="${num}">Zobrazit řešení</button>
                    ${categoryCheckboxesHtml} <!-- Insert category checkboxes here -->
                </div>
                <img src="files/${series}/${num}.png" alt="Úloha ${num}" />
            `;
            problemsDiv.appendChild(problemDiv);

            // NEW: Attach event listeners for category checkboxes if developer mode is active
            if (developerModeActive) {
                const checkboxes = problemDiv.querySelectorAll('.category-checkbox-input');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const series = e.target.dataset.series;
                        const num = parseInt(e.target.dataset.num);
                        const category = e.target.dataset.category;
                        const isChecked = e.target.checked;
                        handleCategoryCheckboxChange(series, num, category, isChecked);
                    });
                });
            }
        });

        problemCountDiv.textContent = `Počet příkladů: ${currentDisplayedProblems.length}`;
        // Attach event listeners to newly created "show-solution" buttons
        document.querySelectorAll('.problem .show-solution').forEach(button => {
            button.onclick = function(event) {
                event.stopPropagation(); // Prevent click from bubbling up and closing overlay
                showSolution(this.dataset.series, parseInt(this.dataset.num));
            };
        });
        updateSolutionButtonState(); // Update solution button state after problems are loaded
        updateCategorySummary(); // NEW: Update summary after problems are loaded
    }

    // Nová funkce pro načtení příkladů a posun na první z nich
    function loadProblemsAndScroll() {
        loadProblems(); // Nejprve načteme příklady
        const problemsDiv = document.getElementById("problems");
        if (problemsDiv.firstElementChild) {
            problemsDiv.firstElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function applyRange() {
        const rangeFromInput = document.getElementById("rangeFrom");
        const rangeToInput = document.getElementById("rangeTo");
        const rangeFrom = parseInt(rangeFromInput.value);
        const rangeTo = parseInt(rangeToInput.value);
        const problemsDiv = document.getElementById("problems");
        const randomOrderCheckbox = document.getElementById("randomOrderCheckbox");
        problemsDiv.innerHTML = '';

        if (isNaN(rangeFrom) || isNaN(rangeTo)) {
            alert("Prosím zadejte platné čísla pro rozsah.");
            return;
        }

        // Pokud nejsou načteny žádné problémy, načteme je nejprve na základě aktuálních filtrů
        // loadProblems() nyní zajistí, že každý problém má displayIndex
        if (currentDisplayedProblems.length === 0) {
            loadProblems();
        }

        let rangedProblems = [];
        // Rozsah se aplikuje na vizuální index (Příklad 1, Příklad 2, atd.)
        for (let i = 0; i < currentDisplayedProblems.length; i++) {
            // Použijeme existující displayIndex pro porovnání
            if (currentDisplayedProblems[i].displayIndex >= rangeFrom && currentDisplayedProblems[i].displayIndex <= rangeTo) {
                rangedProblems.push(currentDisplayedProblems[i]); // Přidáme celý objekt, včetně jeho displayIndex
            }
        }

        // Pokud je zaškrtnuto "Náhodné pořadí", zamícháme problémy v rozsahu
        if (randomOrderCheckbox.checked) {
            shuffleArray(rangedProblems);
        }

        currentDisplayedProblems = rangedProblems; // Aktualizujeme currentDisplayedProblems na problémy v rozsahu

        // Zobrazování problémů
        currentDisplayedProblems.forEach(({ series, num, displayIndex }) => { // Použijeme displayIndex
            const problemDiv = document.createElement("div");
            problemDiv.className = "problem";
            problemDiv.setAttribute('data-series', series);
            problemDiv.setAttribute('data-num', num);

            // NEW: Add category checkboxes if developer mode is active
            let categoryCheckboxesHtml = '';
            if (developerModeActive) {
                categoryCheckboxesHtml = `<div class="category-checkbox-group" id="categoryCheckboxesContainer_${series}_${num}">`;
                PROBLEM_CATEGORIES.forEach(category => {
                    const problemId = `${series}/${num}`;
                    const isChecked = problemCategoryData[problemId] && problemCategoryData[problemId].includes(category) ? 'checked' : '';
                    const uniqueId = `cat-${series}-${num}-${category.replace(/\s/g, '-')}`;
                    categoryCheckboxesHtml += `
                        <label class="category-checkbox-label">
                            <input type="checkbox" class="category-checkbox-input"
                                data-series="${series}" data-num="${num}" data-category="${category}"
                                id="${uniqueId}" ${isChecked}>
                            ${category}
                        </label>
                    `;
                });
                categoryCheckboxesHtml += `</div>`;
            }

            problemDiv.innerHTML = `
                <div class="problem-header-content">
                    <div class="problem-info-text">
                        <div class="problem-number">Příklad ${displayIndex}</div>
                        <div class="problem-id">ID: ${series}/${num}</div>
                    </div>
                    <button class="show-solution" data-series="${series}" data-num="${num}">Zobrazit řešení</button>
                    ${categoryCheckboxesHtml} <!-- Insert category checkboxes here -->
                </div>
                <img src="files/${series}/${num}.png" alt="Úloha ${num}" />
            `;
            problemsDiv.appendChild(problemDiv);

            // NEW: Attach event listeners for category checkboxes if developer mode is active
            if (developerModeActive) {
                const checkboxes = problemDiv.querySelectorAll('.category-checkbox-input');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const series = e.target.dataset.series;
                        const num = parseInt(e.target.dataset.num);
                        const category = e.target.dataset.category;
                        const isChecked = e.target.checked;
                        handleCategoryCheckboxChange(series, num, category, isChecked);
                    });
                });
            }
        });

        document.getElementById("problemCount").textContent = `Počet příkladů: ${currentDisplayedProblems.length}`;
        // Attach event listeners to newly created "show-solution" buttons
        document.querySelectorAll('.problem .show-solution').forEach(button => {
            button.onclick = function(event) {
                event.stopPropagation(); // Prevent click from bubbling up and closing overlay
                showSolution(this.dataset.series, parseInt(this.dataset.num));
            };
        });
        updateSolutionButtonState(); // Update solution button state after problems are loaded
        updateCategorySummary(); // NEW: Update summary after problems are loaded
    }

    // Nová funkce pro zobrazení příkladu podle ID
    function showProblemById(autoScroll = false) {
        const problemIdInput = document.getElementById("problemIdInput");
        const problemsDiv = document.getElementById("problems");
        const problemCountDiv = document.getElementById("problemCount");
        problemsDiv.innerHTML = ''; // Vyčistíme stávající problémy

        const inputId = problemIdInput.value.trim();
        if (!inputId) {
            // If input is empty, just clear problems and return
            currentDisplayedProblems = [];
            problemCountDiv.textContent = `Počet příkladů: 0`;
            updateCategorySummary(); // NEW: Update summary
            return;
        }

        const idParts = inputId.split('/');
        if (idParts.length !== 2) {
            // Invalid format, handled by validateProblemId
            currentDisplayedProblems = [];
            problemCountDiv.textContent = `Počet příkladů: 0`;
            updateCategorySummary(); // NEW: Update summary
            return;
        }
        const series = idParts[0];
        const num = parseInt(idParts[1]);

        if (isNaN(num)) {
            // Invalid number, handled by validateProblemId
            currentDisplayedProblems = [];
            problemCountDiv.textContent = `Počet příkladů: 0`;
            updateCategorySummary(); // NEW: Update summary
            return;
        }

        const foundProblem = masterProblemList.find(p => p.series === series && p.num === num);

        if (foundProblem) {
            // Vyčistíme všechny ostatní filtry vizuálně
            document.getElementById("series").selectedIndex = -1;
            document.getElementById("topic").selectedIndex = -1;
            document.getElementById("rangeFrom").value = '';
            document.getElementById("rangeTo").value = '';
            document.getElementById("randomOrderCheckbox").checked = false;

            // Nastavíme pouze nalezený problém s displayIndex 1
            currentDisplayedProblems = [{ ...foundProblem, displayIndex: 1 }];

            const problemDiv = document.createElement("div");
            problemDiv.className = "problem";
            problemDiv.setAttribute('data-series', foundProblem.series);
            problemDiv.setAttribute('data-num', foundProblem.num);

            // NEW: Add category checkboxes if developer mode is active
            let categoryCheckboxesHtml = '';
            if (developerModeActive) {
                categoryCheckboxesHtml = `<div class="category-checkbox-group" id="categoryCheckboxesContainer_${series}_${num}">`;
                PROBLEM_CATEGORIES.forEach(category => {
                    const problemId = `${series}/${num}`;
                    const isChecked = problemCategoryData[problemId] && problemCategoryData[problemId].includes(category) ? 'checked' : '';
                    const uniqueId = `cat-${series}-${num}-${category.replace(/\s/g, '-')}`;
                    categoryCheckboxesHtml += `
                        <label class="category-checkbox-label">
                            <input type="checkbox" class="category-checkbox-input"
                                data-series="${series}" data-num="${num}" data-category="${category}"
                                id="${uniqueId}" ${isChecked}>
                            ${category}
                        </label>
                    `;
                });
                categoryCheckboxesHtml += `</div>`;
            }

            problemDiv.innerHTML = `
                <div class="problem-header-content">
                    <div class="problem-info-text">
                        <div class="problem-number">Příklad ${currentDisplayedProblems[0].displayIndex}</div>
                        <div class="problem-id">ID: ${foundProblem.series}/${foundProblem.num}</div>
                    </div>
                    <button class="show-solution" data-series="${foundProblem.series}" data-num="${foundProblem.num}">Zobrazit řešení</button>
                    ${categoryCheckboxesHtml} <!-- Insert category checkboxes here -->
                </div>
                <img src="files/${foundProblem.series}/${foundProblem.num}.png" alt="Úloha ${foundProblem.num}" />
            `;
            problemsDiv.appendChild(problemDiv);
            problemCountDiv.textContent = `Počet příkladů: 1`;

            // Posuneme se na zobrazený problém, pokud je autoScroll true
            if (autoScroll && problemsDiv.firstElementChild) {
                problemsDiv.firstElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // NEW: Attach event listeners for category checkboxes if developer mode is active
            if (developerModeActive) {
                const checkboxes = problemDiv.querySelectorAll('.category-checkbox-input');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const series = e.target.dataset.series;
                        const num = parseInt(e.target.dataset.num);
                        const category = e.target.dataset.category;
                        const isChecked = e.target.checked;
                        handleCategoryCheckboxChange(series, num, category, isChecked);
                    });
                });
            }
        } else {
            // This case should ideally be caught by validateProblemId before calling showProblemById
            currentDisplayedProblems = [];
            problemCountDiv.textContent = `Počet příkladů: 0`;
        }
        // Attach event listeners to newly created "show-solution" buttons
        document.querySelectorAll('.problem .show-solution').forEach(button => {
            button.onclick = function(event) {
                event.stopPropagation(); // Prevent click from bubbling up and closing overlay
                showSolution(this.dataset.series, parseInt(this.dataset.num));
            };
        });
        updateSolutionButtonState(); // Update solution button state after problems are loaded
        updateCategorySummary(); // NEW: Update summary after problems are loaded
    }

    function clearFilters() {
        const seriesSelect = document.getElementById("series");
        const topicSelect = document.getElementById("topic");
        const rangeFrom = document.getElementById("rangeFrom");
        const rangeTo = document.getElementById("rangeTo");
        const randomOrderCheckbox = document.getElementById("randomOrderCheckbox");
        const problemIdInput = document.getElementById("problemIdInput");

        // Resetování výběrů
        seriesSelect.selectedIndex = -1;
        topicSelect.selectedIndex = -1;
        rangeFrom.value = '';
        rangeTo.value = '';
        randomOrderCheckbox.checked = false; // Reset checkboxu
        
        // Clear ID input and reset its state
        problemIdInput.value = '';
        problemIdInput.classList.remove('valid-id', 'invalid-id');
        document.getElementById("problemIdHelpText").textContent = 'Nápověda: Zadejte ID ve formátu "16j/12"';
        document.getElementById("problemIdHelpText").classList.remove('error');

        // Načtení příkladů po vyčištění filtrů (což by mělo vést k prázdnému zobrazení)
        loadProblemsAndScroll();
    }

    // Function to close the overlay and reset its position
    function closeOverlay() {
        overlay.style.display = "none";
        overlay.style.left = '50%';
        overlay.style.top = '50%';
        overlay.style.transform = 'translate(-50%, -50%)';
        overlayHeader.style.cursor = 'grab'; // Reset cursor
        // Reset overlay size to default when closed
        overlay.style.width = '';
        overlay.style.height = '';
    }

    function showSolution(series, num) {
        const solutionImage = document.getElementById("solutionImage");
        const overlayTitle = document.getElementById("overlayTitle");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        // Najdeme index aktuálního problému v currentDisplayedProblems
        currentProblemIndex = currentDisplayedProblems.findIndex(p => p.series === series && p.num === num);

        if (currentProblemIndex === -1) {
            console.error("Problem not found in currentDisplayedProblems for solution display:", series, num);
            return; // Exit if problem not found
        }

        solutionImage.src = `files/${series}/${num}_res.png`;
        // Aktualizujeme innerHTML pro možnost stylování části textu
        overlayTitle.innerHTML = `Řešení <span class="problem-index-bold">příkladu ${currentDisplayedProblems[currentProblemIndex].displayIndex}</span> ID: ${series}/${num}`;
        overlay.style.display = "flex";

        // Aktualizujeme stav navigačních tlačítek
        prevBtn.disabled = currentProblemIndex <= 0;
        nextBtn.disabled = currentProblemIndex >= currentDisplayedProblems.length - 1;
    }

    function navigateSolution(direction) {
        if (currentDisplayedProblems.length === 0) return;

        let newIndex = currentProblemIndex;
        if (direction === 'prev') {
            newIndex = Math.max(0, currentProblemIndex - 1);
        } else if (direction === 'next') {
            newIndex = Math.min(currentDisplayedProblems.length - 1, currentProblemIndex + 1);
        }

        if (newIndex !== currentProblemIndex) {
            const problem = currentDisplayedProblems[newIndex];
            showSolution(problem.series, problem.num); // This updates the overlay

            // NEW: Update the main fullscreen problem display if in fullscreen
            const newProblemElement = document.querySelector(`.problem[data-series="${problem.series}"][data-num="${problem.num}"]`);
            if (newProblemElement && document.fullscreenElement) {
                prepareProblemForFullscreen(newProblemElement);
            }
        }
    }

    // Event listeners for overlay closing
    document.getElementById("closeBtn").addEventListener("click", closeOverlay);

    // Click on the backdrop (overlay itself) or inside overlayContent (but not header)
    overlay.addEventListener("click", function(e) {
        // If the click is on the overlay backdrop OR on the overlay content itself (but not the header)
        if (e.target === this || (e.target.closest('.overlay-content') && !e.target.closest('.overlay-header'))) {
            closeOverlay();
        }
    });

    // Document-wide click listener for closing overlay if click is outside the entire overlay
    document.addEventListener('click', function(e) {
        // Check if the overlay is visible AND the click target is NOT inside the overlay
        if (overlay.style.display === 'flex' && !overlay.contains(e.target)) {
            closeOverlay();
        }
    });

    // Event listenery pro navigační tlačítek
    document.getElementById("prevBtn").addEventListener("click", () => navigateSolution('prev'));
    document.getElementById("nextBtn").addEventListener("click", () => navigateSolution('next'));

    // Přidání podpory pro zavření overlay a navigaci pomocí kláves
    document.addEventListener("keydown", function(e) {
        const overlay = document.getElementById("overlay");
        const isOverlayOpen = overlay.style.display === "flex";
        const isFullscreen = document.fullscreenElement;

        if (e.key === "Escape") {
            e.preventDefault(); // Always prevent default for Escape in this context
            if (isOverlayOpen) { // If solution overlay is open
                closeOverlay(); // Close the solution overlay
            } else if (isFullscreen) { // If in fullscreen but overlay is not open
                exitFullscreen(); // Exit fullscreen
            }
        } else if (isFullscreen && activeProblemElement) { // Only in fullscreen mode
            if (isOverlayOpen) { // If solution overlay is open
                if (e.key === "ArrowLeft") {
                    e.preventDefault();
                    navigateSolution('prev');
                } else if (e.key === "ArrowRight") {
                    e.preventDefault();
                    navigateSolution('next');
                } else if (e.key === "ArrowUp" || e.key === "ArrowDown") { // NEW: Close solution and navigate
                    e.preventDefault();
                    closeOverlay();
                    if (e.key === "ArrowUp") {
                        navigateToPrevProblemInFullscreen();
                    } else {
                        navigateToNextProblemInFullscreen();
                    }
                }
            } else { // Solution overlay is NOT open, but in fullscreen
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    navigateToNextProblemInFullscreen();
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    navigateToPrevProblemInFullscreen();
                }
            }
            showFullscreenUIAndResetHideTimer(); // Show UI on key press
        }
    });

    // Prevence zoomování při double-tap na mobilních zařízeních
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);

    // Nová funkce pro přepínání pokročilých filtrů
    function toggleAdvancedFilters() {
        const advancedFiltersDiv = document.getElementById("advancedFilters");
        if (advancedFiltersDiv.style.display === "none" || advancedFiltersDiv.style.display === "") {
            advancedFiltersDiv.style.display = "block";
        } else {
            advancedFiltersDiv.style.display = "none";
        }
    }

    // Vymazání obsahu inputu při focusu
    document.getElementById("rangeFrom").addEventListener("focus", function() {
        this.value = '';
    });
    document.getElementById("rangeTo").addEventListener("focus", function() {
        this.value = '';
    });
    
    // Potvrzení rozsahu stisknutím Enter
    document.getElementById("rangeFrom").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault(); // Zabrání výchozímu chování (např. odeslání formuláře)
            applyRange();
        }
    });
    document.getElementById("rangeTo").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault(); // Zabrání výchozímu chování
            applyRange();
        }
    });

    // --- New/Modified ID Search Logic ---
    const problemIdInput = document.getElementById("problemIdInput");
    const problemIdHelpText = document.getElementById("problemIdHelpText");
    const clearIdInputBtn = document.getElementById("clearIdInputBtn");

    function validateProblemId() {
        const inputId = problemIdInput.value.trim();
        problemIdInput.classList.remove('valid-id', 'invalid-id');
        problemIdHelpText.classList.remove('error');
        problemIdHelpText.textContent = 'Nápověda: Zadejte ID ve formátu "16j/12"';

        if (inputId === '') {
            // If input is empty, just clear problems and return
            currentDisplayedProblems = []; // Clear displayed problems
            document.getElementById("problems").innerHTML = '';
            document.getElementById("problemCount").textContent = `Počet příkladů: 0`;
            updateCategorySummary(); // NEW: Update summary
            return;
        }

        const exactMatch = masterProblemList.find(p => `${p.series}/${p.num}` === inputId);
        const prefixMatch = masterProblemList.some(p => `${p.series}/${p.num}`.startsWith(inputId));

        if (exactMatch) {
            problemIdInput.classList.add('valid-id');
            showProblemById(true); // Automatically display and scroll on exact match
        } else if (prefixMatch) {
            // It's a valid prefix, but not an exact match yet
            // Keep default help text, no special styling
        } else {
            // No prefix or exact match found
            problemIdInput.classList.add('invalid-id');
            problemIdHelpText.textContent = 'Neexistující ID';
            problemIdHelpText.classList.add('error');
            currentDisplayedProblems = []; // Clear displayed problems
            document.getElementById("problems").innerHTML = '';
            document.getElementById("problemCount").textContent = `Počet příkladů: 0`;
        }
        updateCategorySummary(); // NEW: Update summary
    }

    function clearProblemIdInput() {
        problemIdInput.value = '';
        validateProblemId(); // Reset state
    }

    problemIdInput.addEventListener('input', validateProblemId);
    problemIdInput.addEventListener('keydown', function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            // If there's an exact match, showProblemById already scrolled.
            // If not, but user presses enter, try to show it and scroll.
            showProblemById(true);
        }
    });
    clearIdInputBtn.addEventListener('click', clearProblemIdInput);
    // --- End New/Modified ID Search Logic ---


    // Funkce pro aktualizaci progress baru
    function updateProgressBar() {
        const progressBar = document.getElementById("progressBar");
        const filtersSection = document.querySelector(".filters-section");
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        const clientHeight = window.innerHeight;

        // --- Logika pro fullscreen režim "Místo" ---
        if (document.fullscreenElement && activeProblemElement && activeProblemElement.classList.contains('fullscreen-active')) {
            progressBar.style.opacity = '1';

            const problemScrollTop = activeProblemElement.scrollTop;
            const problemScrollHeight = activeProblemElement.scrollHeight;
            const problemClientHeight = activeProblemElement.clientHeight;

            let scrollPercentage = 0;
            if (problemScrollHeight > problemClientHeight) {
                scrollPercentage = (problemScrollTop / (problemScrollHeight - problemClientHeight)) * 100;
            } else {
                scrollPercentage = 100; // If problem fits, it's "100% scrolled"
            }

            scrollPercentage = Math.max(0, Math.min(100, scrollPercentage));
            progressBar.style.width = `${scrollPercentage}%`;
            return; // Ukončíme, protože jsme zpracovali fullscreen režim
        }

        // --- Původní logika pro normální posouvání stránky ---
        if (!filtersSection) {
            progressBar.style.opacity = '0';
            return;
        }

        const startPoint = filtersSection.offsetTop + filtersSection.offsetHeight;

        if (scrollTop < startPoint) {
            progressBar.style.opacity = '0';
            progressBar.style.width = '0%';
            return;
        }

        progressBar.style.opacity = '1';

        const scrollHeightAfterFilters = document.documentElement.scrollHeight - startPoint;
        const totalScrollableHeightForProblems = scrollHeightAfterFilters - clientHeight;

        if (totalScrollableHeightForProblems > 0) {
            const scrollProgress = scrollTop - startPoint;
            let scrollPercentage = (scrollProgress / totalScrollableHeightForProblems) * 100;
            scrollPercentage = Math.max(0, Math.min(100, scrollPercentage));
            progressBar.style.width = `${scrollPercentage}%`;
        } else {
            progressBar.style.width = '100%';
        }
    }

    // Funkce pro přípravu problému pro zobrazení na celou obrazovku
    function prepareProblemForFullscreen(problemElement) {
        const allProblems = document.querySelectorAll('.problem');

        // Hide all problems first
        allProblems.forEach(p => p.classList.add('hidden-for-fullscreen'));

        // Remove fullscreen-active from any previously active problem
        if (activeProblemElement && activeProblemElement !== problemElement) {
            activeProblemElement.classList.remove('fullscreen-active');
        }

        // Set the new active problem and show it
        activeProblemElement = problemElement;
        activeProblemElement.classList.remove('hidden-for-fullscreen'); // Ensure it's visible
        activeProblemElement.classList.add('fullscreen-active'); // Add fullscreen class

        // Scroll to the top of the problem in fullscreen mode
        activeProblemElement.scrollTop = 0;

        // Update navigation arrows and counter
        showFullscreenUIAndResetHideTimer();
        updateProgressBar();
        updateSolutionButtonState(); // Update solution button state when problem changes
    }

    // Funkce, která skutečně požádá o fullscreen a připraví problé
    function requestAndPrepareFullscreen(problemElement) {
        if (document.documentElement.requestFullscreen) {
            lastScrollPosition = window.scrollY; // Save scroll position
            document.documentElement.requestFullscreen().then(() => {
                // After successful fullscreen, lock orientation
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(err => {
                        console.warn("Nepodařilo se uzamknout orientaci obrazovky na landscape:", err);
                    });
                }
                prepareProblemForFullscreen(problemElement);
            }).catch(err => {
                console.error(`Chyba při pokusu o přepnutí do režimu celé obrazovky: ${err.message}`);
                // If fullscreen fails, still prepare the problem for display (without actual browser fullscreen)
                prepareProblemForFullscreen(problemElement);
                // If fullscreen failed, hide UI as it's not truly in fullscreen
                hideFullscreenUI();
            });
        } else {
            alert("Váš prohlížeč nepodporuje režim celé obrazovky.");
            prepareProblemForFullscreen(problemElement);
            // If fullscreen not supported, hide UI
            hideFullscreenUI();
        }
    }

    // Funkce pro obsluhu kliknutí na tlačítko "Projekce"
    function toggleFullscreenForFirstVisibleProblem(event) {
        event.stopPropagation(); // Prevent click from bubbling up to document and closing overlay

        // If already in fullscreen, exit it
        if (document.fullscreenElement) {
            // If already in fullscreen, this button should not trigger anything,
            // as the exit button is shown instead.
            return;
        }

        const problems = Array.from(document.querySelectorAll('.problem'));
        let firstVisibleProblem = null;

        for (const problem of problems) {
            const rect = problem.getBoundingClientRect();
            // Problem is visible if its top is within the viewport and it's not completely off-screen below
            if (rect.top >= 0 && rect.top < window.innerHeight) {
                firstVisibleProblem = problem;
                break;
            }
        }

        if (firstVisibleProblem) {
            requestAndPrepareFullscreen(firstVisibleProblem);
        } else {
            alert("Není viditelný žádný příklad k zobrazení na celou obrazovku.");
        }
    }

    // Funkce pro zobrazení šipek a časovače pro navigaci ve fullscreenu
    function showFullscreenUI() {
        const nextArrow = document.getElementById('nextProblemArrow');
        const prevArrow = document.getElementById('prevProblemArrow');
        const problemCounter = document.getElementById('fullscreenProblemCounter');
        const exitButton = document.getElementById('exitFullscreenButton'); // Get the exit button
        const projectionButton = document.querySelector('.projection-button'); // Get the normal projection button

        // Find the actual problem data from currentDisplayedProblems using data attributes
        const activeProblemSeries = activeProblemElement ? activeProblemElement.dataset.series : null;
        const activeProblemNum = activeProblemElement ? parseInt(activeProblemElement.dataset.num) : null;
        const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === activeProblemSeries && p.num === activeProblemNum);


        if (nextArrow) {
            nextArrow.style.display = 'block';
            nextArrow.disabled = currentProblemDataIndex >= currentDisplayedProblems.length - 1;
            nextArrow.style.opacity = '1'; // Ensure visible when shown
        }
        if (prevArrow) {
            prevArrow.style.display = 'block';
            prevArrow.disabled = currentProblemDataIndex <= 0;
            prevArrow.style.opacity = '1'; // Ensure visible when shown
        }
        if (problemCounter) {
            // UPDATED: Get the displayIndex from the found problem data
            const currentProblemData = currentDisplayedProblems.find(p =>
                p.series === activeProblemSeries && p.num === activeProblemNum
            );
            if (currentProblemData) {
                problemCounter.textContent = `${currentProblemData.displayIndex}/${currentDisplayedProblems.length}`;
            } else {
                problemCounter.textContent = `?/${currentDisplayedProblems.length}`; // Fallback
            }
            problemCounter.style.display = 'block';
        }
        if (fullscreenTimerElement) {
            fullscreenTimerElement.style.display = 'block';
            fullscreenTimerElement.style.opacity = '1';
        }
        if (fullscreenTimerControls) {
            fullscreenTimerControls.style.display = 'flex';
            fullscreenTimerControls.style.opacity = '1';
        }
        
        // In fullscreen, hide projection button and show exit button
        if (projectionButton) {
            projectionButton.style.display = 'none'; // Hide the normal projection button
        }
        if (exitButton) {
            exitButton.style.display = 'flex'; // Show the exit button immediately
            // Position is now handled by CSS (top: 1rem, right: 1rem)
        }

        // Only hide arrows and timer after delay, exit button stays visible
        hideFullscreenUIDelayed();
    }

    // Funkce pro skrytí šipek a časovače pro navigaci ve fullscreenu
    function hideFullscreenUI() {
        clearTimeout(fullscreenUIHideTimeout); // Clear any pending hide
        const nextArrow = document.getElementById('nextProblemArrow');
        const prevArrow = document.getElementById('prevProblemArrow');
        const problemCounter = document.getElementById('fullscreenProblemCounter');
        const exitButton = document.getElementById('exitFullscreenButton'); // Get the exit button
        const projectionButton = document.querySelector('.projection-button'); // Get the normal projection button
        const fullscreenTimerElement = document.getElementById('fullscreenTimer'); // Ensure timer is also handled
        const fullscreenTimerControls = document.getElementById('fullscreenTimerControls'); // Ensure controls are also handled

        // First, set opacity to 0 for a smooth fade-out for elements that auto-hide
        if (nextArrow) nextArrow.style.opacity = '0';
        if (prevArrow) prevArrow.style.opacity = '0';
        if (fullscreenTimerElement) fullscreenTimerElement.style.opacity = '0';
        if (fullscreenTimerControls) fullscreenTimerControls.style.opacity = '0';

        // After a short delay (to allow opacity transition), set display to none
        setTimeout(() => {
            if (nextArrow) nextArrow.style.display = 'none';
            if (prevArrow) prevArrow.style.display = 'none';
            if (problemCounter) problemCounter.style.display = 'none';
            if (fullscreenTimerElement) fullscreenTimerElement.style.display = 'none';
            if (fullscreenTimerControls) fullscreenTimerControls.style.display = 'none';
            
            // Exit button and projection button are handled separately
            if (exitButton) exitButton.style.display = 'none';
            if (projectionButton) projectionButton.style.display = 'flex'; // Show projection button when not in fullscreen
        }, 300); // Match CSS transition duration for opacity
    }

    // Funkce pro navigaci na předchozí příklad ve fullscreen režimu
    function navigateToPrevProblemInFullscreen() {
        if (!activeProblemElement || !document.fullscreenElement || currentDisplayedProblems.length === 0) {
            return;
        }

        const currentSeries = activeProblemElement.dataset.series;
        const currentNum = parseInt(activeProblemElement.dataset.num);

        const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === currentSeries && p.num === currentNum);

        if (currentProblemDataIndex <= 0) {
            return; // Already at the first problem
        }

        const prevProblemData = currentDisplayedProblems[currentProblemDataIndex - 1];
        if (prevProblemData) {
            const prevProblemElement = document.querySelector(`.problem[data-series="${prevProblemData.series}"][data-num="${prevProblemData.num}"]`);
            if (prevProblemElement) {
                prepareProblemForFullscreen(prevProblemElement);
                showFullscreenUIAndResetHideTimer();

                if (overlay.style.display === 'flex') {
                    showSolution(prevProblemData.series, prevProblemData.num);
                }
            }
        }
    }

    // Funkce pro navigaci na další příklad ve fullscreen režimu
    function navigateToNextProblemInFullscreen() {
        if (!activeProblemElement || !document.fullscreenElement || currentDisplayedProblems.length === 0) {
            return;
        }

        const currentSeries = activeProblemElement.dataset.series;
        const currentNum = parseInt(activeProblemElement.dataset.num);

        const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === currentSeries && p.num === currentNum);

        if (currentProblemDataIndex === -1 || currentProblemDataIndex >= currentDisplayedProblems.length - 1) {
            return; // Already at the last problem or not found
        }

        const nextProblemData = currentDisplayedProblems[currentProblemDataIndex + 1];
        if (nextProblemData) {
            const nextProblemElement = document.querySelector(`.problem[data-series="${nextProblemData.series}"][data-num="${nextProblemData.num}"]`);
            if (nextProblemElement) {
                prepareProblemForFullscreen(nextProblemElement);
                showFullscreenUIAndResetHideTimer();

                if (overlay.style.display === 'flex') {
                    showSolution(nextProblemData.series, nextProblemData.num);
                }
            }
        }
    }

    // Function to exit fullscreen directly
    function exitFullscreen() {
        document.exitFullscreen();
    }

    // Event listener pro změnu režimu celé obrazovky
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) { // Uživatel opustil režim celé obrazovky
            if (activeProblemElement) {
                activeProblemElement.classList.remove('fullscreen-active');
            }
            activeProblemElement = null; // Reset aktivního problému při opuštění fullscreenu
            hideFullscreenUI(); // Skryjeme UI
            // stopFullscreenTimer(); // Timer now runs independently
            updateProgressBar(); // Aktualizujeme progress bar pro normální režim

            // Show all problems again
            document.querySelectorAll('.problem').forEach(p => p.classList.remove('hidden-for-fullscreen'));

            // Restore scroll position
            window.scrollTo(0, lastScrollPosition);

            // Close overlay if open
            closeOverlay();

            // Odemkneme orientaci obrazovky
            if (screen.orientation && screen.orientation.unlock) {
                screen.orientation.unlock();
            }
        } else { // Entered fullscreen
            // If we entered fullscreen on an element that is not activeProblemElement, update it
            if (document.fullscreenElement.classList.contains('problem') && document.fullscreenElement !== activeProblemElement) {
                prepareProblemForFullscreen(document.fullscreenElement);
            }
            // startFullscreenTimer(); // Timer now runs independently
            showFullscreenUI(); // Ensure UI is shown immediately upon entering fullscreen
        }
        updateSolutionButtonState(); // Update solution button state on fullscreen change
    });

    // Keyboard navigation for fullscreen
    // This part is now handled by the general keydown listener for ESC and arrows
    // document.addEventListener('keydown', function(e) {
    //     if (document.fullscreenElement && activeProblemElement) { // Pouze ve fullscreen "Místo" režimu
    //         if (e.key === "ArrowDown") {
    //             e.preventDefault();
    //             navigateToNextProblemInFullscreen();
    //         } else if (e.key === "ArrowUp") {
    //             e.preventDefault();
    //             navigateToPrevProblemInFullscreen();
    //         } else if (e.key === "Escape") {
    //             e.preventDefault(); // Prevent default browser exit
    //             exitFullscreen(); // Directly exit fullscreen
    //         }
    //         showFullscreenUIAndResetHideTimer(); // Show UI on key press
    //     }
    // });

    // Touch/Swipe navigation - MODIFIED to allow internal scrolling
    document.addEventListener('touchstart', function(e) {
        if (document.fullscreenElement && activeProblemElement && e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
    }, { passive: true }); // Passive listener for better scroll performance

    document.addEventListener('touchmove', function(e) {
        // In fullscreen, we now allow default scrolling within the problem.
        // No e.preventDefault() here unless we want to block all scrolling.
        // The problem element itself will handle its overflow scrolling.
    }, { passive: true });

    document.addEventListener('touchend', function(e) {
        if (document.fullscreenElement && activeProblemElement && e.changedTouches.length === 1) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // Only consider horizontal swipes for navigation (if we wanted to add it back)
            // For vertical scrolling, we now rely on the native scroll of the fullscreen element.
            // The user explicitly asked to disable vertical swipe for navigation between problems.
        }
        // Resetování souřadnic dotyku
        touchStartX = 0;
        touchStartY = 0;
        if (document.fullscreenElement && activeProblemElement) {
            showFullscreenUIAndResetHideTimer(); // Show UI on touch end
        }
    });

    // Overlay dragging logic - now only on header
    overlayHeader.addEventListener('mousedown', (e) => {
        if (e.button === 0) { // Left mouse button
            isDraggingOverlay = true;
            const rect = overlay.getBoundingClientRect();
            overlayDragOffsetX = e.clientX - rect.left;
            overlayDragOffsetY = e.clientY - rect.top;
            overlayHeader.style.cursor = 'grabbing';
            overlay.style.transition = 'none'; // Disable transition during drag

            // Capture current dimensions and set them explicitly
            overlay.style.width = `${rect.width}px`;
            overlay.style.height = `${rect.height}px`;
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (isDraggingOverlay) {
            e.preventDefault(); // Prevent text selection during drag
            overlay.style.left = `${e.clientX - overlayDragOffsetX}px`;
            overlay.style.top = `${e.clientY - overlayDragOffsetY}px`;
            overlay.style.transform = 'none'; // Remove transform during drag
        }
    });

    document.addEventListener('mouseup', () => {
        if (isDraggingOverlay) {
            isDraggingOverlay = false;
            overlayHeader.style.cursor = 'grab';
            overlay.style.transition = ''; // Re-enable transition

            // Clear explicit dimensions to allow responsive resizing again
            overlay.style.width = '';
            overlay.style.height = '';
        }
    });
    // Initial cursor style for header
    overlayHeader.style.cursor = 'grab';


    // Fullscreen UI auto-hide logic (arrows and timer)
    function hideFullscreenUIDelayed() {
        clearTimeout(fullscreenUIHideTimeout);
        fullscreenUIHideTimeout = setTimeout(() => {
            const prevArrow = document.getElementById('prevProblemArrow');
            const nextArrow = document.getElementById('nextProblemArrow');
            if (prevArrow) prevArrow.style.opacity = '0';
            if (nextArrow) nextArrow.style.opacity = '0';
            if (fullscreenTimerElement) fullscreenTimerElement.style.opacity = '0';
            if (fullscreenTimerControls) fullscreenTimerControls.style.opacity = '0';
        }, UI_HIDE_DELAY);
    }

    function showFullscreenUIAndResetHideTimer() {
        clearTimeout(fullscreenUIHideTimeout);
        const prevArrow = document.getElementById('prevProblemArrow');
        const nextArrow = document.getElementById('nextProblemArrow');
        if (prevArrow) {
            prevArrow.style.display = 'block'; // Ensure it's visible
            prevArrow.style.opacity = '1';
        }
        if (nextArrow) {
            nextArrow.style.display = 'block'; // Ensure it's visible
            nextArrow.style.opacity = '1';
        }
        if (fullscreenTimerElement) {
            fullscreenTimerElement.style.display = 'block'; // Ensure it's visible
            fullscreenTimerElement.style.opacity = '1';
        }
        if (fullscreenTimerControls) {
            fullscreenTimerControls.style.display = 'flex'; // Ensure it's visible
            fullscreenTimerControls.style.opacity = '1';
        }
        hideFullscreenUIDelayed();
    }

    // Add event listeners for mousemove and click in fullscreen
    document.addEventListener('mousemove', (e) => {
        if (document.fullscreenElement && activeProblemElement) {
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const mouseY = e.clientY;
            const mouseX = e.clientX;
            const activationZone = 100; // Pixels from edges

            // Show UI if mouse is near top/bottom (for arrows) or bottom-left (for timer)
            if (mouseY < activationZone || mouseY > viewportHeight - activationZone ||
                (mouseY > viewportHeight - activationZone && mouseX < activationZone + fullscreenTimerElement.offsetWidth + fullscreenTimerControls.offsetWidth + 20)) { // 20 for gap
                showFullscreenUIAndResetHideTimer();
            } else {
                // If mouse is in the middle, hide them after delay
                hideFullscreenUIDelayed();
            }
        }
    });

    document.addEventListener('click', (e) => {
        if (document.fullscreenElement && activeProblemElement) {
            showFullscreenUIAndResetHideTimer();
        }
    });

    // Timer functions
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
    }

    function updateTimerDisplay() {
        fullscreenTimerElement.textContent = formatTime(timerSeconds);
    }

    function showFullscreenAlert(message, duration, callback = null) {
        fullscreenAlertOverlay.textContent = message;
        fullscreenAlertOverlay.style.display = 'flex';
        fullscreenAlertOverlay.classList.add('active'); // Block interactions

        clearTimeout(fullscreenUIHideTimeout); // Clear any pending UI hide
        showFullscreenUI(); // Ensure UI is visible during alert

        setTimeout(() => {
            fullscreenAlertOverlay.style.display = 'none';
            fullscreenAlertOverlay.classList.remove('active');
            if (callback) callback();
            hideFullscreenUIDelayed(); // Restart UI hide timer after alert
        }, duration);
    }

    function startTimerCountdown() {
        if (timerInterval) clearInterval(timerInterval); // Clear any existing interval
        timerInterval = setInterval(() => {
            if (fullscreenAlertOverlay.classList.contains('active')) {
                return; // Pause countdown if alert is active
            }

            timerSeconds--;
            updateTimerDisplay();

            if (timerSeconds === 600 && !twoMinuteAlertShown) {
                twoMinuteAlertShown = true;
                showFullscreenAlert("10 minut do konce", 10000);
            }

            if (timerSeconds <= 0) {
                clearInterval(timerInterval);
                timerRunning = false; // Timer has finished
                playPauseTimerBtn.innerHTML = '&#9658;'; // Set to play icon
                showFullscreenAlert("KONEC, za 10s si budete moci zkontrolovat výsledky", 10000, () => {
                    // After 10s, stay in fullscreen, move to first problem, and open solution
                    if (currentDisplayedProblems.length > 0) {
                        const firstProblem = currentDisplayedProblems[0];
                        const firstProblemElement = document.querySelector(`.problem[data-series="${firstProblem.series}"][data-num="${firstProblem.num}"]`);
                        if (firstProblemElement) {
                            prepareProblemForFullscreen(firstProblemElement);
                        }
                        showSolution(firstProblem.series, firstProblem.num);
                        showFullscreenUI(); // Keep UI visible after showing solution, don't auto-hide immediately
                    }
                });
            }
            updateSolutionButtonState(); // Update solution button state with every tick
        }, 1000);
    }

    function toggleTimer() {
        if (timerRunning) {
            // Pause timer
            clearInterval(timerInterval);
            timerRunning = false;
            playPauseTimerBtn.innerHTML = '&#10074;&#10074;'; // Pause icon
        } else {
            // Start/Resume timer
            timerRunning = true;
            playPauseTimerBtn.innerHTML = '&#10074;&#10074;'; // Pause icon
            startTimerCountdown();
        }
        updateSolutionButtonState(); // Update solution button state
        showFullscreenUIAndResetHideTimer(); // Show UI on timer control interaction
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerSeconds = 8100; // Reset to 135 minutes
        timerRunning = false;
        twoMinuteAlertShown = false;
        finalAlertShown = false;
        updateTimerDisplay();
        playPauseTimerBtn.innerHTML = '&#9658;'; // Play icon
        updateSolutionButtonState(); // Update solution button state
        showFullscreenUIAndResetHideTimer(); // Show UI on timer control interaction
    }

    // Event listeners for new timer buttons
    playPauseTimerBtn.addEventListener('click', toggleTimer);
    resetTimerBtn.addEventListener('click', resetTimer);

    // Function to update the state of the "Show Solution" button
    function updateSolutionButtonState() {
        const allSolutionButtons = document.querySelectorAll('.problem .show-solution'); // Select ALL solution buttons

        allSolutionButtons.forEach(button => {
            const problemElement = button.closest('.problem');
            const isFullscreenActiveProblem = problemElement && problemElement.classList.contains('fullscreen-active');

            if (timerRunning && isFullscreenActiveProblem) {
                button.classList.add('locked');
                button.setAttribute('title', 'Při běžícím odpočtu jsou výsledky blokovány');
                // Override onclick to do nothing or show a specific alert if needed,
                // but for now, just prevent default action.
                button.onclick = (event) => {
                    event.stopPropagation();
                    // The 'title' attribute provides the tooltip.
                };
            } else {
                button.classList.remove('locked');
                button.removeAttribute('title');
                // Re-attach original click handler
                button.onclick = function(event) {
                    event.stopPropagation();
                    showSolution(this.dataset.series, parseInt(this.dataset.num));
                };
            }
        });
    }


    // Function to update projection button position (fixed below header)
    function updateProjectionButtonPosition() {
        const projectionButton = document.querySelector('.projection-button');
        const header = document.querySelector('header');
        if (projectionButton && header) {
            const headerBottom = header.getBoundingClientRect().bottom;
            // Position it 10px below the header's bottom edge, or at 20px from top if header is off-screen
            const newTop = Math.max(20, headerBottom + 10);
            projectionButton.style.top = `${newTop}px`;
        }
    }

    // NEW: Developer Mode Functions
    function toggleDeveloperMode() {
        developerModeActive = developerModeCheckbox.checked;
        loadProblems(); // Re-render problems to show/hide category checkboxes
        updateCategorySummary(); // Show/hide and update summary
    }

    function handleCategoryCheckboxChange(series, num, category, isChecked) {
        const problemId = `${series}/${num}`;
        if (!problemCategoryData[problemId]) {
            problemCategoryData[problemId] = [];
        }

        if (isChecked) {
            if (!problemCategoryData[problemId].includes(category)) {
                problemCategoryData[problemId].push(category);
            }
        } else {
            problemCategoryData[problemId] = problemCategoryData[problemId].filter(cat => cat !== category);
            if (problemCategoryData[problemId].length === 0) {
                delete problemCategoryData[problemId]; // Remove entry if no categories selected
            }
        }
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(problemCategoryData));
        updateCategorySummary();
    }

    function updateCategorySummary() {
        if (!developerModeActive) {
            developerModeSummary.style.display = 'none';
            return;
        }

        developerModeSummary.style.display = 'block';
        let summaryText = '';
        const summaryByCategory = {};

        // Initialize all categories
        PROBLEM_CATEGORIES.forEach(category => {
            summaryByCategory[category] = [];
        });

        // Populate with problem numbers
        for (const problemId in problemCategoryData) {
            const categories = problemCategoryData[problemId];
            const problemNum = problemId.split('/')[1]; // Get the number part of the ID
            categories.forEach(category => {
                if (summaryByCategory[category]) {
                    summaryByCategory[category].push(parseInt(problemNum));
                }
            });
        }

        // Sort problem numbers within each category
        for (const category in summaryByCategory) {
            summaryByCategory[category].sort((a, b) => a - b);
            summaryText += `${category} - [${summaryByCategory[category].join(', ')}]\n`;
        }

        categorySummaryContent.textContent = summaryText.trim();
    }

    // NEW: Function to clear all categories
    function clearAllCategories() {
        if (confirm("Opravdu chcete smazat všechny zaškrtnuté kategorie u všech příkladů? Tato akce je nevratná.")) {
            problemCategoryData = {}; // Reset the data
            localStorage.removeItem(LOCAL_STORAGE_KEY); // Clear from localStorage
            loadProblems(); // Re-render all problems to uncheck checkboxes
            updateCategorySummary(); // Update the summary output
        }
    }

    // NEW: Clipboard copy on text selection in summary
    categorySummaryContent.addEventListener('mouseup', (e) => {
        const selectedText = window.getSelection().toString();
        if (selectedText.length > 0 && categorySummaryContent.contains(e.target)) {
            navigator.clipboard.writeText(selectedText).then(() => {
                copyFeedback.style.opacity = '1';
                setTimeout(() => {
                    copyFeedback.style.opacity = '0';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
    });


    // Načtení masterProblemList a datalistu při načtení stránky
    document.addEventListener('DOMContentLoaded', () => {
        generateMasterProblemList();
        updateProgressBar(); // Nastavíme počáteční stav progress baru

        // NEW: Load developer mode state and data from localStorage
        const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (storedData) {
            problemCategoryData = JSON.parse(storedData);
        }
        developerModeCheckbox.checked = localStorage.getItem('developerModeActive') === 'true';
        developerModeActive = developerModeCheckbox.checked;

        // Přidáme event listenery pro šipky "Další příklad" a "Předchozí příklad"
        const nextProblemArrow = document.getElementById('nextProblemArrow');
        if (nextProblemArrow) {
            nextProblemArrow.addEventListener('click', navigateToNextProblemInFullscreen);
        }
        const prevProblemArrow = document.getElementById('prevProblemArrow');
        if (prevProblemArrow) {
            prevProblemArrow.addEventListener('click', navigateToPrevProblemInFullscreen);
        }
        // NEW: Attach event listener for clear categories button
        if (clearCategorySummaryBtn) {
            clearCategorySummaryBtn.addEventListener('click', clearAllCategories);
        }

        loadProblems(); // Initial load of problems
        updateProjectionButtonPosition(); // Set initial position for projection button
        updateTimerDisplay(); // Set initial timer display
        updateSolutionButtonState(); // Initial update for solution button state
        updateCategorySummary(); // NEW: Initial update for developer mode summary
    });

    // Přidáme event listener pro scroll událost
    window.addEventListener('scroll', () => {
        updateProgressBar();
        updateProjectionButtonPosition(); // Update projection button position on scroll
    });
    // Přidáme event listener pro resize událost, protože se může změnit scrollableHeight
    window.addEventListener('resize', () => {
        updateProgressBar();
        updateProjectionButtonPosition(); // Update projection button position on resize
    });

    // NEW: Save developer mode state to localStorage on checkbox change
    developerModeCheckbox.addEventListener('change', () => {
        localStorage.setItem('developerModeActive', developerModeCheckbox.checked);
    });
</script>
</body>
</html>
