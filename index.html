<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portál pro procvičování na maturitu z matematiky</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 0;
      line-height: 1.4;
    }

    /* Progress Bar Styling */
    #progressBar {
      position: fixed;
      top: 0;
      left: 0;
      height: 5px;
      background-color: #1565c0;
      width: 0%;
      z-index: 10000;
      transition: width 0.1s ease-out, opacity 0.3s ease-in-out;
      opacity: 0;
    }

    header {
      background-color: #1e88e5;
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      flex-wrap: wrap;
      gap: 1rem;
      padding-top: calc(1rem + 5px);
      position: relative;
    }

    .logo-link {
      display: flex;
      align-items: center;
      flex-shrink: 0;
      text-decoration: none;
    }

    .logo {
      max-width: 60px;
      height: auto;
      flex-shrink: 0;
    }

    h1 {
      margin: 0;
      flex-grow: 1;
      font-size: 1.5rem;
      min-width: 200px;
    }

    .search-link {
      color: white;
      text-decoration: none;
      background-color: #1565c0;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      transition: background-color 0.2s ease;
      white-space: nowrap;
      font-size: 0.9rem;
      text-align: center;
      min-width: 160px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-link:hover {
      background-color: #0d47a1;
    }

    .projection-button {
      position: fixed;
      left: 20px;
      z-index: 10001;
      background-color: #607d8b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex; /* Default: visible */
      align-items: center;
      justify-content: center;
      min-width: 48px;
      min-height: 48px;
    }

    .projection-button:hover {
      background-color: #455a64;
    }

    #exitFullscreenButton {
      position: fixed;
      top: 1rem;
      right: 1rem;
      left: auto;
      z-index: 10003;
      background-color: #ef5350;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background-color 0.2s ease, opacity 0.2s ease;
      display: none; /* Default: hidden */
      align-items: center;
      justify-content: center;
      min-width: 32px;
      min-height: 32px;
      opacity: 0.6;
    }

    #exitFullscreenButton:hover {
      background-color: #e53935;
      opacity: 1;
    }

    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 0 1rem;
    }

    /* Pinned Section Styles */
    #pinnedSection {
      display: none;
      background: #fff;
      border: 2px solid #ef5350;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(239, 83, 80, 0.15);
    }

    #pinnedSection h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #d32f2f;
    }

    #pinnedIdList {
      background: #fdf2f2;
      border: 1px solid #ffcdd2;
      padding: 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #b71c1c;
      word-break: break-all;
      transition: background 0.2s;
    }

    #pinnedIdList:hover {
      background: #ffebee;
    }

    #pinnedShareLink {
      font-size: 0.85rem;
      color: #1e88e5;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 0.5rem;
      display: block;
      word-break: break-all;
    }
    #pinnedShareLink:hover {
      color: #1565c0;
    }

    .pinned-controls {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .delete-pinned-btn {
      background-color: #ef5350;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .delete-pinned-btn:hover {
      background-color: #d32f2f;
    }

    .filters-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .select-group {
      margin-bottom: 1.5rem;
    }

    .select-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #333;
    }

    select {
      width: 100%;
      font-size: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      outline: none;
      background-color: white;
      transition: border-color 0.2s ease;
    }

    select:focus {
      border-color: #1e88e5;
    }

    #problemCount {
      font-weight: 600;
      color: #1e88e5;
      font-size: 1.1rem;
      margin: 1rem 0;
      text-align: center;
      padding: 0.5rem;
      background-color: #e3f2fd;
      border-radius: 8px;
    }

    .toggle-advanced-filters,
    .go-to-problems-button,
    .reset-filters-button {
      display: block;
      width: 100%;
      padding: 0.75rem 1.5rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      margin-bottom: 1rem;
      min-height: 48px;
    }

    .toggle-advanced-filters {
      background-color: #607d8b;
    }

    .toggle-advanced-filters:hover {
      background-color: #455a64;
    }

    .go-to-problems-button {
      background-color: #4CAF50;
    }

    .go-to-problems-button:hover {
      background-color: #45a049;
    }

    .reset-filters-button {
      background-color: #ef5350;
    }

    .reset-filters-button:hover {
      background-color: #d32f2f;
    }

    #advancedFilters {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .range-section, .list-search-section {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .list-search-section label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .list-search-section input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      outline: none;
    }

    .range-input {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .range-input label {
      font-weight: 500;
      white-space: nowrap;
    }

    .range-input input {
      padding: 0.75rem;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      outline: none;
      width: 80px;
      text-align: center;
      font-size: 1rem;
    }

    .range-input input:focus {
      border-color: #1e88e5;
    }

    .range-input button,
    .clear-filter {
      padding: 0.75rem 1.5rem;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      min-height: 48px;
    }

    .range-input button:hover,
    .clear-filter:hover {
      background-color: #1565c0;
    }

    .clear-filter {
      background-color: #e53935;
      width: 100%;
      margin-top: 1rem;
    }

    .clear-filter:hover {
      background-color: #c62828;
    }

    .problem {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      padding: 1.5rem;
      text-align: center;
      position: relative;
      display: block;
      border: 3px solid transparent;
      transition: border-color 0.3s;
    }

    /* Pinned Problem Style */
    .problem.pinned {
      border-color: #ef5350;
    }

    .problem img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .problem.fullscreen-active {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      z-index: 9999;
      background: white;
      padding: 1rem;
      border-radius: 0;
      box-shadow: none;
      margin-bottom: 0;
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
      align-items: start;
      gap: 1rem;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    .problem.fullscreen-active::-webkit-scrollbar {
        display: none;
    }

    .problem.fullscreen-active img {
      grid-column: 1;
      grid-row: 2;
      width: auto;
      height: auto;
      margin: 0 auto;
      touch-action: pan-x pan-y pinch-zoom;
      cursor: grab;
    }

    .problem-header-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
      margin-bottom: 0;
      gap: 0.5rem;
      grid-column: 1;
      grid-row: 1;
      padding-top: 1rem;
    }

    .problem-info-text {
      text-align: left;
      flex-grow: 0;
      width: 100%;
      order: 1;
    }

    .problem.fullscreen-active .problem-number,
    .problem.fullscreen-active .problem-id {
      text-align: left;
      margin: 0;
    }

    .controls-row {
      display: flex;
      gap: 0.5rem;
      width: 100%;
      order: 2;
    }

    .problem.fullscreen-active .show-solution {
      width: auto;
      max-width: none;
      align-self: flex-start;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      min-height: 40px;
    }

    .pin-button {
      background: #eee;
      border: none;
      border-radius: 8px;
      width: 48px;
      height: 48px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .pin-button:hover {
      background: #e0e0e0;
    }

    .pin-button.active {
      background: #ffebee;
      color: #ef5350;
    }

    .problem.fullscreen-active .pin-button {
      height: 40px;
      width: 40px;
    }

    .problem.hidden-for-fullscreen {
      display: none !important;
    }

    .problem-number {
      font-weight: bold;
      font-size: 1.3rem;
      color: #1e88e5;
      text-align: left;
      margin-bottom: 0.5rem;
    }

    .problem-id {
      font-size: 0.9rem;
      color: #666;
      text-align: left;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .show-solution {
      display: inline-block;
      padding: 1rem 2rem;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      min-height: 48px;
      width: 100%;
      max-width: 300px;
    }

    .show-solution:hover {
      background-color: #1565c0;
    }

    .problem.fullscreen-active .show-solution.locked {
      background-color: #9e9e9e;
      cursor: not-allowed;
      opacity: 0.7;
      position: relative;
      padding-left: 2.5rem;
    }
    .problem.fullscreen-active .show-solution.locked::before {
      content: '\1F512';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2em;
    }
    .problem.fullscreen-active .show-solution.locked:hover {
      background-color: #9e9e9e;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 10004;
      padding: 1rem;
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      cursor: default;
      transition: all 0.2s ease;
    }

    .overlay-content {
      background: white;
      border-radius: 10px;
      padding: 0;
      max-width: 100%;
      max-height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background-color: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      cursor: grab;
    }

    .overlay-header h3 {
      margin: 0;
      color: #333;
      font-size: 1.1rem;
      flex-grow: 1;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 10px;
      font-weight: normal;
    }

    .overlay-header h3 .problem-index-bold {
      font-weight: bold;
    }

    .close-btn {
      cursor: pointer;
      color: #666;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: #e0e0e0;
      font-size: 1.5rem;
      transition: all 0.2s ease;
      border: none;
      flex-shrink: 0;
    }

    .close-btn:hover {
      color: #e53935;
      background-color: #ffebee;
      transform: scale(1.1);
    }

    .overlay-image-container {
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
      overflow: auto;
    }

    .overlay-content img {
      max-width: 100%;
      max-height: calc(90vh - 120px);
      object-fit: contain;
      border-radius: 8px;
    }

    .overlay-nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .overlay-nav-arrow:hover:not(:disabled) {
      background-color: rgba(0, 0, 0, 0.7);
      transform: translateY(-50%) scale(1.1);
    }

    .overlay-nav-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .overlay-nav-arrow.left {
      left: 10px;
    }

    .overlay-nav-arrow.right {
      right: 10px;
    }

    .category-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
      justify-content: center;
    }

    .category-checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background-color: #e3f2fd;
      padding: 0.5rem 0.75rem;
      border-radius: 5px;
      font-size: 0.85rem;
      white-space: normal;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .category-checkbox-label:hover {
      background-color: #bbdefb;
    }

    .category-checkbox-input {
      width: 16px;
      height: 16px;
      margin: 0;
      flex-shrink: 0;
      cursor: pointer;
    }

    .id-search-group {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .id-search-group label {
      flex-basis: 100%;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .id-search-group .input-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
    }

    .id-search-group input[type="text"] {
      flex-grow: 0;
      max-width: 180px;
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      outline: none;
      font-size: 1rem;
      transition: border-color 0.2s ease, color 0.2s ease;
    }

    .id-search-group input[type="text"]:focus {
      border-color: #1e88e5;
    }

    .id-search-group input[type="text"].valid-id {
      border-color: #4CAF50;
      font-weight: bold;
      color: #4CAF50;
    }
    .id-search-group input[type="text"].invalid-id {
      border-color: #e53935;
      font-weight: bold;
      color: #e53935;
    }

    .clear-id-input-button {
      background-color: #e53935;
      color: white;
      border: none;
      border-radius: 8px;
      width: 48px;
      height: 48px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .clear-id-input-button:hover {
      background-color: #c62828;
    }

    .id-help-text {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
      flex-basis: 100%;
    }
    .id-help-text.error {
      color: #e53935;
      font-weight: bold;
    }

    .id-search-group button {
      padding: 0.75rem 1.5rem;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      min-height: 48px;
      flex-shrink: 0;
    }

    .id-search-group button:hover {
      background-color: #1565c0;
    }

    .fullscreen-nav-arrow {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3rem;
      color: #9e9e9e;
      cursor: pointer;
      z-index: 10002;
      display: none; /* Default: hidden */
      transition: opacity 0.3s ease;
      padding: 10px 20px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      opacity: 0; /* Default: hidden */
    }

    .fullscreen-nav-arrow:hover:not(:disabled) {
      background-color: rgba(0, 0, 0, 0.7);
      transform: translateX(-50%) scale(1.1);
    }

    .fullscreen-nav-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    #prevProblemArrow {
      top: 20px;
    }

    #nextProblemArrow {
      bottom: 20px;
    }

    #fullscreenProblemCounter {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 1.8rem;
      color: #9e9e9e;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 10px;
      z-index: 10002;
      display: none; /* Default: hidden */
      pointer-events: none;
      user-select: none;
      transition: opacity 0.3s ease;
      opacity: 0; /* Default: hidden */
    }

    #fullscreenTimer {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 10002;
      font-size: 1.8rem;
      color: #9e9e9e;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 10px;
      display: none; /* Default: hidden */
      user-select: none;
      transition: opacity 0.3s ease;
      opacity: 0; /* Default: hidden */
    }
    #fullscreenTimer.hidden {
      opacity: 0;
    }

    #fullscreenTimerControls {
      position: fixed;
      bottom: 20px;
      left: 150px;
      z-index: 10002;
      display: none; /* Default: hidden */
      opacity: 0; /* Default: hidden */
      transition: opacity 0.3s ease;
      display: flex;
      gap: 10px;
    }
    #fullscreenTimerControls.hidden {
      opacity: 0;
    }
    .timer-control-btn {
      background-color: rgba(255, 255, 255, 0.1);
      color: #9e9e9e;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 1.4rem;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
      min-width: 48px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .timer-control-btn:hover {
      background-color: rgba(0, 0, 0, 0.7);
      transform: scale(1.05);
    }

    #fullscreenAlertOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      color: #e0e0e0;
      font-size: 3rem;
      display: none;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 10005;
      pointer-events: none;
    }
    #fullscreenAlertOverlay.active {
      pointer-events: auto;
    }

    .category-summary-output {
      background: #263238;
      color: #e0e0e0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 2rem;
      padding: 1.5rem;
      font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      position: relative;
    }

    .category-summary-output h3 {
      color: #90a4ae;
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      text-align: center;
    }

    .category-summary-output pre {
      margin: 0;
      padding: 0;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
    }

    .copy-feedback {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 30px;
      font-size: 1rem;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      z-index: 20000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    #classificationStatus.all-classified {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    #classificationStatus.not-all-classified {
        background-color: #ffebee;
        color: #c62828;
    }


    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
        padding: 1rem 0.5rem;
        padding-top: calc(1rem + 5px);
      }

      .logo {
        max-width: 100px;
        order: -1;
      }

      h1 {
        font-size: 1.2rem;
        margin: 0.5rem 0;
        min-width: auto;
      }

      .search-link {
        width: 100%;
        max-width: 280px;
        margin-top: 0.5rem;
      }

      .projection-button {
        left: 10px;
        padding: 0.75rem 1rem;
        font-size: 1.2rem;
        min-width: 48px;
        min-height: 48px;
      }
      #exitFullscreenButton {
        top: 10px;
        right: 10px;
        left: auto;
        padding: 0.75rem 1rem;
        font-size: 1.2rem;
        min-width: 48px;
        min-height: 48px;
      }

      .container {
        margin: 0.5rem auto;
        padding: 0 0.5rem;
      }

      .filters-section {
        padding: 1rem;
      }

      .select-group {
        margin-bottom: 1rem;
      }

      select {
        font-size: 16px;
      }

      .range-input {
        justify-content: center;
        text-align: center;
      }

      .range-input input {
        width: 70px;
      }

      .problem {
        padding: 1rem;
      }

      .problem-number {
        font-size: 1.2rem;
        text-align: center;
      }

      .problem-id {
        text-align: center;
        font-size: 0.85rem;
      }

      .show-solution {
        width: 100%;
        max-width: none;
        margin-left: 0;
        margin-top: 1rem;
      }

      .problem.fullscreen-active {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .problem.fullscreen-active .problem-header-content {
        position: static;
        grid-column: 1;
        grid-row: 1;
        width: 100%;
        justify-content: flex-start;
        gap: 0.5rem;
        flex-direction: column;
        align-items: flex-start;
        padding-top: 40px;
      }

      .problem.fullscreen-active .show-solution {
        position: static;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        min-height: 36px;
      }

      .problem.fullscreen-active img {
        grid-column: 1;
        grid-row: 2;
      }

      .overlay {
        padding: 0.5rem;
      }

      .overlay-content {
        max-width: calc(98% - 100px);
        max-height: 98%;
      }

      .overlay-header {
        padding: 0.75rem;
      }

      .overlay-header h3 {
        font-size: 1rem;
        padding: 0 8px;
      }

      .close-btn {
        width: 36px;
        height: 36px;
        font-size: 1.3rem;
      }

      .overlay-image-container {
        padding: 0.5rem;
      }

      .overlay-content img {
        max-height: calc(90vh - 100px);
      }

      .overlay-nav-arrow {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
        top: 50%;
      }
      .overlay-nav-arrow.left {
        left: 5px;
      }
      .overlay-nav-arrow.right {
        right: 5px;
      }

      .id-search-group .input-wrapper {
        width: 100%;
        justify-content: space-between;
        gap: 0.5rem;
      }
      .id-search-group input[type="text"] {
        flex-grow: 1;
        max-width: none;
        min-width: 120px;
      }
      .clear-id-input-button {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
        flex-shrink: 0;
        flex-basis: 40px;
      }
      .id-search-group button {
        flex-basis: 100%;
      }

      .fullscreen-nav-arrow {
        font-size: 2.5rem;
        padding: 8px 15px;
      }
      #prevProblemArrow {
        top: 15px;
      }
      #nextProblemArrow {
        bottom: 15px;
      }

      #fullscreenProblemCounter {
        font-size: 1.4rem;
        bottom: 15px;
        right: 15px;
        padding: 8px 12px;
      }
      #fullscreenTimer {
        font-size: 1.4rem;
        bottom: 15px;
        left: 15px;
        padding: 8px 12px;
      }
      #fullscreenTimerControls {
        bottom: 15px;
        left: 120px;
        gap: 8px;
      }
      .timer-control-btn {
        font-size: 1.2rem;
        padding: 6px 10px;
        min-width: 40px;
        min-height: 40px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.1rem;
      }

      .problem-number {
        font-size: 1.1rem;
      }

      .range-input {
        flex-direction: column;
        gap: 0.75rem;
      }

      .range-input input {
        width: 100px;
      }

      .overlay-header {
        padding: 0.5rem;
      }

      .overlay-header h3 {
        padding: 0 5px;
      }

      .close-btn {
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
      }

      .overlay-nav-arrow {
        width: 35px;
        height: 35px;
        font-size: 1.3rem;
      }
      .overlay-content {
        max-width: calc(98% - 90px);
      }

      #fullscreenProblemCounter {
        font-size: 1.2rem;
        bottom: 10px;
        right: 10px;
        padding: 6px 10px;
      }
      #fullscreenTimer {
        font-size: 1.2rem;
        bottom: 10px;
        left: 10px;
        padding: 6px 10px;
      }
      #fullscreenTimerControls {
        bottom: 10px;
        left: 100px;
        gap: 6px;
      }
      .timer-control-btn {
        font-size: 1rem;
        padding: 5px 8px;
        min-width: 36px;
        min-height: 36px;
      }
    }

    @media (max-height: 500px) and (orientation: landscape) {
      .overlay-content img {
        max-height: calc(85vh - 80px);
      }
    }

    @media (hover: none) {
      button, .search-link, select {
        min-height: 48px;
      }
    }
  </style>
</head>
<body>
<div id="progressBar"></div>

<header>
  <a href="index.html" class="logo-link" title="Načíst stránku znovu">
    <img src="assets/logo.png" alt="Logo" class="logo">
  </a>
  <h1>Portál pro procvičování na maturitu z matematiky</h1>
  <a href="check.html" class="search-link" target="_blank">Vyhledávání podle ID</a>
</header>

<button class="projection-button" title="Zobrazit první viditelný příklad na celou obrazovku" onclick="toggleFullscreenForFirstVisibleProblem(event)">
  &#128421;
</button>
<button id="exitFullscreenButton" title="Ukončit režim celé obrazovky" onclick="exitFullscreen()">
  &#x2716;
</button>

<div class="container">
  <!-- NOVÉ: Sekce pro přišpendlené příklady -->
  <div id="pinnedSection">
    <h2>Přišpendlené příklady:</h2>
    <div id="pinnedIdList" title="Klikněte pro zkopírování výčtu do schránky"></div>
    <a href="#" id="pinnedShareLink" title="Klikněte pro zkopírování odkazu do schránky"></a>
    <div class="pinned-controls">
      <button class="delete-pinned-btn" onclick="clearPinnedList()">Smazat výčet</button>
    </div>
  </div>

  <div class="filters-section">
    <div class="select-group">
      <label for="topic">Vyberte téma:</label>
      <select id="topic" multiple size="6" onchange="loadProblems()">
        <option value="ciselne-obory-procenta">1. Číselné obory, procenta</option>
        <option value="algebraicke-vyrazy">2. Výrazy</option>
        <option value="rovnice-nerovnice-soustavy">3. Rovnice, nerovnice, soustavy</option>
        <option value="funkce">4. Funkce</option>
        <option value="posloupnosti">5. Posloupnosti</option>
        <option value="financni-matematika">6. Finanční matematika</option>
        <option value="planimetrie">7. Planimetrie</option>
        <option value="stereometrie">8. Stereometrie</option>
        <option value="analyticka-geometrie">9. Analytická geometrie</option>
        <option value="kombinatorika">10. Kombinatorika</option>
        <option value="pravdepodobnost">11. Pravděpodobnost</option>
        <option value="statistika">12. Statistika</option>
      </select>
    </div>

    <div class="select-group">
      <label for="series">Vyberte sérii:</label>
      <select id="series" multiple size="6" onchange="loadProblems()">
        <option value="25p">2025 - podzim</option>
        <option value="25j">2025 - jaro</option>
        <option value="24p">2024 - podzim</option>
        <option value="24j">2024 - jaro</option>
        <option value="23p">2023 - podzim</option>
        <option value="23j">2023 - jaro</option>
        <option value="22p">2022 - podzim</option>
        <option value="22j">2022 - jaro</option>
        <option value="21p">2021 - podzim</option>
        <option value="21jm">2021 - jaro mimořádné</option>
        <option value="21j">2021 - jaro</option>
        <option value="20p">2020 - podzim</option>
        <option value="20j">2020 - jaro</option>
        <option value="19p">2019 - podzim</option>
        <option value="19j">2019 - jaro</option>
        <option value="18p">2018 - podzim</option>
        <option value="18j">2018 - jaro</option>
        <option value="17p">2017 - podzim</option>
        <option value="17j">2017 - jaro</option>
        <option value="16p">2016 - podzim</option>
        <option value="16j">2016 - jaro</option>
        <option value="ilustr">ilustrační test</option>
        <option value="vzor">vzorové příklady</option>
	<!-- NÍŽE JSOU ROZŠIŘUJÍCÍ SADY -->
        <option value="x25p">2025 - podzim, rozš.</option>
        <option value="x25j">2025 - jaro, rozš.</option>
        <option value="x24p">2024 - podzim, rozš.</option>
        <option value="x24j">2024 - jaro, rozš.</option>
        <option value="x23p">2023 - podzim, rozš.</option>
        <option value="x23j">2023 - jaro, rozš.</option>
        <option value="x22j">2022 - jaro, rozš.</option>
        <option value="x21p">2021 - podzim, rozš.</option>
        <option value="x21j">2021 - jaro, rozš.</option>
        <option value="x20">2020 - jaro, rozš.</option>
        <option value="x19">2019 - jaro, rozš.</option>
        <option value="x18">2018 - jaro, rozš.</option>
        <option value="x17">2017 - jaro, rozš.</option>
        <option value="x16">2016 - jaro, rozš.</option>
        <option value="x15">2015 - jaro, rozš.</option>
        <option value="x14">2014 - jaro, rozš.</option>
        <option value="xilustr">ilustrační test, rozš.</option>
        <option value="xvzor">vzorové příklady, rozš.</option>
      </select>
    </div>

    <button class="go-to-problems-button" onclick="loadProblemsAndScroll()">Přejít na výpis příkladů</button>
    <!-- NOVÉ: Tlačítko Resetovat filtr -->
    <button class="reset-filters-button" onclick="resetFilters()">Resetovat filtr</button>

    <div id="problemCount">Počet příkladů: 0</div>

    <button class="toggle-advanced-filters" onclick="toggleAdvancedFilters()">Více možností filtrování</button>

    <div id="advancedFilters">
      <!-- NOVÉ: Zobrazení výčtu -->
      <div class="list-search-section">
        <label for="idListInput">Zobrazení výčtu (např. 24j/12, 20p/2):</label>
        <input type="text" id="idListInput" placeholder="Zadejte ID oddělená čárkou" oninput="loadFromIdList(this.value)" />
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="randomOrderCheckbox" onchange="loadProblems()">
        <label for="randomOrderCheckbox">Náhodné pořadí</label>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="developerModeCheckbox" onchange="toggleDeveloperMode()">
        <label for="developerModeCheckbox">Vývojářský mód</label>
      </div>
      <div class="range-section">
        <div class="range-input">
          <label for="rangeFrom">Vybrat rozsah od:</label>
          <input type="number" id="rangeFrom" placeholder="1" />
          <label for="rangeTo">do:</label>
          <input type="number" id="rangeTo" placeholder="10" />
          <button onclick="applyRange()">Potvrdit</button>
        </div>
      </div>
      <div class="id-search-group">
        <label for="problemIdInput">Zobrazení příkladu s konkrétním ID:</label>
        <div class="input-wrapper">
          <input type="text" id="problemIdInput" placeholder="např. 23j/8" />
          <button id="clearIdInputBtn" class="clear-id-input-button" title="Vyčistit ID vstup">&times;</button>
        </div>
        <div id="problemIdHelpText" class="id-help-text">Nápověda: Zadejte ID ve formátu "16j/12"</div>
        <button id="showProblemByIdBtn" onclick="showProblemById(true)">Zobrazit</button>
      </div>
      <button class="clear-filter" onclick="clearFilters()">Vyčistit filtr</button>
    </div>
  </div>

  <div id="problems"></div>

  <div id="classificationStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: bold; display: none;"></div>

  <div id="developerModeSummary" class="category-summary-output" style="display: none;">
    <h3>Souhrn kategorií příkladů:</h3>
    <pre id="categorySummaryContent"></pre>
    <button id="clearCategorySummaryBtn" class="clear-filter" style="margin-top: 1rem;">Smazat výpis</button>
    <button id="downloadCategorySummaryBtn" style="margin-top: 0.5rem; width: 100%; padding: 0.75rem 1.5rem; background-color: #1e88e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; min-height: 48px;">
      Stáhnout výpis jako .txt
    </button>
  </div>
</div>

<div class="copy-feedback" id="copyFeedback">Výčet vložen do schránky!</div>

<div class="overlay" id="overlay">
  <button class="overlay-nav-arrow left" id="prevBtn" title="Předchozí příklad">&larr;</button>
  <div class="overlay-content">
    <div class="overlay-header">
      <h3 id="overlayTitle">Řešení příkladu</h3>
      <button class="close-btn" id="closeBtn">&times;</button>
    </div>
    <div class="overlay-image-container">
      <img id="solutionImage" src="" alt="Řešení">
    </div>
  </div>
  <button class="overlay-nav-arrow right" id="nextBtn" title="Další příklad">&rarr;</button>
</div>

<div id="prevProblemArrow" class="fullscreen-nav-arrow" title="Předchozí příklad">&uarr;</div>
<div id="nextProblemArrow" class="fullscreen-nav-arrow" title="Další příklad">&darr;</div>
<div id="fullscreenProblemCounter"></div>
<div id="fullscreenTimer"></div>
<div id="fullscreenTimerControls">
  <button id="playPauseTimerBtn" class="timer-control-btn" title="Spustit/Pozastavit odpočet">&#9658;</button>
  <button id="resetTimerBtn" class="timer-control-btn" title="Resetovat odpočet">&#8635;</button>
</div>

<script src="tasks-data.js"></script>

<script>
  let masterProblemList = [];
  let currentDisplayedProblems = [];
  let pinnedProblems = new Set();

  let activeProblemElement = null;
  let lastScrollPosition = 0;

  let touchStartX = 0;
  let touchStartY = 0;

  let isDraggingOverlay = false;
  let overlayDragOffsetX, overlayDragOffsetY;
  const overlay = document.getElementById("overlay");
  const overlayContent = document.querySelector(".overlay-content");
  const overlayHeader = document.querySelector(".overlay-header");

  let fullscreenUIHideTimeout;
  const UI_HIDE_DELAY = 5000;

  let timerInterval;
  let timerSeconds = 8100;
  let timerRunning = false;
  let twoMinuteAlertShown = false;

  const fullscreenTimerElement = document.getElementById('fullscreenTimer');
  const fullscreenAlertOverlay = document.createElement('div');
  fullscreenAlertOverlay.id = 'fullscreenAlertOverlay';
  document.body.appendChild(fullscreenAlertOverlay);

  const playPauseTimerBtn = document.getElementById('playPauseTimerBtn');
  const resetTimerBtn = document.getElementById('resetTimerBtn');
  const fullscreenTimerControls = document.getElementById('fullscreenTimerControls');

  const PROBLEM_CATEGORIES = [
    "Číselné obory, procenta",
    "Výrazy",
    "Rovnice, nerovnice, soustavy",
    "Funkce",
    "Posloupnosti",
    "Finanční matematika",
    "Planimetrie",
    "Stereometrie",
    "Analytická geometrie",
    "Kombinatorika",
    "Pravděpodobnost",
    "Statistika"
  ];
  let developerModeActive = false;
  let problemCategoryData = {};
  const LOCAL_STORAGE_KEY = 'problemCategoryData';
  const PINNED_STORAGE_KEY = 'pinnedProblems';
  
  const developerModeCheckbox = document.getElementById('developerModeCheckbox');
  const developerModeSummary = document.getElementById('developerModeSummary');
  const categorySummaryContent = document.getElementById('categorySummaryContent');
  const copyFeedback = document.getElementById('copyFeedback');
  const clearCategorySummaryBtn = document.getElementById('clearCategorySummaryBtn');
  const downloadCategorySummaryBtn = document.getElementById('downloadCategorySummaryBtn');
  const classificationStatusDiv = document.getElementById('classificationStatus');
  const idListInput = document.getElementById('idListInput');
  const pinnedSection = document.getElementById('pinnedSection');
  const pinnedIdListDiv = document.getElementById('pinnedIdList');

  let currentProblemIndex = -1;

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function generateMasterProblemList() {
    const allPossibleProblems = new Set();
    for (const seriesKey in problemsCount) {
      for (let i = 1; i <= problemsCount[seriesKey]; i++) {
        allPossibleProblems.add(JSON.stringify({ series: seriesKey, num: i }));
      }
    }
    masterProblemList = Array.from(allPossibleProblems).map(item => JSON.parse(item));
  }

  // --- PINNING LOGIC ---

  function togglePin(series, num, event) {
    if (event) event.stopPropagation();
    const id = `${series}/${num}`;
    if (pinnedProblems.has(id)) {
      pinnedProblems.delete(id);
    } else {
      pinnedProblems.add(id);
    }
    localStorage.setItem(PINNED_STORAGE_KEY, JSON.stringify(Array.from(pinnedProblems)));
    updatePinnedUI();
    
    // Aktualizace vizuálu v seznamu
    const problemEls = document.querySelectorAll(`.problem[data-series="${series}"][data-num="${num}"]`);
    problemEls.forEach(el => {
      if (pinnedProblems.has(id)) el.classList.add('pinned');
      else el.classList.remove('pinned');
      const btn = el.querySelector('.pin-button');
      if (btn) btn.classList.toggle('active', pinnedProblems.has(id));
    });
  }

  function updatePinnedUI() {
    const pinnedShareLink = document.getElementById('pinnedShareLink');
    if (pinnedProblems.size > 0) {
      pinnedSection.style.display = 'block';
      const sortedIds = Array.from(pinnedProblems).sort();
      const idsString = sortedIds.join(', ');
      pinnedIdListDiv.textContent = idsString;

      const baseUrl = `${window.location.origin}${window.location.pathname}`;
      const shareableLink = `${baseUrl}?=${sortedIds.join(',')}`; // Using '?=' as requested
      
      pinnedShareLink.textContent = shareableLink;
      pinnedShareLink.href = shareableLink;
      pinnedShareLink.style.display = 'block'; // Show the link
    } else {
      pinnedSection.style.display = 'none';
      pinnedShareLink.style.display = 'none'; // Hide the link if no pinned problems
    }
  }

  function clearPinnedList() {
    if (confirm("Opravdu chcete smazat celý výčet přišpendlených příkladů?")) {
      pinnedProblems.clear();
      localStorage.removeItem(PINNED_STORAGE_KEY);
      updatePinnedUI();
      loadProblems();
    }
  }

  function copyPinnedToClipboard() {
    const text = pinnedIdListDiv.textContent;
    navigator.clipboard.writeText(text).then(() => {
      showCopyFeedback("Výčet vložen do schránky!");
    });
  }

  pinnedIdListDiv.addEventListener('click', copyPinnedToClipboard);

  function showCopyFeedback(message) {
    copyFeedback.textContent = message;
    copyFeedback.style.opacity = '1';
    setTimeout(() => {
      copyFeedback.style.opacity = '0';
    }, 2000);
  }

  // --- FILTERING LOGIC ---

  function resetFilters() {
    // Vyčistit selecty
    document.getElementById("series").selectedIndex = -1;
    document.getElementById("topic").selectedIndex = -1;
    // Vyčistit inputy
    document.getElementById("rangeFrom").value = '';
    document.getElementById("rangeTo").value = '';
    document.getElementById("problemIdInput").value = '';
    idListInput.value = '';
    // Vyčistit checkbox
    document.getElementById("randomOrderCheckbox").checked = false;
    
    loadProblems();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function loadFromIdList(input) {
    if (!input.trim()) {
      loadProblems();
      return;
    }

    const ids = input.split(',').map(s => s.trim().toLowerCase()).filter(s => s !== '');
    const filtered = [];
    
    ids.forEach(id => {
      const found = masterProblemList.find(p => `${p.series}/${p.num}` === id);
      if (found) filtered.push(found);
    });

    currentDisplayedProblems = filtered.map((p, i) => ({ ...p, displayIndex: i + 1 }));
    renderProblems();
  }

  function loadProblems() {
    const seriesSelect = document.getElementById("series");
    const topicSelect = document.getElementById("topic");
    const randomOrderCheckbox = document.getElementById("randomOrderCheckbox");

    const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
    const selectedTopics = Array.from(topicSelect.selectedOptions).map(option => option.value);

    let filteredProblems = [...masterProblemList];

    if (selectedSeries.length > 0) {
      filteredProblems = filteredProblems.filter(p => selectedSeries.includes(p.series));
    }

    if (selectedTopics.length > 0) {
      filteredProblems = filteredProblems.filter(p => {
        return selectedTopics.some(topicKey => {
          const topicMap = topics[topicKey];
          return topicMap[p.series] && topicMap[p.series].includes(p.num);
        });
      });
    }

    if (selectedSeries.length === 0 && selectedTopics.length === 0 && !idListInput.value) {
      currentDisplayedProblems = [];
      renderProblems();
      return;
    }

    filteredProblems.sort((a, b) => {
      if (a.series < b.series) return -1;
      if (a.series > b.series) return 1;
      return a.num - b.num;
    });

    if (randomOrderCheckbox.checked) {
      shuffleArray(filteredProblems);
    }

    currentDisplayedProblems = filteredProblems.map((problem, i) => ({
      ...problem,
      displayIndex: i + 1
    }));

    renderProblems();
  }

  function renderProblems() {
    const problemsDiv = document.getElementById("problems");
    const problemCountDiv = document.getElementById("problemCount");
    problemsDiv.innerHTML = '';

    currentDisplayedProblems.forEach(({ series, num, displayIndex }) => {
      const problemId = `${series}/${num}`;
      const problemDiv = document.createElement("div");
      problemDiv.className = `problem ${pinnedProblems.has(problemId) ? 'pinned' : ''}`;
      problemDiv.setAttribute('data-series', series);
      problemDiv.setAttribute('data-num', num);

      let categoryCheckboxesHtml = '';
      if (developerModeActive) {
        categoryCheckboxesHtml = `<div class="category-checkbox-group">`;
        PROBLEM_CATEGORIES.forEach(category => {
          const isChecked = problemCategoryData[problemId] && problemCategoryData[problemId].includes(category) ? 'checked' : '';
          const uniqueId = `cat-${series}-${num}-${category.replace(/\s/g, '-')}`;
          categoryCheckboxesHtml += `
            <label class="category-checkbox-label">
              <input type="checkbox" class="category-checkbox-input"
                data-series="${series}" data-num="${num}" data-category="${category}"
                id="${uniqueId}" ${isChecked}>
              ${category}
            </label>
          `;
        });
        categoryCheckboxesHtml += `</div>`;
      }

      problemDiv.innerHTML = `
        <div class="problem-header-content">
          <div class="problem-info-text">
            <div class="problem-number">Příklad ${displayIndex}</div>
            <div class="problem-id">ID: ${problemId}</div>
          </div>
          <div class="controls-row">
            <button class="show-solution" data-series="${series}" data-num="${num}">Zobrazit řešení</button>
            <button class="pin-button ${pinnedProblems.has(problemId) ? 'active' : ''}" 
                    onclick="togglePin('${series}', ${num}, event)" 
                    title="Přišpendlit příklad">&#128204;</button>
          </div>
          ${categoryCheckboxesHtml}
        </div>
        <img src="files/${series}/${num}.png" alt="Úloha ${num}" />
      `;
      problemsDiv.appendChild(problemDiv);

      if (developerModeActive) {
        problemDiv.querySelectorAll('.category-checkbox-input').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            handleCategoryCheckboxChange(series, num, e.target.dataset.category, e.target.checked);
          });
        });
      }
    });

    problemCountDiv.textContent = `Počet příkladů: ${currentDisplayedProblems.length}`;
    document.querySelectorAll('.problem .show-solution').forEach(button => {
      button.onclick = function(event) {
        event.stopPropagation();
        showSolution(this.dataset.series, parseInt(this.dataset.num));
      };
    });
    updateSolutionButtonState();
    updateCategorySummary();
    updateClassificationStatus();
  }

  function loadProblemsAndScroll() {
    loadProblems();
    const problemsDiv = document.getElementById("problems");
    if (problemsDiv.firstElementChild) {
      problemsDiv.firstElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  function applyRange() {
    const rangeFrom = parseInt(document.getElementById("rangeFrom").value);
    const rangeTo = parseInt(document.getElementById("rangeTo").value);
    
    if (isNaN(rangeFrom) || isNaN(rangeTo)) {
      alert("Prosím zadejte platná čísla pro rozsah.");
      return;
    }

    if (currentDisplayedProblems.length === 0) loadProblems();

    currentDisplayedProblems = currentDisplayedProblems.filter(p => 
      p.displayIndex >= rangeFrom && p.displayIndex <= rangeTo
    );

    renderProblems();
  }

  function showProblemById(autoScroll = false) {
    const inputId = document.getElementById("problemIdInput").value.trim().toLowerCase();
    if (!inputId) return;

    const found = masterProblemList.find(p => `${p.series}/${p.num}` === inputId);

    if (found) {
      currentDisplayedProblems = [{ ...found, displayIndex: 1 }];
      renderProblems();
      if (autoScroll) {
        document.getElementById("problems").firstElementChild?.scrollIntoView({ behavior: 'smooth' });
      }
    }
  }

  function clearFilters() {
    document.getElementById("problemIdInput").value = '';
    idListInput.value = '';
    resetFilters();
  }

  // --- OVERLAY & FULLSCREEN LOGIC ---

  function closeOverlay() {
    overlay.style.display = "none";
    overlay.style.left = '50%';
    overlay.style.top = '50%';
    overlay.style.transform = 'translate(-50%, -50%)';
  }

  function showSolution(series, num) {
    const solutionImage = document.getElementById("solutionImage");
    const overlayTitle = document.getElementById("overlayTitle");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    currentProblemIndex = currentDisplayedProblems.findIndex(p => p.series === series && p.num === num);

    if (currentProblemIndex === -1) return;

    solutionImage.src = `files/${series}/${num}_res.png`;
    overlayTitle.innerHTML = `Řešení <span class="problem-index-bold">příkladu ${currentDisplayedProblems[currentProblemIndex].displayIndex}</span> ID: ${series}/${num}`;
    overlay.style.display = "flex";

    prevBtn.disabled = currentProblemIndex <= 0;
    nextBtn.disabled = currentProblemIndex >= currentDisplayedProblems.length - 1;
  }

  function navigateSolution(direction) {
    let newIndex = currentProblemIndex;
    if (direction === 'prev') newIndex = Math.max(0, currentProblemIndex - 1);
    else if (direction === 'next') newIndex = Math.min(currentDisplayedProblems.length - 1, currentProblemIndex + 1);

    if (newIndex !== currentProblemIndex) {
      const problem = currentDisplayedProblems[newIndex];
      showSolution(problem.series, problem.num);
      
      if (document.fullscreenElement) {
        const el = document.querySelector(`.problem[data-series="${problem.series}"][data-num="${problem.num}"]`);
        if (el) prepareProblemForFullscreen(el);
      }
    }
  }

  document.getElementById("closeBtn").addEventListener("click", closeOverlay);
  document.getElementById("prevBtn").addEventListener("click", () => navigateSolution('prev'));
  document.getElementById("nextBtn").addEventListener("click", () => navigateSolution('next'));

  // MEZERNÍK LOGIC
  document.addEventListener("keydown", function(e) {
    const isOverlayOpen = overlay.style.display === "flex";
    const isFullscreen = !!document.fullscreenElement;

    // Mezerník ve fullscreenu
    if (e.code === "Space" && isFullscreen) {
      e.preventDefault();
      if (isOverlayOpen) {
        closeOverlay();
      } else if (activeProblemElement) {
        const series = activeProblemElement.dataset.series;
        const num = activeProblemElement.dataset.num;
        // Pokud není časovač zamknutý
        if (!timerRunning) {
          showSolution(series, parseInt(num));
        }
      }
      return;
    }

    if (e.key === "Escape") {
      if (isOverlayOpen) closeOverlay();
      else if (isFullscreen) exitFullscreen();
    } else if (isFullscreen && activeProblemElement) {
      if (isOverlayOpen) {
        if (e.key === "ArrowLeft") {
          e.preventDefault();
          navigateSolution('prev');
        } else if (e.key === "ArrowRight") {
          e.preventDefault();
          navigateSolution('next');
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          closeOverlay(); // Close solution first
          navigateToPrevProblemInFullscreen(); // Then navigate problem
        } else if (e.key === "ArrowDown") {
          e.preventDefault();
          closeOverlay(); // Close solution first
          navigateToNextProblemInFullscreen(); // Then navigate problem
        }
      } else { // Overlay is NOT open
        if (e.key === "ArrowDown") {
          e.preventDefault();
          navigateToNextProblemInFullscreen();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          navigateToPrevProblemInFullscreen();
        }
      }
      showFullscreenUIAndResetHideTimer();
    }
  });

  function prepareProblemForFullscreen(problemElement) {
    document.querySelectorAll('.problem').forEach(p => p.classList.add('hidden-for-fullscreen'));
    if (activeProblemElement) activeProblemElement.classList.remove('fullscreen-active');
    
    activeProblemElement = problemElement;
    activeProblemElement.classList.remove('hidden-for-fullscreen');
    activeProblemElement.classList.add('fullscreen-active');
    activeProblemElement.scrollTop = 0;

    showFullscreenUIAndResetHideTimer();
    updateProgressBar();
    updateSolutionButtonState();
  }

  function requestAndPrepareFullscreen(problemElement) {
    lastScrollPosition = window.scrollY;
    document.documentElement.requestFullscreen().then(() => {
      prepareProblemForFullscreen(problemElement);
    }).catch(err => {
      console.error(`Chyba při pokusu o přepnutí do režimu celé obrazovky: ${err.message}`);
      // Fallback: if fullscreen fails, still prepare the problem and show UI
      prepareProblemForFullscreen(problemElement);
      showFullscreenUI(); // Ensure UI is shown even if native fullscreen fails
    });
  }

  function toggleFullscreenForFirstVisibleProblem(event) {
    event.stopPropagation();
    if (document.fullscreenElement) { // If already in fullscreen, do nothing
      return;
    }
    const problems = Array.from(document.querySelectorAll('.problem'));
    let firstVisible = problems.find(p => p.getBoundingClientRect().top >= 0 && p.getBoundingClientRect().bottom > 0);
    if (firstVisible) requestAndPrepareFullscreen(firstVisible);
  }

  function exitFullscreen() {
    if (document.fullscreenElement) document.exitFullscreen();
  }

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      // Exiting fullscreen
      if (activeProblemElement) {
        activeProblemElement.classList.remove('fullscreen-active');
      }
      activeProblemElement = null;
      hideFullscreenUI(); // Hide all fullscreen UI elements and show projection button
      updateProgressBar();

      document.querySelectorAll('.problem').forEach(p => p.classList.remove('hidden-for-fullscreen'));

      window.scrollTo(0, lastScrollPosition);

      closeOverlay();
    } else {
      // Entering fullscreen
      // Ensure the active problem element is correctly set if fullscreen was triggered by something else
      if (document.fullscreenElement.classList.contains('problem') && document.fullscreenElement !== activeProblemElement) {
        prepareProblemForFullscreen(document.fullscreenElement);
      }
      showFullscreenUI(); // Show all fullscreen UI elements and hide projection button
    }
    updateSolutionButtonState();
  });

  // --- PROGRESS & UI ---

  function updateProgressBar() {
    const progressBar = document.getElementById("progressBar");
    const scrollTop = document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - window.innerHeight;
    
    if (document.fullscreenElement && activeProblemElement) {
      progressBar.style.opacity = '1';
      const pScroll = activeProblemElement.scrollTop;
      const pHeight = activeProblemElement.scrollHeight - activeProblemElement.clientHeight;
      progressBar.style.width = pHeight > 0 ? `${(pScroll / pHeight) * 100}%` : '100%';
    } else {
      progressBar.style.opacity = scrollTop > 200 ? '1' : '0';
      progressBar.style.width = `${(scrollTop / height) * 100}%`;
    }
  }

  function showFullscreenUI() {
    clearTimeout(fullscreenUIHideTimeout); // Clear any pending hide
    const nextArrow = document.getElementById('nextProblemArrow');
    const prevArrow = document.getElementById('prevProblemArrow');
    const problemCounter = document.getElementById('fullscreenProblemCounter');
    const exitButton = document.getElementById('exitFullscreenButton');
    const projectionButton = document.querySelector('.projection-button');
    const fullscreenTimerElementLocal = document.getElementById('fullscreenTimer');
    const fullscreenTimerControlsLocal = document.getElementById('fullscreenTimerControls');

    // Show fullscreen UI elements
    if (nextArrow) { nextArrow.style.display = 'flex'; nextArrow.style.opacity = '1'; }
    if (prevArrow) { prevArrow.style.display = 'flex'; prevArrow.style.opacity = '1'; }
    if (problemCounter) { updateFullscreenProblemCounter(); problemCounter.style.display = 'block'; problemCounter.style.opacity = '1'; }
    if (fullscreenTimerElementLocal) { fullscreenTimerElementLocal.style.display = 'block'; fullscreenTimerElementLocal.style.opacity = '1'; }
    if (fullscreenTimerControlsLocal) { fullscreenTimerControlsLocal.style.display = 'flex'; fullscreenTimerControlsLocal.style.opacity = '1'; }
    if (exitButton) { exitButton.style.display = 'flex'; exitButton.style.opacity = '1'; } // Ensure opacity is 1

    // Hide non-fullscreen UI elements
    if (projectionButton) { projectionButton.style.display = 'none'; }

    // Set disabled state for arrows
    const activeProblemSeries = activeProblemElement ? activeProblemElement.dataset.series : null;
    const activeProblemNum = activeProblemElement ? parseInt(activeProblemElement.dataset.num) : null;
    const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === activeProblemSeries && p.num === activeProblemNum);
    if (nextArrow) nextArrow.disabled = currentProblemDataIndex >= currentDisplayedProblems.length - 1;
    if (prevArrow) prevArrow.disabled = currentProblemDataIndex <= 0;

    hideFullscreenUIDelayed(); // Start timer to fade out
  }

  function hideFullscreenUI() {
    clearTimeout(fullscreenUIHideTimeout); // Clear any pending hide
    const nextArrow = document.getElementById('nextProblemArrow');
    const prevArrow = document.getElementById('prevProblemArrow');
    const problemCounter = document.getElementById('fullscreenProblemCounter');
    const exitButton = document.getElementById('exitFullscreenButton');
    const projectionButton = document.querySelector('.projection-button');
    const fullscreenTimerElementLocal = document.getElementById('fullscreenTimer');
    const fullscreenTimerControlsLocal = document.getElementById('fullscreenTimerControls');

    // Hide fullscreen UI elements immediately
    if (nextArrow) { nextArrow.style.display = 'none'; nextArrow.style.opacity = '0'; }
    if (prevArrow) { prevArrow.style.display = 'none'; prevArrow.style.opacity = '0'; }
    if (problemCounter) { problemCounter.style.display = 'none'; problemCounter.style.opacity = '0'; }
    if (fullscreenTimerElementLocal) { fullscreenTimerElementLocal.style.display = 'none'; fullscreenTimerElementLocal.style.opacity = '0'; }
    if (fullscreenTimerControlsLocal) { fullscreenTimerControlsLocal.style.display = 'none'; fullscreenTimerControlsLocal.style.opacity = '0'; }
    if (exitButton) { exitButton.style.display = 'none'; exitButton.style.opacity = '0'; }

    // Show non-fullscreen UI elements
    if (projectionButton) { projectionButton.style.display = 'flex'; }
  }

  function showFullscreenUIAndResetHideTimer() {
    clearTimeout(fullscreenUIHideTimeout);
    const prevArrow = document.getElementById('prevProblemArrow');
    const nextArrow = document.getElementById('nextProblemArrow');
    const problemCounter = document.getElementById('fullscreenProblemCounter');
    const fullscreenTimerElementLocal = document.getElementById('fullscreenTimer');
    const fullscreenTimerControlsLocal = document.getElementById('fullscreenTimerControls');
    const exitButton = document.getElementById('exitFullscreenButton');

    if (prevArrow) { prevArrow.style.display = 'flex'; prevArrow.style.opacity = '1'; }
    if (nextArrow) { nextArrow.style.display = 'flex'; nextArrow.style.opacity = '1'; }
    if (problemCounter) { 
      updateFullscreenProblemCounter();
      problemCounter.style.display = 'block'; 
      problemCounter.style.opacity = '1';
    }
    if (fullscreenTimerElementLocal) { fullscreenTimerElementLocal.style.display = 'block'; fullscreenTimerElementLocal.style.opacity = '1'; }
    if (fullscreenTimerControlsLocal) { fullscreenTimerControlsLocal.style.display = 'flex'; fullscreenTimerControlsLocal.style.opacity = '1'; }
    if (exitButton) { exitButton.style.display = 'flex'; exitButton.style.opacity = '1'; }

    // Set disabled state for arrows
    const activeProblemSeries = activeProblemElement ? activeProblemElement.dataset.series : null;
    const activeProblemNum = activeProblemElement ? parseInt(activeProblemElement.dataset.num) : null;
    const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === activeProblemSeries && p.num === activeProblemNum);
    if (nextArrow) nextArrow.disabled = currentProblemDataIndex >= currentDisplayedProblems.length - 1;
    if (prevArrow) prevArrow.disabled = currentProblemDataIndex <= 0;

    hideFullscreenUIDelayed();
  }

  function hideFullscreenUIDelayed() {
    clearTimeout(fullscreenUIHideTimeout);
    fullscreenUIHideTimeout = setTimeout(() => {
      const prevArrow = document.getElementById('prevProblemArrow');
      const nextArrow = document.getElementById('nextProblemArrow');
      const problemCounter = document.getElementById('fullscreenProblemCounter');
      const fullscreenTimerElementLocal = document.getElementById('fullscreenTimer');
      const fullscreenTimerControlsLocal = document.getElementById('fullscreenTimerControls');
      const exitButton = document.getElementById('exitFullscreenButton');

      if (prevArrow) prevArrow.style.opacity = '0';
      if (nextArrow) nextArrow.style.opacity = '0';
      if (problemCounter) problemCounter.style.opacity = '0';
      if (fullscreenTimerElementLocal) fullscreenTimerElementLocal.style.opacity = '0';
      if (fullscreenTimerControlsLocal) fullscreenTimerControlsLocal.style.opacity = '0';
      if (exitButton) exitButton.style.opacity = '0';
    }, UI_HIDE_DELAY);
  }

  function navigateToNextProblemInFullscreen() {
    if (!activeProblemElement || !document.fullscreenElement || currentDisplayedProblems.length === 0) {
      return;
    }
    const idx = currentDisplayedProblems.findIndex(p => p.series === activeProblemElement.dataset.series && p.num == activeProblemElement.dataset.num);
    if (idx < currentDisplayedProblems.length - 1) {
      const next = currentDisplayedProblems[idx + 1];
      const el = document.querySelector(`.problem[data-series="${next.series}"][data-num="${next.num}"]`);
      if (el) {
        const wasOverlayOpen = overlay.style.display === 'flex';
        prepareProblemForFullscreen(el);
        if (wasOverlayOpen) {
          showSolution(next.series, next.num);
        }
      }
    }
  }

  function navigateToPrevProblemInFullscreen() {
    if (!activeProblemElement || !document.fullscreenElement || currentDisplayedProblems.length === 0) {
      return;
    }
    const idx = currentDisplayedProblems.findIndex(p => p.series === activeProblemElement.dataset.series && p.num == activeProblemElement.dataset.num);
    if (idx > 0) {
      const prev = currentDisplayedProblems[idx - 1];
      const el = document.querySelector(`.problem[data-series="${prev.series}"][data-num="${prev.num}"]`);
      if (el) {
        const wasOverlayOpen = overlay.style.display === 'flex';
        prepareProblemForFullscreen(el);
        if (wasOverlayOpen) {
          showSolution(prev.series, prev.num);
        }
      }
    }
  }

  function updateFullscreenProblemCounter() {
    const problemCounter = document.getElementById('fullscreenProblemCounter');
    if (!document.fullscreenElement || !activeProblemElement || !problemCounter) {
      return;
    }
    const activeProblemSeries = activeProblemElement.dataset.series;
    const activeProblemNum = parseInt(activeProblemElement.dataset.num, 10);
    const currentProblemData = currentDisplayedProblems.find(p =>
      p.series === activeProblemSeries && p.num === activeProblemNum
    );
    if (currentProblemData) {
      problemCounter.textContent = `${currentProblemData.displayIndex}/${currentDisplayedProblems.length}`;
    } else {
      problemCounter.textContent = `?/${currentDisplayedProblems.length}`;
    }
  }

  // --- TIMER & DEV MODE ---

  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
  }

  function updateTimerDisplay() {
    fullscreenTimerElement.textContent = formatTime(timerSeconds);
  }

  function toggleTimer() {
    timerRunning = !timerRunning;
    playPauseTimerBtn.innerHTML = timerRunning ? '&#10074;&#10074;' : '&#9658;';
    if (timerRunning) {
      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();
        if (timerSeconds <= 0) clearInterval(timerInterval);
      }, 1000);
    } else {
      clearInterval(timerInterval);
    }
    updateSolutionButtonState();
  }

  function updateSolutionButtonState() {
    document.querySelectorAll('.problem .show-solution').forEach(btn => {
      if (timerRunning && btn.closest('.fullscreen-active')) {
        btn.classList.add('locked');
        btn.disabled = true;
      } else {
        btn.classList.remove('locked');
        btn.disabled = false;
      }
    });
  }

  function toggleDeveloperMode() {
    developerModeActive = developerModeCheckbox.checked;
    localStorage.setItem('developerModeActive', developerModeActive);
    renderProblems();
  }

  function handleCategoryCheckboxChange(series, num, category, isChecked) {
    const id = `${series}/${num}`;
    if (!problemCategoryData[id]) problemCategoryData[id] = [];
    if (isChecked) {
      if (!problemCategoryData[id].includes(category)) problemCategoryData[id].push(category);
    } else {
      problemCategoryData[id] = problemCategoryData[id].filter(c => c !== category);
    }
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(problemCategoryData));
    updateCategorySummary();
    updateClassificationStatus();
  }

  function updateCategorySummary() {
    if (!developerModeActive) {
      developerModeSummary.style.display = 'none';
      return;
    }
    developerModeSummary.style.display = 'block';
    let text = "";
    PROBLEM_CATEGORIES.forEach(cat => {
      for (let series in problemsCount) {
        const nums = [];
        for (let id in problemCategoryData) {
          if (id.startsWith(series + "/") && problemCategoryData[id].includes(cat)) {
            nums.push(id.split("/")[1]);
          }
        }
        if (nums.length > 0) {
          text += `"${series}": [${nums.sort((a,b)=>a-b).join(",")}] //${cat}\n`;
        }
      }
    });
    categorySummaryContent.textContent = text || "Žádná data";
  }

  function updateClassificationStatus() {
    if (!developerModeActive || currentDisplayedProblems.length === 0) {
      classificationStatusDiv.style.display = 'none';
      return;
    }
    const unclassified = currentDisplayedProblems.filter(p => !problemCategoryData[`${p.series}/${p.num}`] || problemCategoryData[`${p.series}/${p.num}`].length === 0);
    classificationStatusDiv.style.display = 'block';
    if (unclassified.length === 0) {
      classificationStatusDiv.className = 'all-classified';
      classificationStatusDiv.textContent = 'Všechny příklady jsou zatříděny.';
    } else {
      classificationStatusDiv.className = 'not-all-classified';
      classificationStatusDiv.textContent = `Nezatříděno: ${unclassified.map(u => u.displayIndex).join(', ')}`;
    }
  }

  function toggleAdvancedFilters() {
    const adv = document.getElementById("advancedFilters");
    adv.style.display = adv.style.display === "block" ? "none" : "block";
  }

  // --- INIT ---

  document.addEventListener('DOMContentLoaded', () => {
    generateMasterProblemList();
    
    // Načíst špendlíky
    const storedPinned = localStorage.getItem(PINNED_STORAGE_KEY);
    if (storedPinned) pinnedProblems = new Set(JSON.parse(storedPinned));
    updatePinnedUI();

    // Načíst dev data
    const storedDev = localStorage.getItem(LOCAL_STORAGE_KEY);
    if (storedDev) problemCategoryData = JSON.parse(storedDev);
    developerModeActive = localStorage.getItem('developerModeActive') === 'true';
    developerModeCheckbox.checked = developerModeActive;

    window.addEventListener('scroll', updateProgressBar);
    window.addEventListener('resize', updateProjectionButtonPosition); // Ensure button position updates on resize
    
    document.getElementById('playPauseTimerBtn').onclick = toggleTimer;
    document.getElementById('resetTimerBtn').onclick = () => {
      timerSeconds = 8100;
      updateTimerDisplay(); // Update display after reset
      updateSolutionButtonState(); // Update button state after reset
    };

    // Add click listeners for fullscreen navigation arrows
    const nextProblemArrow = document.getElementById('nextProblemArrow');
    if (nextProblemArrow) {
      nextProblemArrow.addEventListener('click', () => {
        navigateToNextProblemInFullscreen();
        showFullscreenUIAndResetHideTimer(); 
      });
    }
    const prevProblemArrow = document.getElementById('prevProblemArrow');
    if (prevProblemArrow) {
      prevProblemArrow.addEventListener('click', () => {
        navigateToPrevProblemInFullscreen();
        showFullscreenUIAndResetHideTimer(); 
      });
    }

    // --- URL PARAMETER LOADING LOGIC ---
    const urlSearch = window.location.search;
    let idsFromUrl = null;

    if (urlSearch.startsWith('?=')) {
      idsFromUrl = urlSearch.substring(2); // Get string after '?='
    }

    if (idsFromUrl && idsFromUrl.trim() !== '') {
      const ids = idsFromUrl.split(',').map(s => s.trim().toLowerCase()).filter(s => s !== '');
      const filtered = [];
      ids.forEach(id => {
        const found = masterProblemList.find(p => `${p.series}/${p.num}` === id);
        if (found) filtered.push(found);
      });
      currentDisplayedProblems = filtered.map((p, i) => ({ ...p, displayIndex: i + 1 }));
      renderProblems();
      idListInput.value = idsFromUrl; // Pre-fill the input field with URL IDs
      // Clear other filters to reflect that URL is dominant
      document.getElementById("series").selectedIndex = -1;
      document.getElementById("topic").selectedIndex = -1;
      document.getElementById("rangeFrom").value = '';
      document.getElementById("rangeTo").value = '';
      document.getElementById("problemIdInput").value = '';
      document.getElementById("randomOrderCheckbox").checked = false;

      // NEW: Scroll to the first problem if loaded from URL
      const problemsDiv = document.getElementById("problems");
      if (problemsDiv.firstElementChild) {
        problemsDiv.firstElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

    } else {
      // Normal loading if no URL parameter
      loadProblems();
    }

    updateProjectionButtonPosition();
    updateTimerDisplay();
    updateSolutionButtonState();
    updateCategorySummary();
    updateClassificationStatus();
    hideFullscreenUI(); // Ensure fullscreen UI is hidden initially
  });

  // Dragging overlay logic (from previous version, ensuring it's still present and correct)
  overlayHeader.addEventListener('mousedown', (e) => {
    if (e.button === 0) {
      isDraggingOverlay = true;
      const rect = overlay.getBoundingClientRect();
      overlayDragOffsetX = e.clientX - rect.left;
      overlayDragOffsetY = e.clientY - rect.top;
      overlayHeader.style.cursor = 'grabbing';
      overlay.style.transition = 'none';
      overlay.style.width = `${rect.width}px`;
      overlay.style.height = `${rect.height}px`;
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (isDraggingOverlay) {
      e.preventDefault();
      overlay.style.left = `${e.clientX - overlayDragOffsetX}px`;
      overlay.style.top = `${e.clientY - overlayDragOffsetY}px`;
      overlay.style.transform = 'none';
    } else if (document.fullscreenElement && activeProblemElement) { // Mouse movement for fullscreen UI visibility
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      const mouseY = e.clientY;
      const mouseX = e.clientX;
      const activationZone = 100;

      if (mouseY < activationZone || mouseY > viewportHeight - activationZone ||
          mouseX < activationZone || mouseX > viewportWidth - activationZone) {
        showFullscreenUIAndResetHideTimer();
      } else {
        hideFullscreenUIDelayed();
      }
    }
  });

  document.addEventListener('mouseup', () => {
    if (isDraggingOverlay) {
      isDraggingOverlay = false;
      overlayHeader.style.cursor = 'grab';
      overlay.style.transition = '';
      overlay.style.width = '';
      overlay.style.height = '';
    }
  });
  overlayHeader.style.cursor = 'grab'; // Ensure initial grab cursor

  // Ensure projection button position is updated on scroll and resize
  function updateProjectionButtonPosition() {
    const projectionButton = document.querySelector('.projection-button');
    const header = document.querySelector('header');
    if (projectionButton && header) {
      const headerBottom = header.getBoundingClientRect().bottom;
      const newTop = Math.max(20, headerBottom + 10);
      projectionButton.style.top = `${newTop}px`;
    }
  }

  // Initial call to set position
  updateProjectionButtonPosition();

  // Event listeners for input validation and clearing
  document.getElementById("rangeFrom").addEventListener("focus", function() {
    this.value = '';
  });
  document.getElementById("rangeTo").addEventListener("focus", function() {
    this.value = '';
  });

  document.getElementById("rangeFrom").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      applyRange();
    }
  });
  document.getElementById("rangeTo").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      applyRange();
    }
  });

  const problemIdInput = document.getElementById("problemIdInput");
  const problemIdHelpText = document.getElementById("problemIdHelpText");
  const clearIdInputBtn = document.getElementById("clearIdInputBtn");

  function validateProblemId() {
    const inputId = problemIdInput.value.trim();
    problemIdInput.classList.remove('valid-id', 'invalid-id');
    problemIdHelpText.classList.remove('error');
    problemIdHelpText.textContent = 'Nápověda: Zadejte ID ve formátu "16j/12"';

    if (inputId === '') {
      currentDisplayedProblems = [];
      document.getElementById("problems").innerHTML = '';
      document.getElementById("problemCount").textContent = `Počet příkladů: 0`;
      updateCategorySummary();
      updateClassificationStatus();
      return;
    }

    const exactMatch = masterProblemList.find(p => `${p.series}/${p.num}` === inputId);
    const prefixMatch = masterProblemList.some(p => `${p.series}/${p.num}`.startsWith(inputId));

    if (exactMatch) {
      problemIdInput.classList.add('valid-id');
      showProblemById(true);
    } else if (prefixMatch) {
      // Do nothing, allow partial input
    }
    else {
      problemIdInput.classList.add('invalid-id');
      problemIdHelpText.textContent = 'Neexistující ID';
      problemIdHelpText.classList.add('error');
      currentDisplayedProblems = [];
      document.getElementById("problems").innerHTML = '';
      document.getElementById("problemCount").textContent = `Počet příkladů: 0`;
    }
    updateCategorySummary();
    updateClassificationStatus();
  }

  function clearProblemIdInput() {
    problemIdInput.value = '';
    validateProblemId();
  }

  problemIdInput.addEventListener('input', validateProblemId);
  problemIdInput.addEventListener('keydown', function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      showProblemById(true);
    }
  });
  clearIdInputBtn.addEventListener('click', clearProblemIdInput);

  // Touch event listeners for fullscreen UI (from previous version)
  document.addEventListener('touchstart', function(e) {
    if (document.fullscreenElement && activeProblemElement && e.touches.length === 1) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }
  }, { passive: true });

  document.addEventListener('touchend', function(e) {
    if (document.fullscreenElement && activeProblemElement) {
      showFullscreenUIAndResetHideTimer();
    }
  });

  // Event listener for copying the shareable link
  const pinnedShareLink = document.getElementById('pinnedShareLink');
  if (pinnedShareLink) {
    pinnedShareLink.addEventListener('click', (e) => {
      e.preventDefault(); // Prevent navigation
      const textToCopy = pinnedShareLink.textContent;
      navigator.clipboard.writeText(textToCopy).then(() => {
        showCopyFeedback("Odkaz zkopírován do schránky!");
      }).catch(err => {
        console.error('Nepodařilo se zkopírovat odkaz:', err);
      });
    });
  }

</script>
</body>
</html>
