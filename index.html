<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portál pro procvičování na maturitu z matematiky</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 0;
      line-height: 1.4;
    }

    /* Progress Bar Styling */
    #progressBar {
      position: fixed;
      top: 0;
      left: 0;
      height: 5px; /* Výška progress baru */
      background-color: #1565c0; /* Tmavší odstín modré */
      width: 0%; /* Počáteční šířka */
      z-index: 10000; /* Zajistí, že bude nad všemi ostatními prvky */
      transition: width 0.1s ease-out, opacity 0.3s ease-in-out; /* Plynulá animace šířky a průhlednosti */
      opacity: 0; /* Skryto na začátku */
    }

    header {
      background-color: #1e88e5;
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      flex-wrap: wrap;
      gap: 1rem;
      padding-top: calc(1rem + 5px); /* 1rem + výška progress baru */
      position: relative;
    }

    .logo-link {
      display: flex;
      align-items: center;
      flex-shrink: 0;
      text-decoration: none;
    }

    .logo {
      max-width: 60px;
      height: auto;
      flex-shrink: 0;
    }

    h1 {
      margin: 0;
      flex-grow: 1;
      font-size: 1.5rem;
      min-width: 200px;
    }

    .search-link {
      color: white;
      text-decoration: none;
      background-color: #1565c0;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      transition: background-color 0.2s ease;
      white-space: nowrap;
      font-size: 0.9rem;
      text-align: center;
      min-width: 160px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-link:hover {
      background-color: #0d47a1;
    }

    .projection-button {
      position: fixed;
      left: 20px;
      z-index: 10001;
      background-color: #607d8b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 48px;
      min-height: 48px;
    }

    .projection-button:hover {
      background-color: #455a64;
    }

    #exitFullscreenButton {
      position: fixed;
      top: 1rem;
      right: 1rem;
      left: auto;
      z-index: 10003;
      background-color: #ef5350;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background-color 0.2s ease, opacity 0.2s ease;
      display: none;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      min-height: 32px;
      opacity: 0.6;
    }

    #exitFullscreenButton:hover {
      background-color: #e53935;
      opacity: 1;
    }

    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 0 1rem;
    }

    .filters-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .select-group {
      margin-bottom: 1.5rem;
    }

    .select-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #333;
    }

    select {
      width: 100%;
      font-size: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      outline: none;
      background-color: white;
      transition: border-color 0.2s ease;
    }

    select:focus {
      border-color: #1e88e5;
    }

    #problemCount {
      font-weight: 600;
      color: #1e88e5;
      font-size: 1.1rem;
      margin: 1rem 0;
      text-align: center;
      padding: 0.5rem;
      background-color: #e3f2fd;
      border-radius: 8px;
    }

    .toggle-advanced-filters,
    .go-to-problems-button {
      display: block;
      width: 100%;
      padding: 0.75rem 1.5rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      margin-bottom: 1rem;
      min-height: 48px;
    }

    .toggle-advanced-filters {
      background-color: #607d8b;
    }

    .toggle-advanced-filters:hover {
      background-color: #455a64;
    }

    .go-to-problems-button {
      background-color: #4CAF50;
    }

    .go-to-problems-button:hover {
      background-color: #45a049;
    }

    #advancedFilters {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .range-section {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .range-input {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .range-input label {
      font-weight: 500;
      white-space: nowrap;
    }

    .range-input input {
      padding: 0.75rem;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      outline: none;
      width: 80px;
      text-align: center;
      font-size: 1rem;
    }

    .range-input input:focus {
      border-color: #1e88e5;
    }

    .range-input button,
    .clear-filter {
      padding: 0.75rem 1.5rem;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      min-height: 48px;
    }

    .range-input button:hover,
    .clear-filter:hover {
      background-color: #1565c0;
    }

    .clear-filter {
      background-color: #e53935;
      width: 100%;
      margin-top: 1rem;
    }

    .clear-filter:hover {
      background-color: #c62828;
    }

    .problem {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      padding: 1.5rem;
      text-align: center;
      position: relative;
      display: block;
    }

    .problem img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .problem.fullscreen-active {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      z-index: 9999;
      background: white;
      padding: 1rem;
      border-radius: 0;
      box-shadow: none;
      margin-bottom: 0;
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
      align-items: start;
      gap: 1rem;

      /* NOVÉ: Skrytí scrollbaru */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    /* NOVÉ: Skrytí scrollbaru pro WebKit prohlížeče (Chrome, Safari) */
    .problem.fullscreen-active::-webkit-scrollbar {
        display: none;
    }

    .problem.fullscreen-active img {
      grid-column: 1;
      grid-row: 2;
      width: auto;
      height: auto;
      margin: 0 auto;
      touch-action: pan-x pan-y pinch-zoom;
      cursor: grab;
    }

    .problem-header-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
      margin-bottom: 0;
      gap: 0.5rem;
      grid-column: 1;
      grid-row: 1;
      padding-top: 1rem;
    }

    .problem-info-text {
      text-align: left;
      flex-grow: 0;
      width: 100%;
      order: 1;
    }

    .problem.fullscreen-active .problem-number,
    .problem.fullscreen-active .problem-id {
      text-align: left;
      margin: 0;
    }

    .problem.fullscreen-active .show-solution {
      order: 2;
      position: static;
      margin-top: 0;
      width: auto;
      max-width: none;
      align-self: flex-start;
      flex-shrink: 0;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      min-height: 40px;
    }

    .problem.hidden-for-fullscreen {
      display: none !important;
    }

    .problem-number {
      font-weight: bold;
      font-size: 1.3rem;
      color: #1e88e5;
      text-align: left;
      margin-bottom: 0.5rem;
    }

    .problem-id {
      font-size: 0.9rem;
      color: #666;
      text-align: left;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .show-solution {
      display: inline-block;
      margin-top: 0;
      padding: 1rem 2rem;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      min-height: 48px;
      width: 100%;
      max-width: 300px;
    }

    .show-solution:hover {
      background-color: #1565c0;
    }

    .problem.fullscreen-active .show-solution.locked {
      background-color: #9e9e9e;
      cursor: not-allowed;
      opacity: 0.7;
      position: relative;
      padding-left: 2.5rem;
    }
    .problem.fullscreen-active .show-solution.locked::before {
      content: '\1F512';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2em;
    }
    .problem.fullscreen-active .show-solution.locked:hover {
      background-color: #9e9e9e;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 10004;
      padding: 1rem;
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      cursor: default;
      transition: all 0.2s ease;
    }

    .overlay-content {
      background: white;
      border-radius: 10px;
      padding: 0;
      max-width: 100%;
      max-height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background-color: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      cursor: grab;
    }

    .overlay-header h3 {
      margin: 0;
      color: #333;
      font-size: 1.1rem;
      flex-grow: 1;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 10px;
      font-weight: normal;
    }

    .overlay-header h3 .problem-index-bold {
      font-weight: bold;
    }

    .close-btn {
      cursor: pointer;
      color: #666;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: #e0e0e0;
      font-size: 1.5rem;
      transition: all 0.2s ease;
      border: none;
      flex-shrink: 0;
    }

    .close-btn:hover {
      color: #e53935;
      background-color: #ffebee;
      transform: scale(1.1);
    }

    .overlay-image-container {
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
      overflow: auto;
    }

    .overlay-content img {
      max-width: 100%;
      max-height: calc(90vh - 120px);
      object-fit: contain;
      border-radius: 8px;
    }

    .overlay-nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .overlay-nav-arrow:hover:not(:disabled) {
      background-color: rgba(0, 0, 0, 0.7);
      transform: translateY(-50%) scale(1.1);
    }

    .overlay-nav-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .overlay-nav-arrow.left {
      left: 10px;
    }

    .overlay-nav-arrow.right {
      right: 10px;
    }

    .checkbox-group {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 0;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      flex-shrink: 0;
      cursor: pointer;
    }

    .checkbox-group label {
      margin: 0;
      font-weight: 500;
      color: #333;
      cursor: pointer;
    }

    .id-search-group {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    .id-search-group label {
      flex-basis: 100%;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .id-search-group .input-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
    }

    .id-search-group input[type="text"] {
      flex-grow: 0;
      max-width: 180px;
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      outline: none;
      font-size: 1rem;
      transition: border-color 0.2s ease, color 0.2s ease;
    }

    .id-search-group input[type="text"]:focus {
      border-color: #1e88e5;
    }

    .id-search-group input[type="text"].valid-id {
      border-color: #4CAF50;
      font-weight: bold;
      color: #4CAF50;
    }
    .id-search-group input[type="text"].invalid-id {
      border-color: #e53935;
      font-weight: bold;
      color: #e53935;
    }

    .clear-id-input-button {
      background-color: #e53935;
      color: white;
      border: none;
      border-radius: 8px;
      width: 48px;
      height: 48px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .clear-id-input-button:hover {
      background-color: #c62828;
    }

    .id-help-text {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
      flex-basis: 100%;
    }
    .id-help-text.error {
      color: #e53935;
      font-weight: bold;
    }

    .id-search-group button {
      padding: 0.75rem 1.5rem;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      min-height: 48px;
      flex-shrink: 0;
    }

    .id-search-group button:hover {
      background-color: #1565c0;
    }

    .fullscreen-nav-arrow {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3rem;
      color: #9e9e9e;
      cursor: pointer;
      z-index: 10002;
      display: none;
      transition: opacity 0.3s ease;
      padding: 10px 20px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      opacity: 1;
    }

    .fullscreen-nav-arrow:hover:not(:disabled) {
      background-color: rgba(0, 0, 0, 0.7);
      transform: translateX(-50%) scale(1.1);
    }

    .fullscreen-nav-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    #prevProblemArrow {
      top: 20px;
    }

    #nextProblemArrow {
      bottom: 20px;
    }

    #fullscreenProblemCounter {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 1.8rem;
      color: #9e9e9e;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 10px;
      z-index: 10002;
      display: none;
      pointer-events: none;
      user-select: none;
      transition: opacity 0.3s ease;
    }

    #fullscreenTimer {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 10002;
      font-size: 1.8rem;
      color: #9e9e9e;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 10px;
      display: none;
      user-select: none;
      transition: opacity 0.3s ease;
      opacity: 1;
    }
    #fullscreenTimer.hidden {
      opacity: 0;
    }

    #fullscreenTimerControls {
      position: fixed;
      bottom: 20px;
      left: 150px;
      z-index: 10002;
      display: none;
      opacity: 1;
      transition: opacity 0.3s ease;
      display: flex;
      gap: 10px;
    }
    #fullscreenTimerControls.hidden {
      opacity: 0;
    }
    .timer-control-btn {
      background-color: rgba(255, 255, 255, 0.1);
      color: #9e9e9e;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 1.4rem;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
      min-width: 48px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .timer-control-btn:hover {
      background-color: rgba(0, 0, 0, 0.7);
      transform: scale(1.05);
    }

    #fullscreenAlertOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      color: #e0e0e0;
      font-size: 3rem;
      display: none;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 10005;
      pointer-events: none;
    }
    #fullscreenAlertOverlay.active {
      pointer-events: auto;
    }

    .category-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
      justify-content: center;
    }

    .category-checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background-color: #e3f2fd;
      padding: 0.5rem 0.75rem;
      border-radius: 5px;
      font-size: 0.85rem;
      white-space: normal;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .category-checkbox-label:hover {
      background-color: #bbdefb;
    }

    .category-checkbox-input {
      width: 16px;
      height: 16px;
      margin: 0;
      flex-shrink: 0;
      cursor: pointer;
    }

    .category-summary-output {
      background: #263238;
      color: #e0e0e0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 2rem;
      padding: 1.5rem;
      font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      position: relative;
    }

    .category-summary-output h3 {
      color: #90a4ae;
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      text-align: center;
    }

    .category-summary-output pre {
      margin: 0;
      padding: 0;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
    }

    .copy-feedback {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: #4CAF50;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
    }

    /* Styles for classification status message */
    #classificationStatus.all-classified {
        background-color: #e8f5e9; /* Light green */
        color: #2e7d32; /* Dark green */
    }
    #classificationStatus.not-all-classified {
        background-color: #ffebee; /* Light red */
        color: #c62828; /* Dark red */
    }


    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
        padding: 1rem 0.5rem;
        padding-top: calc(1rem + 5px);
      }

      .logo {
        max-width: 100px;
        order: -1;
      }

      h1 {
        font-size: 1.2rem;
        margin: 0.5rem 0;
        min-width: auto;
      }

      .search-link {
        width: 100%;
        max-width: 280px;
        margin-top: 0.5rem;
      }

      .projection-button {
        left: 10px;
        padding: 0.75rem 1rem;
        font-size: 1.2rem;
        min-width: 48px;
        min-height: 48px;
      }
      #exitFullscreenButton {
        top: 10px;
        right: 10px;
        left: auto;
        padding: 0.75rem 1rem;
        font-size: 1.2rem;
        min-width: 48px;
        min-height: 48px;
      }

      .container {
        margin: 0.5rem auto;
        padding: 0 0.5rem;
      }

      .filters-section {
        padding: 1rem;
      }

      .select-group {
        margin-bottom: 1rem;
      }

      select {
        font-size: 16px;
      }

      .range-input {
        justify-content: center;
        text-align: center;
      }

      .range-input input {
        width: 70px;
      }

      .problem {
        padding: 1rem;
      }

      .problem-number {
        font-size: 1.2rem;
        text-align: center;
      }

      .problem-id {
        text-align: center;
        font-size: 0.85rem;
      }

      .show-solution {
        width: 100%;
        max-width: none;
        margin-left: 0;
        margin-top: 1rem;
      }

      .problem.fullscreen-active {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .problem.fullscreen-active .problem-header-content {
        position: static;
        grid-column: 1;
        grid-row: 1;
        width: 100%;
        justify-content: flex-start;
        gap: 0.5rem;
        flex-direction: column;
        align-items: flex-start;
        padding-top: 40px;
      }

      .problem.fullscreen-active .show-solution {
        position: static;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        min-height: 36px;
      }

      .problem.fullscreen-active img {
        grid-column: 1;
        grid-row: 2;
      }

      .overlay {
        padding: 0.5rem;
      }

      .overlay-content {
        max-width: calc(98% - 100px);
        max-height: 98%;
      }

      .overlay-header {
        padding: 0.75rem;
      }

      .overlay-header h3 {
        font-size: 1rem;
        padding: 0 8px;
      }

      .close-btn {
        width: 36px;
        height: 36px;
        font-size: 1.3rem;
      }

      .overlay-image-container {
        padding: 0.5rem;
      }

      .overlay-content img {
        max-height: calc(90vh - 100px);
      }

      .overlay-nav-arrow {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
        top: 50%;
      }
      .overlay-nav-arrow.left {
        left: 5px;
      }
      .overlay-nav-arrow.right {
        right: 5px;
      }

      .id-search-group .input-wrapper {
        width: 100%;
        justify-content: space-between;
        gap: 0.5rem;
      }
      .id-search-group input[type="text"] {
        flex-grow: 1;
        max-width: none;
        min-width: 120px;
      }
      .clear-id-input-button {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
        flex-shrink: 0;
        flex-basis: 40px;
      }
      .id-search-group button {
        flex-basis: 100%;
      }

      .fullscreen-nav-arrow {
        font-size: 2.5rem;
        padding: 8px 15px;
      }
      #prevProblemArrow {
        top: 15px;
      }
      #nextProblemArrow {
        bottom: 15px;
      }

      #fullscreenProblemCounter {
        font-size: 1.4rem;
        bottom: 15px;
        right: 15px;
        padding: 8px 12px;
      }
      #fullscreenTimer {
        font-size: 1.4rem;
        bottom: 15px;
        left: 15px;
        padding: 8px 12px;
      }
      #fullscreenTimerControls {
        bottom: 15px;
        left: 120px;
        gap: 8px;
      }
      .timer-control-btn {
        font-size: 1.2rem;
        padding: 6px 10px;
        min-width: 40px;
        min-height: 40px;
      }

      .category-checkbox-group {
        flex-direction: column;
        align-items: flex-start;
      }
      .category-checkbox-label {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.1rem;
      }

      .problem-number {
        font-size: 1.1rem;
      }

      .range-input {
        flex-direction: column;
        gap: 0.75rem;
      }

      .range-input input {
        width: 100px;
      }

      .overlay-header {
        padding: 0.5rem;
      }

      .overlay-header h3 {
        padding: 0 5px;
      }

      .close-btn {
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
      }

      .overlay-nav-arrow {
        width: 35px;
        height: 35px;
        font-size: 1.3rem;
      }
      .overlay-content {
        max-width: calc(98% - 90px);
      }

      #fullscreenProblemCounter {
        font-size: 1.2rem;
        bottom: 10px;
        right: 10px;
        padding: 6px 10px;
      }
      #fullscreenTimer {
        font-size: 1.2rem;
        bottom: 10px;
        left: 10px;
        padding: 6px 10px;
      }
      #fullscreenTimerControls {
        bottom: 10px;
        left: 100px;
        gap: 6px;
      }
      .timer-control-btn {
        font-size: 1rem;
        padding: 5px 8px;
        min-width: 36px;
        min-height: 36px;
      }
    }

    @media (max-height: 500px) and (orientation: landscape) {
      .overlay-content img {
        max-height: calc(85vh - 80px);
      }
    }

    @media (hover: none) {
      button, .search-link, select {
        min-height: 48px;
      }
    }
  </style>
</head>
<body>
<div id="progressBar"></div>

<header>
  <a href="index.html" class="logo-link" title="Načíst stránku znovu">
    <img src="assets/logo.png" alt="Logo" class="logo">
  </a>
  <h1>Portál pro procvičování na maturitu z matematiky</h1>
  <a href="check.html" class="search-link" target="_blank">Vyhledávání podle ID</a>
</header>

<button class="projection-button" title="Zobrazit první viditelný příklad na celou obrazovku" onclick="toggleFullscreenForFirstVisibleProblem(event)">
  &#128421;
</button>
<button id="exitFullscreenButton" title="Ukončit režim celé obrazovky" onclick="exitFullscreen()">
  &#x2716;
</button>

<div class="container">
  <div class="filters-section">
    <div class="select-group">
      <label for="topic">Vyberte téma:</label>
      <select id="topic" multiple size="6" onchange="loadProblems()">
        <option value="ciselne-obory-procenta">1. Číselné obory, procenta</option>
        <option value="algebraicke-vyrazy">2. Výrazy</option>
        <option value="rovnice-nerovnice-soustavy">3. Rovnice, nerovnice, soustavy</option>
        <option value="funkce">4. Funkce</option>
        <option value="posloupnosti">5. Posloupnosti</option>
        <option value="financni-matematika">6. Finanční matematika</option>
        <option value="planimetrie">7. Planimetrie</option>
        <option value="stereometrie">8. Stereometrie</option>
        <option value="analyticka-geometrie">9. Analytická geometrie</option>
        <option value="kombinatorika">10. Kombinatorika</option>
        <option value="pravdepodobnost">11. Pravděpodobnost</option>
        <option value="statistika">12. Statistika</option>
      </select>
    </div>

    <div class="select-group">
      <label for="series">Vyberte sérii:</label>
      <select id="series" multiple size="6" onchange="loadProblems()">
        <option value="25p">2025 - podzim</option>
        <option value="25j">2025 - jaro</option>
        <option value="24p">2024 - podzim</option>
        <option value="24j">2024 - jaro</option>
        <option value="23p">2023 - podzim</option>
        <option value="23j">2023 - jaro</option>
        <option value="22p">2022 - podzim</option>
        <option value="22j">2022 - jaro</option>
        <option value="21p">2021 - podzim</option>
        <option value="21jm">2021 - jaro mimořádné</option>
        <option value="21j">2021 - jaro</option>
        <option value="20p">2020 - podzim</option>
        <option value="20j">2020 - jaro</option>
        <option value="19p">2019 - podzim</option>
        <option value="19j">2019 - jaro</option>
        <option value="18p">2018 - podzim</option>
        <option value="18j">2018 - jaro</option>
        <option value="17p">2017 - podzim</option>
        <option value="17j">2017 - jaro</option>
        <option value="16p">2016 - podzim</option>
        <option value="16j">2016 - jaro</option>
        <option value="ilustr">ilustrační test</option>
        <option value="vzor">vzorové příklady</option>
      </select>
    </div>

    <button class="go-to-problems-button" onclick="loadProblemsAndScroll()">Přejít na výpis příkladů</button>

    <div id="problemCount">Počet příkladů: 0</div>

    <button class="toggle-advanced-filters" onclick="toggleAdvancedFilters()">Více možností filtrování</button>

    <div id="advancedFilters">
      <div class="checkbox-group">
        <input type="checkbox" id="randomOrderCheckbox" onchange="loadProblems()">
        <label for="randomOrderCheckbox">Náhodné pořadí</label>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="developerModeCheckbox" onchange="toggleDeveloperMode()">
        <label for="developerModeCheckbox">Vývojářský mód</label>
      </div>
      <div class="range-section">
        <div class="range-input">
          <label for="rangeFrom">Vybrat rozsah od:</label>
          <input type="number" id="rangeFrom" placeholder="1" />
          <label for="rangeTo">do:</label>
          <input type="number" id="rangeTo" placeholder="10" />
          <button onclick="applyRange()">Potvrdit</button>
        </div>
      </div>
      <div class="id-search-group">
        <label for="problemIdInput">Zobrazení příkladu s konkrétním ID:</label>
        <div class="input-wrapper">
          <input type="text" id="problemIdInput" placeholder="např. 23j/8" />
          <button id="clearIdInputBtn" class="clear-id-input-button" title="Vyčistit ID vstup">&times;</button>
        </div>
        <div id="problemIdHelpText" class="id-help-text">Nápověda: Zadejte ID ve formátu "16j/12"</div>
        <button id="showProblemByIdBtn" onclick="showProblemById(true)">Zobrazit</button>
      </div>
      <button class="clear-filter" onclick="clearFilters()">Vyčistit filtr</button>
    </div>
  </div>

  <div id="problems"></div>

  <!-- NOVÉ: Element pro zprávu o zatřídění příkladů -->
  <div id="classificationStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: bold; display: none;"></div>

  <div id="developerModeSummary" class="category-summary-output" style="display: none;">
    <h3>Souhrn kategorií příkladů:</h3>
    <pre id="categorySummaryContent"></pre>
    <button id="clearCategorySummaryBtn" class="clear-filter" style="margin-top: 1rem;">Smazat výpis</button>
    <button id="downloadCategorySummaryBtn" style="margin-top: 0.5rem; width: 100%; padding: 0.75rem 1.5rem; background-color: #1e88e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; min-height: 48px;">
      Stáhnout výpis jako .txt
    </button>
    <div class="copy-feedback" id="copyFeedback">Zkopírováno do schránky!</div>
  </div>
</div>

<div class="overlay" id="overlay">
  <button class="overlay-nav-arrow left" id="prevBtn" title="Předchozí příklad">&larr;</button>
  <div class="overlay-content">
    <div class="overlay-header">
      <h3 id="overlayTitle">Řešení příkladu</h3>
      <button class="close-btn" id="closeBtn">&times;</button>
    </div>
    <div class="overlay-image-container">
      <img id="solutionImage" src="" alt="Řešení">
    </div>
  </div>
  <button class="overlay-nav-arrow right" id="nextBtn" title="Další příklad">&rarr;</button>
</div>

<div id="prevProblemArrow" class="fullscreen-nav-arrow" title="Předchozí příklad">&uarr;</div>
<div id="nextProblemArrow" class="fullscreen-nav-arrow" title="Další příklad">&darr;</div>
<div id="fullscreenProblemCounter"></div>
<div id="fullscreenTimer"></div>
<div id="fullscreenTimerControls">
  <button id="playPauseTimerBtn" class="timer-control-btn" title="Spustit/Pozastavit odpočet">&#9658;</button>
  <button id="resetTimerBtn" class="timer-control-btn" title="Resetovat odpočet">&#8635;</button>
</div>

<script src="tasks-data.js"></script>

<script>
  let masterProblemList = [];
  let currentDisplayedProblems = [];

  let activeProblemElement = null;
  let lastScrollPosition = 0;

  let touchStartX = 0;
  let touchStartY = 0;
  const swipeThreshold = 50;

  let isDraggingOverlay = false;
  let overlayDragOffsetX, overlayDragOffsetY;
  const overlay = document.getElementById("overlay");
  const overlayContent = document.querySelector(".overlay-content");
  const overlayHeader = document.querySelector(".overlay-header");

  let fullscreenUIHideTimeout;
  const UI_HIDE_DELAY = 5000;

  let timerInterval;
  let timerSeconds = 8100;
  let timerRunning = false;
  let twoMinuteAlertShown = false;
  let finalAlertShown = false;

  const fullscreenTimerElement = document.getElementById('fullscreenTimer');
  const fullscreenAlertOverlay = document.createElement('div');
  fullscreenAlertOverlay.id = 'fullscreenAlertOverlay';
  document.body.appendChild(fullscreenAlertOverlay);

  const playPauseTimerBtn = document.getElementById('playPauseTimerBtn');
  const resetTimerBtn = document.getElementById('resetTimerBtn');
  const fullscreenTimerControls = document.getElementById('fullscreenTimerControls');

  // Aktualizováno, aby odpovídalo zobrazovaným názvům v selectu
  const PROBLEM_CATEGORIES = [
    "Číselné obory, procenta",
    "Výrazy",
    "Rovnice, nerovnice, soustavy",
    "Funkce",
    "Posloupnosti",
    "Finanční matematika",
    "Planimetrie",
    "Stereometrie",
    "Analytická geometrie",
    "Kombinatorika",
    "Pravděpodobnost",
    "Statistika"
  ];
  let developerModeActive = false;
  let problemCategoryData = {};
  const LOCAL_STORAGE_KEY = 'problemCategoryData';
  const developerModeCheckbox = document.getElementById('developerModeCheckbox');
  const developerModeSummary = document.getElementById('developerModeSummary');
  const categorySummaryContent = document.getElementById('categorySummaryContent');
  const copyFeedback = document.getElementById('copyFeedback');
  const clearCategorySummaryBtn = document.getElementById('clearCategorySummaryBtn');
  const downloadCategorySummaryBtn = document.getElementById('downloadCategorySummaryBtn');
  const classificationStatusDiv = document.getElementById('classificationStatus'); // NOVÉ

  let currentProblemIndex = -1;

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function generateMasterProblemList() {
    const allPossibleProblems = new Set();
    for (const seriesKey in problemsCount) {
      for (let i = 1; i <= problemsCount[seriesKey]; i++) {
        allPossibleProblems.add(JSON.stringify({ series: seriesKey, num: i }));
      }
    }
    for (const topicKey in topics) {
      const selectedTopic = topics[topicKey];
      for (const seriesKey in selectedTopic) {
        const problemIndices = selectedTopic[seriesKey];
        problemIndices.forEach(num => {
          allPossibleProblems.add(JSON.stringify({ series: seriesKey, num }));
        });
      }
    }
    masterProblemList = Array.from(allPossibleProblems).map(item => JSON.parse(item));
  }

  function loadProblems() {
    const seriesSelect = document.getElementById("series");
    const topicSelect = document.getElementById("topic");
    const problemsDiv = document.getElementById("problems");
    const problemCountDiv = document.getElementById("problemCount");
    const randomOrderCheckbox = document.getElementById("randomOrderCheckbox");
    problemsDiv.innerHTML = '';

    const selectedSeries = Array.from(seriesSelect.selectedOptions).map(option => option.value);
    const selectedTopics = Array.from(topicSelect.selectedOptions).map(option => option.value);

    let filteredProblems = [...masterProblemList];

    if (selectedSeries.length > 0) {
      filteredProblems = filteredProblems.filter(p => selectedSeries.includes(p.series));
    }

    if (selectedTopics.length > 0) {
      filteredProblems = filteredProblems.filter(p => {
        return selectedTopics.some(topicKey => {
          const topicMap = topics[topicKey];
          return topicMap[p.series] && topicMap[p.series].includes(p.num);
        });
      });
    }

    if (selectedSeries.length === 0 && selectedTopics.length === 0) {
      currentDisplayedProblems = [];
      problemCountDiv.textContent = `Počet příkladů: 0`;
      updateCategorySummary();
      updateClassificationStatus(); // NOVÉ
      return;
    }

    filteredProblems.sort((a, b) => {
      if (a.series < b.series) return -1;
      if (a.series > b.series) return 1;
      return a.num - b.num;
    });

    if (randomOrderCheckbox.checked) {
      shuffleArray(filteredProblems);
    }

    currentDisplayedProblems = filteredProblems.map((problem, i) => ({
      ...problem,
      displayIndex: i + 1
    }));

    currentDisplayedProblems.forEach(({ series, num, displayIndex }) => {
      const problemDiv = document.createElement("div");
      problemDiv.className = "problem";
      problemDiv.setAttribute('data-series', series);
      problemDiv.setAttribute('data-num', num);

      let categoryCheckboxesHtml = '';
      if (developerModeActive) {
        categoryCheckboxesHtml = `<div class="category-checkbox-group" id="categoryCheckboxesContainer_${series}_${num}">`;
        PROBLEM_CATEGORIES.forEach(category => {
          const problemId = `${series}/${num}`;
          const isChecked = problemCategoryData[problemId] && problemCategoryData[problemId].includes(category) ? 'checked' : '';
          const uniqueId = `cat-${series}-${num}-${category.replace(/\s/g, '-')}`;
          categoryCheckboxesHtml += `
            <label class="category-checkbox-label">
              <input type="checkbox" class="category-checkbox-input"
                data-series="${series}" data-num="${num}" data-category="${category}"
                id="${uniqueId}" ${isChecked}>
              ${category}
            </label>
          `;
        });
        categoryCheckboxesHtml += `</div>`;
      }

      problemDiv.innerHTML = `
        <div class="problem-header-content">
          <div class="problem-info-text">
            <div class="problem-number">Příklad ${displayIndex}</div>
            <div class="problem-id">ID: ${series}/${num}</div>
          </div>
          <button class="show-solution" data-series="${series}" data-num="${num}">Zobrazit řešení</button>
          ${categoryCheckboxesHtml}
        </div>
        <img src="files/${series}/${num}.png" alt="Úloha ${num}" />
      `;
      problemsDiv.appendChild(problemDiv);

      if (developerModeActive) {
        const checkboxes = problemDiv.querySelectorAll('.category-checkbox-input');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const series = e.target.dataset.series;
            const num = parseInt(e.target.dataset.num);
            const category = e.target.dataset.category;
            const isChecked = e.target.checked;
            handleCategoryCheckboxChange(series, num, category, isChecked);
          });
        });
      }
    });

    problemCountDiv.textContent = `Počet příkladů: ${currentDisplayedProblems.length}`;
    document.querySelectorAll('.problem .show-solution').forEach(button => {
      button.onclick = function(event) {
        event.stopPropagation();
        showSolution(this.dataset.series, parseInt(this.dataset.num));
      };
    });
    updateSolutionButtonState();
    updateCategorySummary();
    updateClassificationStatus(); // NOVÉ
  }

  function loadProblemsAndScroll() {
    loadProblems();
    const problemsDiv = document.getElementById("problems");
    if (problemsDiv.firstElementChild) {
      problemsDiv.firstElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  function applyRange() {
    const rangeFromInput = document.getElementById("rangeFrom");
    const rangeToInput = document.getElementById("rangeTo");
    const rangeFrom = parseInt(rangeFromInput.value);
    const rangeTo = parseInt(rangeToInput.value);
    const problemsDiv = document.getElementById("problems");
    const randomOrderCheckbox = document.getElementById("randomOrderCheckbox");
    problemsDiv.innerHTML = '';

    if (isNaN(rangeFrom) || isNaN(rangeTo)) {
      alert("Prosím zadejte platné čísla pro rozsah.");
      return;
    }

    if (currentDisplayedProblems.length === 0) {
      loadProblems();
    }

    let rangedProblems = [];
    for (let i = 0; i < currentDisplayedProblems.length; i++) {
      if (currentDisplayedProblems[i].displayIndex >= rangeFrom && currentDisplayedProblems[i].displayIndex <= rangeTo) {
        rangedProblems.push(currentDisplayedProblems[i]);
      }
    }

    if (randomOrderCheckbox.checked) {
      shuffleArray(rangedProblems);
    }

    currentDisplayedProblems = rangedProblems;

    currentDisplayedProblems.forEach(({ series, num, displayIndex }) => {
      const problemDiv = document.createElement("div");
      problemDiv.className = "problem";
      problemDiv.setAttribute('data-series', series);
      problemDiv.setAttribute('data-num', num);

      let categoryCheckboxesHtml = '';
      if (developerModeActive) {
        categoryCheckboxesHtml = `<div class="category-checkbox-group" id="categoryCheckboxesContainer_${series}_${num}">`;
        PROBLEM_CATEGORIES.forEach(category => {
          const problemId = `${series}/${num}`;
          const isChecked = problemCategoryData[problemId] && problemCategoryData[problemId].includes(category) ? 'checked' : '';
          const uniqueId = `cat-${series}-${num}-${category.replace(/\s/g, '-')}`;
          categoryCheckboxesHtml += `
            <label class="category-checkbox-label">
              <input type="checkbox" class="category-checkbox-input"
                data-series="${series}" data-num="${num}" data-category="${category}"
                id="${uniqueId}" ${isChecked}>
              ${category}
            </label>
          `;
        });
        categoryCheckboxesHtml += `</div>`;
      }

      problemDiv.innerHTML = `
        <div class="problem-header-content">
          <div class="problem-info-text">
            <div class="problem-number">Příklad ${displayIndex}</div>
            <div class="problem-id">ID: ${series}/${num}</div>
          </div>
          <button class="show-solution" data-series="${series}" data-num="${num}">Zobrazit řešení</button>
          ${categoryCheckboxesHtml}
        </div>
        <img src="files/${series}/${num}.png" alt="Úloha ${num}" />
      `;
      problemsDiv.appendChild(problemDiv);

      if (developerModeActive) {
        const checkboxes = problemDiv.querySelectorAll('.category-checkbox-input');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const series = e.target.dataset.series;
            const num = parseInt(e.target.dataset.num);
            const category = e.target.dataset.category;
            const isChecked = e.target.checked;
            handleCategoryCheckboxChange(series, num, category, isChecked);
          });
        });
      }
    });

    document.getElementById("problemCount").textContent = `Počet příkladů: ${currentDisplayedProblems.length}`;
    document.querySelectorAll('.problem .show-solution').forEach(button => {
      button.onclick = function(event) {
        event.stopPropagation();
        showSolution(this.dataset.series, parseInt(this.dataset.num));
      };
    });
    updateSolutionButtonState();
    updateCategorySummary();
    updateClassificationStatus(); // NOVÉ
  }

  function showProblemById(autoScroll = false) {
    const problemIdInput = document.getElementById("problemIdInput");
    const problemsDiv = document.getElementById("problems");
    const problemCountDiv = document.getElementById("problemCount");
    problemsDiv.innerHTML = '';

    const inputId = problemIdInput.value.trim();
    if (!inputId) {
      currentDisplayedProblems = [];
      problemCountDiv.textContent = `Počet příkladů: 0`;
      updateCategorySummary();
      updateClassificationStatus(); // NOVÉ
      return;
    }

    const idParts = inputId.split('/');
    if (idParts.length !== 2) {
      currentDisplayedProblems = [];
      problemCountDiv.textContent = `Počet příkladů: 0`;
      updateCategorySummary();
      updateClassificationStatus(); // NOVÉ
      return;
    }
    const series = idParts[0];
    const num = parseInt(idParts[1]);

    if (isNaN(num)) {
      currentDisplayedProblems = [];
      problemCountDiv.textContent = `Počet příkladů: 0`;
      updateCategorySummary();
      updateClassificationStatus(); // NOVÉ
      return;
    }

    const foundProblem = masterProblemList.find(p => p.series === series && p.num === num);

    if (foundProblem) {
      document.getElementById("series").selectedIndex = -1;
      document.getElementById("topic").selectedIndex = -1;
      document.getElementById("rangeFrom").value = '';
      document.getElementById("rangeTo").value = '';
      document.getElementById("randomOrderCheckbox").checked = false;

      currentDisplayedProblems = [{ ...foundProblem, displayIndex: 1 }];

      const problemDiv = document.createElement("div");
      problemDiv.className = "problem";
      problemDiv.setAttribute('data-series', foundProblem.series);
      problemDiv.setAttribute('data-num', foundProblem.num);

      let categoryCheckboxesHtml = '';
      if (developerModeActive) {
        categoryCheckboxesHtml = `<div class="category-checkbox-group" id="categoryCheckboxesContainer_${series}_${num}">`;
        PROBLEM_CATEGORIES.forEach(category => {
          const problemId = `${series}/${num}`;
          const isChecked = problemCategoryData[problemId] && problemCategoryData[problemId].includes(category) ? 'checked' : '';
          const uniqueId = `cat-${series}-${num}-${category.replace(/\s/g, '-')}`;
          categoryCheckboxesHtml += `
            <label class="category-checkbox-label">
              <input type="checkbox" class="category-checkbox-input"
                data-series="${series}" data-num="${num}" data-category="${category}"
                id="${uniqueId}" ${isChecked}>
              ${category}
            </label>
          `;
        });
        categoryCheckboxesHtml += `</div>`;
      }

      problemDiv.innerHTML = `
        <div class="problem-header-content">
          <div class="problem-info-text">
            <div class="problem-number">Příklad ${currentDisplayedProblems[0].displayIndex}</div>
            <div class="problem-id">ID: ${foundProblem.series}/${foundProblem.num}</div>
          </div>
          <button class="show-solution" data-series="${foundProblem.series}" data-num="${foundProblem.num}">Zobrazit řešení</button>
          ${categoryCheckboxesHtml}
        </div>
        <img src="files/${foundProblem.series}/${foundProblem.num}.png" alt="Úloha ${foundProblem.num}" />
      `;
      problemsDiv.appendChild(problemDiv);
      problemCountDiv.textContent = `Počet příkladů: 1`;

      if (autoScroll && problemsDiv.firstElementChild) {
        problemsDiv.firstElementChild.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      if (developerModeActive) {
        const checkboxes = problemDiv.querySelectorAll('.category-checkbox-input');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const series = e.target.dataset.series;
            const num = parseInt(e.target.dataset.num);
            const category = e.target.dataset.category;
            const isChecked = e.target.checked;
            handleCategoryCheckboxChange(series, num, category, isChecked);
          });
        });
      }
    } else {
      currentDisplayedProblems = [];
      problemCountDiv.textContent = `Počet příkladů: 0`;
    }
    document.querySelectorAll('.problem .show-solution').forEach(button => {
      button.onclick = function(event) {
        event.stopPropagation();
        showSolution(this.dataset.series, parseInt(this.dataset.num));
      };
    });
    updateSolutionButtonState();
    updateCategorySummary();
    updateClassificationStatus(); // NOVÉ
  }

  function clearFilters() {
    const seriesSelect = document.getElementById("series");
    const topicSelect = document.getElementById("topic");
    const rangeFrom = document.getElementById("rangeFrom");
    const rangeTo = document.getElementById("rangeTo");
    const randomOrderCheckbox = document.getElementById("randomOrderCheckbox");
    const problemIdInput = document.getElementById("problemIdInput");

    seriesSelect.selectedIndex = -1;
    topicSelect.selectedIndex = -1;
    rangeFrom.value = '';
    rangeTo.value = '';
    randomOrderCheckbox.checked = false;

    problemIdInput.value = '';
    problemIdInput.classList.remove('valid-id', 'invalid-id');
    document.getElementById("problemIdHelpText").textContent = 'Nápověda: Zadejte ID ve formátu "16j/12"';
    document.getElementById("problemIdHelpText").classList.remove('error');

    loadProblemsAndScroll();
  }

  function closeOverlay() {
    overlay.style.display = "none";
    overlay.style.left = '50%';
    overlay.style.top = '50%';
    overlay.style.transform = 'translate(-50%, -50%)';
    overlayHeader.style.cursor = 'grab';
    overlay.style.width = '';
    overlay.style.height = '';
  }

  function showSolution(series, num) {
    const solutionImage = document.getElementById("solutionImage");
    const overlayTitle = document.getElementById("overlayTitle");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    currentProblemIndex = currentDisplayedProblems.findIndex(p => p.series === series && p.num === num);

    if (currentProblemIndex === -1) {
      console.error("Problem not found in currentDisplayedProblems for solution display:", series, num);
      return;
    }

    solutionImage.src = `files/${series}/${num}_res.png`;
    overlayTitle.innerHTML = `Řešení <span class="problem-index-bold">příkladu ${currentDisplayedProblems[currentProblemIndex].displayIndex}</span> ID: ${series}/${num}`;
    overlay.style.display = "flex";

    prevBtn.disabled = currentProblemIndex <= 0;
    nextBtn.disabled = currentProblemIndex >= currentDisplayedProblems.length - 1;
  }

  function navigateSolution(direction) {
    if (currentDisplayedProblems.length === 0) return;

    let newIndex = currentProblemIndex;
    if (direction === 'prev') {
      newIndex = Math.max(0, currentProblemIndex - 1);
    } else if (direction === 'next') {
      newIndex = Math.min(currentDisplayedProblems.length - 1, currentProblemIndex + 1);
    }

    if (newIndex !== currentProblemIndex) {
      const problem = currentDisplayedProblems[newIndex];
      showSolution(problem.series, problem.num);

      const newProblemElement = document.querySelector(`.problem[data-series="${problem.series}"][data-num="${problem.num}"]`);
      if (newProblemElement && document.fullscreenElement) {
        prepareProblemForFullscreen(newProblemElement);
      }
    }
  }

  document.getElementById("closeBtn").addEventListener("click", closeOverlay);

  overlay.addEventListener("click", function(e) {
    if (e.target === this || (e.target.closest('.overlay-content') && !e.target.closest('.overlay-header'))) {
      closeOverlay();
    }
  });

  document.addEventListener('click', function(e) {
    if (overlay.style.display === 'flex' && !overlay.contains(e.target)) {
      closeOverlay();
    }
  });

  document.getElementById("prevBtn").addEventListener("click", () => navigateSolution('prev'));
  document.getElementById("nextBtn").addEventListener("click", () => navigateSolution('next'));

  document.addEventListener("keydown", function(e) {
    const overlay = document.getElementById("overlay");
    const isOverlayOpen = overlay.style.display === "flex";
    const isFullscreen = document.fullscreenElement;

    if (e.key === "Escape") {
      e.preventDefault();
      if (isOverlayOpen) {
        closeOverlay();
      } else if (isFullscreen) {
        exitFullscreen();
      }
    } else if (isFullscreen && activeProblemElement) {
      if (isOverlayOpen) {
        if (e.key === "ArrowLeft") {
          e.preventDefault();
          navigateSolution('prev');
        } else if (e.key === "ArrowRight") {
          e.preventDefault();
          navigateSolution('next');
        } else if (e.key === "ArrowUp" || e.key === "ArrowDown") {
          e.preventDefault();
          closeOverlay();
          if (e.key === "ArrowUp") {
            navigateToPrevProblemInFullscreen();
          } else {
            navigateToNextProblemInFullscreen();
          }
        }
      } else {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          navigateToNextProblemInFullscreen();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          navigateToPrevProblemInFullscreen();
        }
      }
      showFullscreenUIAndResetHideTimer();
    }
  });

  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  function toggleAdvancedFilters() {
    const advancedFiltersDiv = document.getElementById("advancedFilters");
    if (advancedFiltersDiv.style.display === "none" || advancedFiltersDiv.style.display === "") {
      advancedFiltersDiv.style.display = "block";
    } else {
      advancedFiltersDiv.style.display = "none";
    }
  }

  document.getElementById("rangeFrom").addEventListener("focus", function() {
    this.value = '';
  });
  document.getElementById("rangeTo").addEventListener("focus", function() {
    this.value = '';
  });

  document.getElementById("rangeFrom").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      applyRange();
    }
  });
  document.getElementById("rangeTo").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      applyRange();
    }
  });

  const problemIdInput = document.getElementById("problemIdInput");
  const problemIdHelpText = document.getElementById("problemIdHelpText");
  const clearIdInputBtn = document.getElementById("clearIdInputBtn");

  function validateProblemId() {
    const inputId = problemIdInput.value.trim();
    problemIdInput.classList.remove('valid-id', 'invalid-id');
    problemIdHelpText.classList.remove('error');
    problemIdHelpText.textContent = 'Nápověda: Zadejte ID ve formátu "16j/12"';

    if (inputId === '') {
      currentDisplayedProblems = [];
      document.getElementById("problems").innerHTML = '';
      document.getElementById("problemCount").textContent = `Počet příkladů: 0`;
      updateCategorySummary();
      updateClassificationStatus(); // NOVÉ
      return;
    }

    const exactMatch = masterProblemList.find(p => `${p.series}/${p.num}` === inputId);
    const prefixMatch = masterProblemList.some(p => `${p.series}/${p.num}`.startsWith(inputId));

    if (exactMatch) {
      problemIdInput.classList.add('valid-id');
      showProblemById(true);
    } else if (prefixMatch) {
    } else {
      problemIdInput.classList.add('invalid-id');
      problemIdHelpText.textContent = 'Neexistující ID';
      problemIdHelpText.classList.add('error');
      currentDisplayedProblems = [];
      document.getElementById("problems").innerHTML = '';
      document.getElementById("problemCount").textContent = `Počet příkladů: 0`;
    }
    updateCategorySummary();
    updateClassificationStatus(); // NOVÉ
  }

  function clearProblemIdInput() {
    problemIdInput.value = '';
    validateProblemId();
  }

  problemIdInput.addEventListener('input', validateProblemId);
  problemIdInput.addEventListener('keydown', function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      showProblemById(true);
    }
  });
  clearIdInputBtn.addEventListener('click', clearProblemIdInput);

  function updateProgressBar() {
    const progressBar = document.getElementById("progressBar");
    const filtersSection = document.querySelector(".filters-section");
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    const clientHeight = window.innerHeight;

    if (document.fullscreenElement && activeProblemElement && activeProblemElement.classList.contains('fullscreen-active')) {
      progressBar.style.opacity = '1';

      const problemScrollTop = activeProblemElement.scrollTop;
      const problemScrollHeight = activeProblemElement.scrollHeight;
      const problemClientHeight = activeProblemElement.clientHeight;

      let scrollPercentage = 0;
      if (problemScrollHeight > problemClientHeight) {
        scrollPercentage = (problemScrollTop / (problemScrollHeight - problemClientHeight)) * 100;
      } else {
        scrollPercentage = 100;
      }

      scrollPercentage = Math.max(0, Math.min(100, scrollPercentage));
      progressBar.style.width = `${scrollPercentage}%`;
      return;
    }

    if (!filtersSection) {
      progressBar.style.opacity = '0';
      return;
    }

    const startPoint = filtersSection.offsetTop + filtersSection.offsetHeight;

    if (scrollTop < startPoint) {
      progressBar.style.opacity = '0';
      progressBar.style.width = '0%';
      return;
    }

    progressBar.style.opacity = '1';

    const scrollHeightAfterFilters = document.documentElement.scrollHeight - startPoint;
    const totalScrollableHeightForProblems = scrollHeightAfterFilters - clientHeight;

    if (totalScrollableHeightForProblems > 0) {
      const scrollProgress = scrollTop - startPoint;
      let scrollPercentage = (scrollProgress / totalScrollableHeightForProblems) * 100;
      scrollPercentage = Math.max(0, Math.min(100, scrollPercentage));
      progressBar.style.width = `${scrollPercentage}%`;
    } else {
      progressBar.style.width = '100%';
    }
  }

  function prepareProblemForFullscreen(problemElement) {
    const allProblems = document.querySelectorAll('.problem');

    allProblems.forEach(p => p.classList.add('hidden-for-fullscreen'));

    if (activeProblemElement && activeProblemElement !== problemElement) {
      activeProblemElement.classList.remove('fullscreen-active');
    }

    activeProblemElement = problemElement;
    activeProblemElement.classList.remove('hidden-for-fullscreen');
    activeProblemElement.classList.add('fullscreen-active');
    activeProblemElement.scrollTop = 0;

    showFullscreenUIAndResetHideTimer();
    updateProgressBar();
    updateSolutionButtonState();
  }

  function requestAndPrepareFullscreen(problemElement) {
    if (document.documentElement.requestFullscreen) {
      lastScrollPosition = window.scrollY;
      document.documentElement.requestFullscreen().then(() => {
        if (screen.orientation && screen.orientation.lock) {
          screen.orientation.lock('landscape').catch(err => {
            console.warn("Nepodařilo se uzamknout orientaci obrazovky na landscape:", err);
          });
        }
        prepareProblemForFullscreen(problemElement);
      }).catch(err => {
        console.error(`Chyba při pokusu o přepnutí do režimu celé obrazovky: ${err.message}`);
        prepareProblemForFullscreen(problemElement);
        hideFullscreenUI();
      });
    } else {
      alert("Váš prohlížeč nepodporuje režim celé obrazovky.");
      prepareProblemForFullscreen(problemElement);
      hideFullscreenUI();
    }
  }

  function toggleFullscreenForFirstVisibleProblem(event) {
    event.stopPropagation();

    if (document.fullscreenElement) {
      return;
    }

    const problems = Array.from(document.querySelectorAll('.problem'));
    let firstVisibleProblem = null;

    for (const problem of problems) {
      const rect = problem.getBoundingClientRect();
      if (rect.top >= 0 && rect.top < window.innerHeight) {
        firstVisibleProblem = problem;
        break;
      }
    }

    if (firstVisibleProblem) {
      requestAndPrepareFullscreen(firstVisibleProblem);
    } else {
      alert("Není viditelný žádný příklad k zobrazení na celou obrazovku.");
    }
  }

  function updateFullscreenProblemCounter() {
    const problemCounter = document.getElementById('fullscreenProblemCounter');
    if (!document.fullscreenElement || !activeProblemElement || !problemCounter) {
      return;
    }
    const activeProblemSeries = activeProblemElement.dataset.series;
    const activeProblemNum = parseInt(activeProblemElement.dataset.num, 10);
    const currentProblemData = currentDisplayedProblems.find(p =>
      p.series === activeProblemSeries && p.num === activeProblemNum
    );
    if (currentProblemData) {
      problemCounter.textContent = `${currentProblemData.displayIndex}/${currentDisplayedProblems.length}`;
    } else {
      problemCounter.textContent = `?/${currentDisplayedProblems.length}`;
    }
  }

  function showFullscreenUI() {
    const nextArrow = document.getElementById('nextProblemArrow');
    const prevArrow = document.getElementById('prevProblemArrow');
    const problemCounter = document.getElementById('fullscreenProblemCounter');
    const exitButton = document.getElementById('exitFullscreenButton');
    const projectionButton = document.querySelector('.projection-button');

    const activeProblemSeries = activeProblemElement ? activeProblemElement.dataset.series : null;
    const activeProblemNum = activeProblemElement ? parseInt(activeProblemElement.dataset.num) : null;
    const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === activeProblemSeries && p.num === activeProblemNum);

    if (nextArrow) {
      nextArrow.style.display = 'block';
      nextArrow.disabled = currentProblemDataIndex >= currentDisplayedProblems.length - 1;
      nextArrow.style.opacity = '1';
    }
    if (prevArrow) {
      prevArrow.style.display = 'block';
      prevArrow.disabled = currentProblemDataIndex <= 0;
      prevArrow.style.opacity = '1';
    }
    if (problemCounter) {
      updateFullscreenProblemCounter();
      problemCounter.style.display = 'block';
    }
    if (fullscreenTimerElement) {
      fullscreenTimerElement.style.display = 'block';
      fullscreenTimerElement.style.opacity = '1';
    }
    if (fullscreenTimerControls) {
      fullscreenTimerControls.style.display = 'flex';
      fullscreenTimerControls.style.opacity = '1';
    }

    if (projectionButton) {
      projectionButton.style.display = 'none';
    }
    if (exitButton) {
      exitButton.style.display = 'flex';
    }

    hideFullscreenUIDelayed();
  }

  function hideFullscreenUI() {
    clearTimeout(fullscreenUIHideTimeout);
    const nextArrow = document.getElementById('nextProblemArrow');
    const prevArrow = document.getElementById('prevProblemArrow');
    const problemCounter = document.getElementById('fullscreenProblemCounter');
    const exitButton = document.getElementById('exitFullscreenButton');
    const projectionButton = document.querySelector('.projection-button');
    const fullscreenTimerElementLocal = document.getElementById('fullscreenTimer');
    const fullscreenTimerControlsLocal = document.getElementById('fullscreenTimerControls');

    if (nextArrow) nextArrow.style.opacity = '0';
    if (prevArrow) prevArrow.style.opacity = '0';
    if (fullscreenTimerElementLocal) fullscreenTimerElementLocal.style.opacity = '0';
    if (fullscreenTimerControlsLocal) fullscreenTimerControlsLocal.style.opacity = '0';

    setTimeout(() => {
      if (nextArrow) nextArrow.style.display = 'none';
      if (prevArrow) prevArrow.style.display = 'none';
      if (problemCounter) problemCounter.style.display = 'none';
      if (fullscreenTimerElementLocal) fullscreenTimerElementLocal.style.display = 'none';
      if (fullscreenTimerControlsLocal) fullscreenTimerControlsLocal.style.display = 'none';

      if (exitButton) exitButton.style.display = 'none';
      if (projectionButton) projectionButton.style.display = 'flex';
    }, 300);
  }

  function navigateToPrevProblemInFullscreen() {
    if (!activeProblemElement || !document.fullscreenElement || currentDisplayedProblems.length === 0) {
      return;
    }

    const currentSeries = activeProblemElement.dataset.series;
    const currentNum = parseInt(activeProblemElement.dataset.num);

    const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === currentSeries && p.num === currentNum);

    if (currentProblemDataIndex <= 0) {
      return;
    }

    const prevProblemData = currentDisplayedProblems[currentProblemDataIndex - 1];
    if (prevProblemData) {
      const prevProblemElement = document.querySelector(`.problem[data-series="${prevProblemData.series}"][data-num="${prevProblemData.num}"]`);
      if (prevProblemElement) {
        prepareProblemForFullscreen(prevProblemElement);
        showFullscreenUIAndResetHideTimer();

        if (overlay.style.display === 'flex') {
          showSolution(prevProblemData.series, prevProblemData.num);
        }
      }
    }
  }

  function navigateToNextProblemInFullscreen() {
    if (!activeProblemElement || !document.fullscreenElement || currentDisplayedProblems.length === 0) {
      return;
    }

    const currentSeries = activeProblemElement.dataset.series;
    const currentNum = parseInt(activeProblemElement.dataset.num);

    const currentProblemDataIndex = currentDisplayedProblems.findIndex(p => p.series === currentSeries && p.num === currentNum);

    if (currentProblemDataIndex === -1 || currentProblemDataIndex >= currentDisplayedProblems.length - 1) {
      return;
    }

    const nextProblemData = currentDisplayedProblems[currentProblemDataIndex + 1];
    if (nextProblemData) {
      const nextProblemElement = document.querySelector(`.problem[data-series="${nextProblemData.series}"][data-num="${nextProblemData.num}"]`);
      if (nextProblemElement) {
        prepareProblemForFullscreen(nextProblemElement);
        showFullscreenUIAndResetHideTimer();

        if (overlay.style.display === 'flex') {
          showSolution(nextProblemData.series, nextProblemData.num);
        }
      }
    }
  }

  function exitFullscreen() {
    document.exitFullscreen();
  }

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      if (activeProblemElement) {
        activeProblemElement.classList.remove('fullscreen-active');
      }
      activeProblemElement = null;
      hideFullscreenUI();
      updateProgressBar();

      document.querySelectorAll('.problem').forEach(p => p.classList.remove('hidden-for-fullscreen'));

      window.scrollTo(0, lastScrollPosition);

      closeOverlay();

      if (screen.orientation && screen.orientation.unlock) {
        screen.orientation.unlock();
      }
    } else {
      if (document.fullscreenElement.classList.contains('problem') && document.fullscreenElement !== activeProblemElement) {
        prepareProblemForFullscreen(document.fullscreenElement);
      }
      showFullscreenUI();
    }
    updateSolutionButtonState();
  });

  document.addEventListener('touchstart', function(e) {
    if (document.fullscreenElement && activeProblemElement && e.touches.length === 1) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }
  }, { passive: true });

  document.addEventListener('touchmove', function(e) {
  }, { passive: true });

  document.addEventListener('touchend', function(e) {
    if (document.fullscreenElement && activeProblemElement && e.changedTouches.length === 1) {
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;

      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
    }
    touchStartX = 0;
    touchStartY = 0;
    if (document.fullscreenElement && activeProblemElement) {
      showFullscreenUIAndResetHideTimer();
    }
  });

  overlayHeader.addEventListener('mousedown', (e) => {
    if (e.button === 0) {
      isDraggingOverlay = true;
      const rect = overlay.getBoundingClientRect();
      overlayDragOffsetX = e.clientX - rect.left;
      overlayDragOffsetY = e.clientY - rect.top;
      overlayHeader.style.cursor = 'grabbing';
      overlay.style.transition = 'none';
      overlay.style.width = `${rect.width}px`;
      overlay.style.height = `${rect.height}px`;
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (isDraggingOverlay) {
      e.preventDefault();
      overlay.style.left = `${e.clientX - overlayDragOffsetX}px`;
      overlay.style.top = `${e.clientY - overlayDragOffsetY}px`;
      overlay.style.transform = 'none';
    }
  });

  document.addEventListener('mouseup', () => {
    if (isDraggingOverlay) {
      isDraggingOverlay = false;
      overlayHeader.style.cursor = 'grab';
      overlay.style.transition = '';
      overlay.style.width = '';
      overlay.style.height = '';
    }
  });
  overlayHeader.style.cursor = 'grab';

  function hideFullscreenUIDelayed() {
    clearTimeout(fullscreenUIHideTimeout);
    fullscreenUIHideTimeout = setTimeout(() => {
      const prevArrow = document.getElementById('prevProblemArrow');
      const nextArrow = document.getElementById('nextProblemArrow');
      if (prevArrow) prevArrow.style.opacity = '0';
      if (nextArrow) nextArrow.style.opacity = '0';
      if (fullscreenTimerElement) fullscreenTimerElement.style.opacity = '0';
      if (fullscreenTimerControls) fullscreenTimerControls.style.opacity = '0';
    }, UI_HIDE_DELAY);
  }

  function showFullscreenUIAndResetHideTimer() {
    clearTimeout(fullscreenUIHideTimeout);
    const prevArrow = document.getElementById('prevProblemArrow');
    const nextArrow = document.getElementById('nextProblemArrow');
    if (prevArrow) {
      prevArrow.style.display = 'block';
      prevArrow.style.opacity = '1';
    }
    if (nextArrow) {
      nextArrow.style.display = 'block';
      nextArrow.style.opacity = '1';
    }
    if (fullscreenTimerElement) {
      fullscreenTimerElement.style.display = 'block';
      fullscreenTimerElement.style.opacity = '1';
    }
    if (fullscreenTimerControls) {
      fullscreenTimerControls.style.display = 'flex';
      fullscreenTimerControls.style.opacity = '1';
    }
    updateFullscreenProblemCounter();
    hideFullscreenUIDelayed();
  }

  document.addEventListener('mousemove', (e) => {
    if (document.fullscreenElement && activeProblemElement) {
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      const mouseY = e.clientY;
      const mouseX = e.clientX;
      const activationZone = 100;

      if (mouseY < activationZone || mouseY > viewportHeight - activationZone ||
          (mouseX < activationZone + (fullscreenTimerElement.offsetWidth || 0) + (fullscreenTimerControls.offsetWidth || 0) + 20 && mouseY > viewportHeight - activationZone)) {
        showFullscreenUIAndResetHideTimer();
      } else {
        hideFullscreenUIDelayed();
      }
    }
  });

  document.addEventListener('click', (e) => {
    if (document.fullscreenElement && activeProblemElement) {
      showFullscreenUIAndResetHideTimer();
    }
  });

  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
  }

  function updateTimerDisplay() {
    fullscreenTimerElement.textContent = formatTime(timerSeconds);
  }

  function showFullscreenAlert(message, duration, callback = null) {
    fullscreenAlertOverlay.textContent = message;
    fullscreenAlertOverlay.style.display = 'flex';
    fullscreenAlertOverlay.classList.add('active');

    clearTimeout(fullscreenUIHideTimeout);
    showFullscreenUI();

    setTimeout(() => {
      fullscreenAlertOverlay.style.display = 'none';
      fullscreenAlertOverlay.classList.remove('active');
      if (callback) callback();
      hideFullscreenUIDelayed();
    }, duration);
  }

  function startTimerCountdown() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      if (fullscreenAlertOverlay.classList.contains('active')) {
        return;
      }

      timerSeconds--;
      updateTimerDisplay();

      if (timerSeconds === 600 && !twoMinuteAlertShown) {
        twoMinuteAlertShown = true;
        showFullscreenAlert("10 minut do konce", 10000);
      }

      if (timerSeconds <= 0) {
        clearInterval(timerInterval);
        timerRunning = false;
        playPauseTimerBtn.innerHTML = '&#9658;';
        showFullscreenAlert("KONEC, za 10s si budete moci zkontrolovat výsledky", 10000, () => {
          if (currentDisplayedProblems.length > 0) {
            const firstProblem = currentDisplayedProblems[0];
            const firstProblemElement = document.querySelector(`.problem[data-series="${firstProblem.series}"][data-num="${firstProblem.num}"]`);
            if (firstProblemElement) {
              prepareProblemForFullscreen(firstProblemElement);
            }
            showSolution(firstProblem.series, firstProblem.num);
            showFullscreenUI();
          }
        });
      }
      updateSolutionButtonState();
    }, 1000);
  }

  function toggleTimer() {
    if (timerRunning) {
      clearInterval(timerInterval);
      timerRunning = false;
      playPauseTimerBtn.innerHTML = '&#9658;';
    } else {
      timerRunning = true;
      playPauseTimerBtn.innerHTML = '&#10074;&#10074;';
      startTimerCountdown();
    }
    updateSolutionButtonState();
    showFullscreenUIAndResetHideTimer();
  }

  function resetTimer() {
    clearInterval(timerInterval);
    timerSeconds = 8100;
    timerRunning = false;
    twoMinuteAlertShown = false;
    finalAlertShown = false;
    updateTimerDisplay();
    playPauseTimerBtn.innerHTML = '&#9658;';
    updateSolutionButtonState();
    showFullscreenUIAndResetHideTimer();
  }

  playPauseTimerBtn.addEventListener('click', toggleTimer);
  resetTimerBtn.addEventListener('click', resetTimer);

  function updateSolutionButtonState() {
    const allSolutionButtons = document.querySelectorAll('.problem .show-solution');

    allSolutionButtons.forEach(button => {
      const problemElement = button.closest('.problem');
      const isFullscreenActiveProblem = problemElement && problemElement.classList.contains('fullscreen-active');

      if (timerRunning && isFullscreenActiveProblem) {
        button.classList.add('locked');
        button.setAttribute('title', 'Při běžícím odpočtu jsou výsledky blokovány');
        button.onclick = (event) => {
          event.stopPropagation();
        };
      } else {
        button.classList.remove('locked');
        button.removeAttribute('title');
        button.onclick = function(event) {
          event.stopPropagation();
          showSolution(this.dataset.series, parseInt(this.dataset.num));
        };
      }
    });
  }

  function updateProjectionButtonPosition() {
    const projectionButton = document.querySelector('.projection-button');
    const header = document.querySelector('header');
    if (projectionButton && header) {
      const headerBottom = header.getBoundingClientRect().bottom;
      const newTop = Math.max(20, headerBottom + 10);
      projectionButton.style.top = `${newTop}px`;
    }
  }

  function toggleDeveloperMode() {
    developerModeActive = developerModeCheckbox.checked;
    loadProblems();
    updateCategorySummary();
    updateClassificationStatus(); // NOVÉ
  }

  function handleCategoryCheckboxChange(series, num, category, isChecked) {
    const problemId = `${series}/${num}`;
    if (!problemCategoryData[problemId]) {
      problemCategoryData[problemId] = [];
    }

    if (isChecked) {
      if (!problemCategoryData[problemId].includes(category)) {
        problemCategoryData[problemId].push(category);
      }
    } else {
      problemCategoryData[problemId] = problemCategoryData[problemId].filter(cat => cat !== category);
      if (problemCategoryData[problemId].length === 0) {
        delete problemCategoryData[problemId];
      }
    }
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(problemCategoryData));
    updateCategorySummary();
    updateClassificationStatus(); // NOVÉ
  }

  function getSelectedSeriesIds() {
    const seriesSelect = document.getElementById("series");
    const selected = Array.from(seriesSelect.selectedOptions).map(o => o.value);
    return selected;
  }

  function buildCategorySummaryText() {
    let finalLines = [];
    const summaryBySeriesForCategory = {}; // { "Category Name": { "series": [nums], ... }, ... }

    // Populate summaryBySeriesForCategory
    for (const problemId in problemCategoryData) {
        const [series, numStr] = problemId.split('/');
        const num = parseInt(numStr, 10);
        const categoriesForProblem = problemCategoryData[problemId];

        categoriesForProblem.forEach(category => {
            if (!summaryBySeriesForCategory[category]) {
                summaryBySeriesForCategory[category] = {};
            }
            if (!summaryBySeriesForCategory[category][series]) {
                summaryBySeriesForCategory[category][series] = [];
            }
            summaryBySeriesForCategory[category][series].push(num);
        });
    }

    const selectedSeries = getSelectedSeriesIds();
    let allSeriesInProblemData = new Set();
    for (const problemId in problemCategoryData) {
        allSeriesInProblemData.add(problemId.split('/')[0]);
    }
    allSeriesInProblemData = Array.from(allSeriesInProblemData).sort();

    // Determine which series to display for each category
    let seriesToConsider = selectedSeries.length > 0 ? selectedSeries : allSeriesInProblemData;
    seriesToConsider.sort(); // Ensure consistent order of series

    // Iterate through PROBLEM_CATEGORIES to maintain order
    PROBLEM_CATEGORIES.forEach(categoryName => {
        seriesToConsider.forEach(series => {
            const problemsInThisSeriesForCategory = (summaryBySeriesForCategory[categoryName] && summaryBySeriesForCategory[categoryName][series]) || [];
            problemsInThisSeriesForCategory.sort((a, b) => a - b);
            const numsText = problemsInThisSeriesForCategory.join(',');
            finalLines.push(`"${series}": [${numsText}] //${categoryName}`);
        });
    });

    return finalLines.join('\n');
  }

  function updateCategorySummary() {
    if (!developerModeActive) {
      developerModeSummary.style.display = 'none';
      return;
    }

    developerModeSummary.style.display = 'block';

    const summaryText = buildCategorySummaryText();
    categorySummaryContent.textContent = summaryText;
  }

  // NOVÉ: Funkce pro aktualizaci stavu zatřídění
  function updateClassificationStatus() {
    if (!developerModeActive || currentDisplayedProblems.length === 0) {
        classificationStatusDiv.style.display = 'none';
        classificationStatusDiv.classList.remove('all-classified', 'not-all-classified');
        return;
    }

    let unclassifiedProblemIndices = [];
    currentDisplayedProblems.forEach(problem => {
        const problemId = `${problem.series}/${problem.num}`;
        if (!problemCategoryData[problemId] || problemCategoryData[problemId].length === 0) {
            unclassifiedProblemIndices.push(problem.displayIndex);
        }
    });

    classificationStatusDiv.style.display = 'block';
    classificationStatusDiv.classList.remove('all-classified', 'not-all-classified');

    if (unclassifiedProblemIndices.length === 0) {
        classificationStatusDiv.classList.add('all-classified');
        classificationStatusDiv.textContent = 'Všechny příklady ve výpisu byly zatřízeny';
    } else {
        classificationStatusDiv.classList.add('not-all-classified');
        classificationStatusDiv.textContent = `Nebyly zatřízeny příklady číslo: ${unclassifiedProblemIndices.join(', ')}`;
    }
  }


  function clearAllCategories() {
    if (confirm("Opravdu chcete smazat všechny zaškrtnuté kategorie u všech příkladů? Tato akce je nevratná.")) {
      problemCategoryData = {};
      localStorage.removeItem(LOCAL_STORAGE_KEY);
      loadProblems();
      updateCategorySummary();
      updateClassificationStatus(); // NOVÉ
    }
  }

  function downloadCategorySummaryAsTxt() {
    const summaryText = buildCategorySummaryText();

    const selectedSeries = getSelectedSeriesIds();
    let seriesForFilename;
    if (selectedSeries.length > 0) {
      seriesForFilename = selectedSeries;
    } else {
      const seriesFromData = new Set();
      for (const problemId in problemCategoryData) {
        const [series] = problemId.split('/');
        seriesFromData.add(series);
      }
      seriesForFilename = Array.from(seriesFromData);
    }

    if (seriesForFilename.length === 0) {
      alert("Není co stahovat – nejsou přiřazeny žádné kategorie.");
      return;
    }

    seriesForFilename.sort();
    const filename = seriesForFilename.join('_') + '.txt';

    const blob = new Blob([summaryText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();

    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  categorySummaryContent.addEventListener('mouseup', (e) => {
    const selectedText = window.getSelection().toString();
    if (selectedText.length > 0 && categorySummaryContent.contains(e.target)) {
      navigator.clipboard.writeText(selectedText).then(() => {
        copyFeedback.style.opacity = '1';
        setTimeout(() => {
          copyFeedback.style.opacity = '0';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
      });
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    generateMasterProblemList();
    updateProgressBar();

    const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
    if (storedData) {
      problemCategoryData = JSON.parse(storedData);
    }
    developerModeCheckbox.checked = localStorage.getItem('developerModeActive') === 'true';
    developerModeActive = developerModeCheckbox.checked;

    const nextProblemArrow = document.getElementById('nextProblemArrow');
    if (nextProblemArrow) {
      nextProblemArrow.addEventListener('click', () => {
        navigateToNextProblemInFullscreen();
        updateFullscreenProblemCounter();
      });
    }
    const prevProblemArrow = document.getElementById('prevProblemArrow');
    if (prevProblemArrow) {
      prevProblemArrow.addEventListener('click', () => {
        navigateToPrevProblemInFullscreen();
        updateFullscreenProblemCounter();
      });
    }

    if (clearCategorySummaryBtn) {
      clearCategorySummaryBtn.addEventListener('click', clearAllCategories);
    }
    if (downloadCategorySummaryBtn) {
      downloadCategorySummaryBtn.addEventListener('click', downloadCategorySummaryAsTxt);
    }

    loadProblems();
    updateProjectionButtonPosition();
    updateTimerDisplay();
    updateSolutionButtonState();
    updateCategorySummary();
    updateClassificationStatus(); // NOVÉ
  });

  window.addEventListener('scroll', () => {
    updateProgressBar();
    updateProjectionButtonPosition();
  });
  window.addEventListener('resize', () => {
    updateProgressBar();
    updateProjectionButtonPosition();
  });

  developerModeCheckbox.addEventListener('change', () => {
    localStorage.setItem('developerModeActive', developerModeCheckbox.checked);
  });
</script>
</body>
</html>
